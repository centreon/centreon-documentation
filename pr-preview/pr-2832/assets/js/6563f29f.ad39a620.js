"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[67519],{3905:(e,t,n)=>{n.d(t,{Zo:()=>A,kt:()=>u});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),i=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},A=function(e){var t=i(e.components);return a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,A=l(e,["components","mdxType","originalType","parentName"]),p=i(n),u=r,E=p["".concat(c,".").concat(u)]||p[u]||d[u]||o;return n?a.createElement(E,s(s({ref:t},A),{},{components:n})):a.createElement(E,s({ref:t},A))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=p;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:r,s[1]=l;for(var i=2;i<o;i++)s[i]=n[i];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7626:(e,t,n)=>{n.d(t,{Z:()=>l});var a=n(67294),r=n(86010);const o="tabItem_Ymn6";function s(){return s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},s.apply(this,arguments)}function l({children:e,hidden:t,className:n}){return a.createElement("div",s({role:"tabpanel",className:(0,r.Z)(o,n)},{hidden:t}),e)}},67709:(e,t,n)=>{n.d(t,{Z:()=>u});var a=n(67294),r=n(86010),o=n(90980),s=n(35715),l=n(8854),c=n(8241);const i="tabList__CuJ",A="tabItem_LNqP";function d(){return d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},d.apply(this,arguments)}function p(e){var t;const{lazy:n,block:o,defaultValue:p,values:u,groupId:E,className:m}=e,N=a.Children.map(e.children,(e=>{if((0,a.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),_=null!=u?u:N.map((({props:{value:e,label:t,attributes:n}})=>({value:e,label:t,attributes:n}))),h=(0,s.l)(_,((e,t)=>e.value===t.value));if(h.length>0)throw new Error(`Docusaurus error: Duplicate values "${h.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);var S;const T=null===p?p:null!==(S=null!=p?p:null===(t=N.find((e=>e.props.default)))||void 0===t?void 0:t.props.value)&&void 0!==S?S:N[0].props.value;if(null!==T&&!_.some((e=>e.value===T)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${T}" but none of its children has the corresponding value. Available values are: ${_.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:R,setTabGroupChoices:M}=(0,l.U)(),[L,k]=(0,a.useState)(T),C=[],{blockElementScrollPositionUntilNextRender:y}=(0,c.o5)();if(null!=E){const e=R[E];null!=e&&e!==L&&_.some((t=>t.value===e))&&k(e)}const b=e=>{const t=e.currentTarget,n=C.indexOf(t),a=_[n].value;a!==L&&(y(t),k(a),null!=E&&M(E,String(a)))},g=e=>{let t=null;switch(e.key){case"ArrowRight":{const a=C.indexOf(e.currentTarget)+1;var n;t=null!==(n=C[a])&&void 0!==n?n:C[0];break}case"ArrowLeft":{const n=C.indexOf(e.currentTarget)-1;var a;t=null!==(a=C[n])&&void 0!==a?a:C[C.length-1];break}}null==t||t.focus()};return a.createElement("div",{className:(0,r.Z)("tabs-container",i)},a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":o},m)},_.map((({value:e,label:t,attributes:n})=>a.createElement("li",d({role:"tab",tabIndex:L===e?0:-1,"aria-selected":L===e,key:e,ref:e=>C.push(e),onKeyDown:g,onFocus:b,onClick:b},n,{className:(0,r.Z)("tabs__item",A,null==n?void 0:n.className,{"tabs__item--active":L===e})}),null!=t?t:e)))),n?(0,a.cloneElement)(N.filter((e=>e.props.value===L))[0],{className:"margin-top--md"}):a.createElement("div",{className:"margin-top--md"},N.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==L})))))}function u(e){const t=(0,o.Z)();return a.createElement(p,d({key:String(t)},e))}},82231:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>E,frontMatter:()=>c,metadata:()=>A,toc:()=>p});n(67294);var a=n(3905),r=n(67709),o=n(7626);function s(){return s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},s.apply(this,arguments)}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}const c={id:"acceptance-guide",title:"Cluster acceptance guide"},i=void 0,A={unversionedId:"administration/centreon-ha/acceptance-guide",id:"version-23.10/administration/centreon-ha/acceptance-guide",title:"Cluster acceptance guide",description:"Please note that all commands presented in this document are respectively to be run as root unless otherwise stated.",source:"@site/versioned_docs/version-23.10/administration/centreon-ha/acceptance-guide.md",sourceDirName:"administration/centreon-ha",slug:"/administration/centreon-ha/acceptance-guide",permalink:"/centreon-documentation/pr-preview/pr-2832/docs/administration/centreon-ha/acceptance-guide",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/next/versioned_docs/version-23.10/administration/centreon-ha/acceptance-guide.md",tags:[],version:"23.10",lastUpdatedAt:1700565273,formattedLastUpdatedAt:"Nov 21, 2023",frontMatter:{id:"acceptance-guide",title:"Cluster acceptance guide"},sidebar:"version-23.10/docs",previous:{title:"Integrating new pollers in a manual Centreon-HA cluster",permalink:"/centreon-documentation/pr-preview/pr-2832/docs/installation/installation-of-centreon-ha-manual/integrating-pollers"},next:{title:"Monitoring Centreon-HA",permalink:"/centreon-documentation/pr-preview/pr-2832/docs/administration/centreon-ha/monitoring-guide"}},d={},p=[{value:"Requirements of the tests",id:"requirements-of-the-tests",level:2},{value:"Check the state of the cluster",id:"check-the-state-of-the-cluster",level:3},{value:"Check the constraints",id:"check-the-constraints",level:3},{value:"Check the status of the database synchronization",id:"check-the-status-of-the-database-synchronization",level:3},{value:"Centreon resource failover",id:"centreon-resource-failover",level:2},{value:"State of the cluster before the failover",id:"state-of-the-cluster-before-the-failover",level:3},{value:"Perform a failover",id:"perform-a-failover",level:3},{value:"Back to the nominal situation",id:"back-to-the-nominal-situation",level:3},{value:"Simulate the loss of the secondary node",id:"simulate-the-loss-of-the-secondary-node",level:2},{value:"Processing",id:"processing",level:3},{value:"Back to nominal situation",id:"back-to-nominal-situation",level:3},{value:"Simulate the loss of the primary node",id:"simulate-the-loss-of-the-primary-node",level:2},{value:"Processing",id:"processing-1",level:3},{value:"Back to nominal situation",id:"back-to-nominal-situation-1",level:3},{value:"Requirements of the tests",id:"requirements-of-the-tests-1",level:2},{value:"Check the state of the cluster",id:"check-the-state-of-the-cluster-1",level:3},{value:"Check the constraints",id:"check-the-constraints-1",level:3},{value:"Check the status of the database synchronization",id:"check-the-status-of-the-database-synchronization-1",level:3},{value:"Centreon resource failover",id:"centreon-resource-failover-1",level:2},{value:"State of the cluster before the failover",id:"state-of-the-cluster-before-the-failover-1",level:3},{value:"Perform a failover",id:"perform-a-failover-1",level:3},{value:"Back to the nominal situation",id:"back-to-the-nominal-situation-1",level:3},{value:"Simulate the loss of the secondary node",id:"simulate-the-loss-of-the-secondary-node-1",level:2},{value:"Processing",id:"processing-2",level:3},{value:"Back to nominal situation",id:"back-to-nominal-situation-2",level:3},{value:"Simulate the loss of the primary node",id:"simulate-the-loss-of-the-primary-node-1",level:2},{value:"Processing",id:"processing-3",level:3},{value:"Back to nominal situation",id:"back-to-nominal-situation-3",level:3}],u={toc:p};function E(e){var{components:t}=e,n=l(e,["components"]);return(0,a.kt)("wrapper",s({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Please note that all commands presented in this document are respectively to be run as ",(0,a.kt)("inlineCode",{parentName:"p"},"root")," unless otherwise stated.")),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"HA 2 Nodes",label:"HA 2 Nodes",mdxType:"TabItem"},(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This document will refer to parameters that vary from one installation to another (e.g., names and IP addresses of nodes) via. ",(0,a.kt)("a",s({parentName:"p"},{href:"/centreon-documentation/pr-preview/pr-2832/docs/installation/installation-of-centreon-ha/installation-2-nodes#defining-hosts-names-and-addresses"}),"macros defined here"))),(0,a.kt)("h2",s({},{id:"requirements-of-the-tests"}),"Requirements of the tests"),(0,a.kt)("p",null,"To verify the proper functioning of your cluster, you will get all the commands to perform a failover test and simulate network failures."),(0,a.kt)("p",null,"It is necessary to check the state of the cluster before performing the acceptance tests. "),(0,a.kt)("h3",s({},{id:"check-the-state-of-the-cluster"}),"Check the state of the cluster"),(0,a.kt)("p",null,"To check the general state of the cluster, run the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs status\n")),(0,a.kt)("p",null,"The command should return the following information:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\n")))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Check the resources for ",(0,a.kt)("inlineCode",{parentName:"p"},"Failed")," errors and correct them with the help of the ",(0,a.kt)("a",s({parentName:"p"},{href:"/centreon-documentation/pr-preview/pr-2832/docs/administration/centreon-ha/troubleshooting-guide"}),"troubleshooting guide"),".")),(0,a.kt)("h3",s({},{id:"check-the-constraints"}),"Check the constraints"),(0,a.kt)("p",null,"To check that there are no ",(0,a.kt)("inlineCode",{parentName:"p"},"Location Constraints"),", execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs constraint\n")),(0,a.kt)("p",null,"The command should return this:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Location Constraints:\nOrdering Constraints:\nColocation Constraints:\n  centreon with ms_mysql-clone (score:INFINITY) (rsc-role:Started) (with-rsc-role:Master)\n  ms_mysql-clone with centreon (score:INFINITY) (rsc-role:Master) (with-rsc-role:Started)\nTicket Constraints:\n")))),(0,a.kt)("h3",s({},{id:"check-the-status-of-the-database-synchronization"}),"Check the status of the database synchronization"),(0,a.kt)("p",null,"To verify that the database synchronization is working, performs the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The command should return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Connection MASTER Status '@CENTRAL_MASTER_NAME@' [OK]\nConnection SLAVE Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If the synchronization shows ",(0,a.kt)("inlineCode",{parentName:"p"},"KO")," you have to fix it with the help of the ",(0,a.kt)("a",s({parentName:"p"},{href:"/centreon-documentation/pr-preview/pr-2832/docs/administration/centreon-ha/operating-guide"}),"operating-guide"),".")),(0,a.kt)("h2",s({},{id:"centreon-resource-failover"}),"Centreon resource failover"),(0,a.kt)("h3",s({},{id:"state-of-the-cluster-before-the-failover"}),"State of the cluster before the failover"),(0,a.kt)("p",null,"Before running a failover test, check the status of the cluster with the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs status\n")),(0,a.kt)("p",null,"The expected output is:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\n")))),(0,a.kt)("h3",s({},{id:"perform-a-failover"}),"Perform a failover"),(0,a.kt)("p",null,"To move the resources, run the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs resource move centreon\n")),(0,a.kt)("p",null,"You can also use the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command to watch the failover as it happens. It will be necessary to use Ctrl+c to exit the command."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Warning: The ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs resource move centreon")," command sets an ",(0,a.kt)("inlineCode",{parentName:"p"},"-INFINITY")," constraint on the node hosting the resource, no longer allowed to be running on that node.")),(0,a.kt)("p",null,"As a result, the resources move to another node. Following this manipulation, it is, thus, necessary to execute the command ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs resource clear centreon")," to ensure the resources can be moved back to this node in the future."),(0,a.kt)("p",null,"To verify that the resources have moved to the second node, performs the command: "),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs status\n")),(0,a.kt)("p",null,"The expected output is:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started Started @CENTRAL_SLAVE_NAME@\n    * http      (systemd:httpd):         Started Started @CENTRAL_SLAVE_NAME@\n    * gorgone   (systemd:gorgoned):      Started Started @CENTRAL_SLAVE_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_SLAVE_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_SLAVE_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_SLAVE_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_SLAVE_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_SLAVE_NAME@\n")))),(0,a.kt)("p",null,"You may notice that like the ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon")," resources, the secondary node has also been promoted to ",(0,a.kt)("inlineCode",{parentName:"p"},"master")," for the ",(0,a.kt)("inlineCode",{parentName:"p"},"ms_mysql")," resource. This behavior is intended and due to ",(0,a.kt)("inlineCode",{parentName:"p"},"Colocation Constraints")," between the ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon")," resources and ",(0,a.kt)("inlineCode",{parentName:"p"},"msq_mysql"),"."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"Colocation Constraints")," are unfound on a 4-node cluster!")),(0,a.kt)("p",null,"Once the failover is completed, execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs resource clear centreon\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This will remove the constraints established during the failover.")),(0,a.kt)("p",null,"Also, check that MySQL replication is still operational using the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Connection MASTER Status '@CENTRAL_MASTER_NAME@' [OK]\nConnection SLAVE Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If the synchronization has ",(0,a.kt)("inlineCode",{parentName:"p"},"KO")," you have to fix it with the help of the ",(0,a.kt)("a",s({parentName:"p"},{href:"/centreon-documentation/pr-preview/pr-2832/docs/administration/centreon-ha/operating-guide"}),"operating-guide"),".")),(0,a.kt)("h3",s({},{id:"back-to-the-nominal-situation"}),"Back to the nominal situation"),(0,a.kt)("p",null,"To return to the nominal situation, you must launch the resource failover."),(0,a.kt)("p",null,"Execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs status\n")),(0,a.kt)("p",null,"The output should be:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):         Started @CENTRAL_SLAVE_NAME@\n    * http      (systemd:httpd):          Started @CENTRAL_SLAVE_NAME@\n    * gorgone   (systemd:gorgoned):       Started @CENTRAL_SLAVE_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):          Started @CENTRAL_SLAVE_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_SLAVE_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_SLAVE_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_SLAVE_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_SLAVE_NAME@\n")))),(0,a.kt)("p",null,"Then, run the constraint cleanup command in case you have ",(0,a.kt)("inlineCode",{parentName:"p"},"Location Constraints"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs resource clear centreon\n")),(0,a.kt)("p",null,"Then, execute the failover command: "),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs resource move centreon\n")),(0,a.kt)("p",null,"As before, you can follow the failover with the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command."),(0,a.kt)("p",null,"Finally, remove the constraints with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs resource clear centreon\n")),(0,a.kt)("p",null,"Also, check that MySQL replication is still operational using the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Connection MASTER Status '@CENTRAL_MASTER_NAME@' [OK]\nConnection SLAVE Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If the synchronization is ",(0,a.kt)("inlineCode",{parentName:"p"},"KO")," you have to fix it with the help of the ",(0,a.kt)("a",s({parentName:"p"},{href:"/centreon-documentation/pr-preview/pr-2832/docs/administration/centreon-ha/operating-guide"}),"operating-guide"),".")),(0,a.kt)("h2",s({},{id:"simulate-the-loss-of-the-secondary-node"}),"Simulate the loss of the secondary node"),(0,a.kt)("p",null,"To simulate a network failure that would isolate the secondary node, you can use ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," to drop traffic from and to the secondary node.\nThe secondary node will be completely excluded from the cluster. The primary node keeps the majority with the QDevice."),(0,a.kt)("h3",s({},{id:"processing"}),"Processing"),(0,a.kt)("p",null,"To perform this test, launch the ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," commands on the primary node:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -A INPUT -s @IP_SECONDARY_NODE@ -j DROP\niptables -A OUTPUT -d @IP_SECONDARY_NODE@ -j DROP\n")),(0,a.kt)("p",null,"Executing the command ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs status")," on secondary node results in stopped resources being seen on the secondary node and the primary node being seen as ",(0,a.kt)("inlineCode",{parentName:"p"},"offline"),":"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster name: centreon_cluster\nCluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_SLAVE_NAME@ (version 2.1.2-4.el8_6.3-ada5c3b36e2) - partition WITHOUT quorum\n  * Last updated: Tue Nov  8 14:33:00 2022\n  * Last change:  Tue Nov  8 14:25:58 2022 by root via crm_resource on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_SLAVE_NAME@ ]\n  * OFFLINE: [ @CENTRAL_MASTER_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Stopped\n    * http      (systemd:httpd):         Stopped\n    * gorgone   (systemd:gorgoned):      Stopped\n    * centreon_central_sync     (systemd:centreon-central-sync):         Stopped\n    * cbd_central_broker        (systemd:cbd-sql):       Stopped\n    * centengine        (systemd:centengine):    Stopped\n    * centreontrapd     (systemd:centreontrapd):         Stopped\n    * snmptrapd (systemd:snmptrapd):     Stopped\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("p",null,"The resources and the cluster are still working by performing a ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs status")," on the primary node.\nThe secondary node is seen ",(0,a.kt)("inlineCode",{parentName:"p"},"offline")," on the primary."),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster name: centreon_cluster\nCluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.1.2-4.el8_6.3-ada5c3b36e2) - partition with quorum\n  * Last updated: Tue Nov  8 15:19:52 2022\n  * Last change:  Tue Nov  8 14:25:58 2022 by root via crm_resource on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    @@ -545,40 +609,51 @@ Full List of Resources:\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("h3",s({},{id:"back-to-nominal-situation"}),"Back to nominal situation"),(0,a.kt)("p",null,"To check the various iptables rules configured on the primary node, run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -L\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Chain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  @CENTRAL_SLAVE_NAME@                 anywhere\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  anywhere             @CENTRAL_SLAVE_NAME@\n")),(0,a.kt)("p",null,"If you do not have any other iptables rules configured, you can execute the following command to remove the rules related to the test:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -F\n")),(0,a.kt)("p",null,"Otherwise, it will be necessary to list the rule numbers with the specific command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -L --line-numbers\n")),(0,a.kt)("p",null,"And delete it with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -D INPUT @RULE_NUMBER@\niptables -D OUTPUT @RULE_NUMBER@\n")),(0,a.kt)("p",null,"The secondary node is again seen ",(0,a.kt)("inlineCode",{parentName:"p"},"online")," by the cluster:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\n")))),(0,a.kt)("p",null,"Also check MySQL replication is still operational using the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The order must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Connection MASTER Status '@CENTRAL_MASTER_NAME@' [OK]\nConnection SLAVE Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("h2",s({},{id:"simulate-the-loss-of-the-primary-node"}),"Simulate the loss of the primary node"),(0,a.kt)("h3",s({},{id:"processing-1"}),"Processing"),(0,a.kt)("p",null,"To perform this test, run the commands on the primary server:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -A INPUT -s @IP_SECONDARY_NODE@ -j DROP \niptables -A OUTPUT -d @IP_SECONDARY_NODE@ -j DROP \niptables -A INPUT -s @QDEVICE_IP@ -j DROP \niptables -A OUTPUT -d @QDEVICE_IP@  -j DROP\n")),(0,a.kt)("p",null,"Resources on the primary node should stop and should start on the secondary node. You can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command on the secondary node to watch the startup of resources:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_SLAVE_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 15 16:35:47 2021\n  * Last change:  Wed Sep 15 10:41:50 2021 by root via crm_attribute on @CENTRAL_SLAVE_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_SLAVE_NAME@ ]\n  * OFFLINE [ @CENTRAL_MASTER_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_SLAVE_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_SLAVE_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_SLAVE_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_SLAVE_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_SLAVE_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_SLAVE_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_SLAVE_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_SLAVE_NAME@\n")))),(0,a.kt)("p",null,"This test checks that resources will be switched to the secondary node if the primary node is unavailable and allows for continuity of service."),(0,a.kt)("h3",s({},{id:"back-to-nominal-situation-1"}),"Back to nominal situation"),(0,a.kt)("p",null,"To check the various iptables rules configured on the primary node, run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -L\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Chain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  @CENTRAL_SLAVE_NAME@                 anywhere\nDROP       all  --  @QDEVICE_NAME@      anywhere\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  anywhere             @CENTRAL_SLAVE_NAME@\nDROP       all  --  anywhere             @QDEVICE_NAME@\n")),(0,a.kt)("p",null,"If you do not have any other iptables rules configured, you can execute the following command to remove the rules related to the test:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -F\n")),(0,a.kt)("p",null,"Otherwise, it will be necessary to list the rule numbers with the specific command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -L --line-numbers\n")),(0,a.kt)("p",null,"And delete it with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -D INPUT @RULE_NUMBER@;\niptables -D OUTPUT @RULE_NUMBER@\n")),(0,a.kt)("p",null,"By running the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon")," command on the second node, you will see the primary node move up in the cluster but staying as SLAVE node."),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.1.2-4.el8_6.3-ada5c3b36e2) - partition with quorum\n  * Last updated: Tue Nov  8 17:27:28 2022\n  * Last change:  Tue Nov  8 17:23:19 2022 by root via crm_attribute on @CENTRAL_SLAVE_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * ms_mysql  (ocf::heartbeat:mariadb-centreon):       Stopped @CENTRAL_MASTER_NAME@ (Monitoring)\n    * Masters: [ @CENTRAL_SLAVE_NAME@ ]\n    * Stopped: [ @CENTRAL_MASTER_NAME@ ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_SLAVE_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_SLAVE_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_SLAVE_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_SLAVE_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_SLAVE_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_SLAVE_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_SLAVE_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_SLAVE_NAME@\nMigration Summary:\n  * Node: @CENTRAL_MASTER_NAME@:\n    * ms_mysql: migration-threshold=1000000 fail-count=1000000 last-failure='Tue Nov  8 17:27:25 2\n022'\nFailed Resource Actions:\n  * ms_mysql_start_0 on @CENTRAL_MASTER_NAME@ 'error' (1): call=440, status='complete', exitreason='M\nariaDB slave io has failed (1236): Got fatal error 1236 from master when reading data from binary\nlog: 'Error: connecting slave', last-rc-change='Tue Nov  8 17:27:21 2022', queued=0ms, exec=4060ms\n")),(0,a.kt)("p",null,"If you want to switch to the primary node, you must do a failover.\nSo, ",(0,a.kt)("strong",{parentName:"p"},"before you do this, you must check the cluster and database replication status"),"."),(0,a.kt)("p",null,"First, check the constraints:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-shell"}),"pcs constraint\n")),(0,a.kt)("p",null,"The command should return this:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",label:"RHEL 8 / Oracle Linux 8 / Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Location Constraints:\nOrdering Constraints:\nColocation Constraints:\n  centreon with ms_mysql-clone (score:INFINITY) (rsc-role:Started) (with-rsc-role:Master)\n  ms_mysql-clone with centreon (score:INFINITY) (rsc-role:Master) (with-rsc-role:Started)\nTicket Constraints:\n")))),(0,a.kt)("p",null,"then check the database replication"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"At this time, the cluster is in degraded mode with two slave nodes.\nIn this particular case, it returns the following information because the ms_mysql resource is stopped on @CENTRAL_MASTER_NAME@:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Connection SLAVE Status '@CENTRAL_MASTER_NAME@' [KO]\nError reports:\n    ERROR 2002 (HY000): Can't connect to MySQL server on '@CENTRAL_MASTER_NAME@' (115)\nImpossible de se connecter au serveur '@CENTRAL_MASTER_NAME@'.\nConnection SLAVE Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [KO]\nError reports:\n    Skip check on '@CENTRAL_MASTER_NAME@'.\n    No slave (maybe because we cannot check a server).\nPosition Status [SKIP]\nError reports:\n    Skip because we can't identify a unique slave.\n")),(0,a.kt)("p",null,'You must do a database synchronization from @CENTRAL_SLAVE_NAME@ to @CENTRAL_MASTER_NAME@ by launching the "sync-bigdb" script on the ',(0,a.kt)("strong",{parentName:"p"},"Slave node"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-shell"}),"/usr/share/centreon-ha/bin/mysql-sync-bigdb.sh\n")),(0,a.kt)("p",null,"As for the previous execution of this script, verify if LVM Snapshot is correctly deleted and the MySQL Slave restarted:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),'Umount and Delete LVM snapshot\n  Logical volume "dbbackupdatadir" successfully removed.\nStart MySQL Slave\nOK\nStart Replication\nId      User    Host    db      Command Time    State   Info    Progress\n5       centreon-repl   @CENTRAL_SLAVE_NAME@:51850        NULL    Query   0       starting        show processlist  0.000\n6       centreon        localhost       centreon_storage        Sleep   0               NULL    0.000\n7       system user             NULL    Connect 0       Connecting to master    NULL    0.000\n8       system user             NULL    Slave_SQL       0       Slave has read all relay log; waiting for more updates    NULL    0.000\n')),(0,a.kt)("p",null,"Now, database replication should be OK, verify it."),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-shell"}),"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The result should be:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Connection MASTER Status '@CENTRAL_SLAVE_NAME@' [OK]\nConnection SLAVE Status '@CENTRAL_MASTER_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("p",null,"Now, you can perform a failover to return to the initial situation."),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-shell"}),"pcs resource clear centreon\n")),(0,a.kt)("p",null,"Do a cleanup to clear errors and restart the ms_mysql resource on @CENTRAL_MASTER_NAME@."),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-shell"}),"pcs resource cleanup\n")),(0,a.kt)("p",null,"The situation is stabilized, you can perform a failover by moving the ",(0,a.kt)("strong",{parentName:"p"},"centreon")," resource."),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-shell"}),"pcs resource move centreon\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("strong",{parentName:"p"},"centreon")," resource is now relocated and the cluster is OK, verify with ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," on any node."),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.1.2-4.el8_6.3-ada5c3b36e2) - partition with quorum\n  * Last updated: Wed Nov  9 10:23:54 2022\n  * Last change:  Wed Nov  9 10:23:26 2022 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 2 nodes configured\n  * 14 resource instances configured\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ centreon-rhel8-sec ]\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @CENTRAL_MASTER_NAME@ ]\n    * Slaves: [ centreon-rhel8-sec ]\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ centreon-rhel8-sec ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ centreon-rhel8-sec ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\nMigration Summary:\n"))),(0,a.kt)(o.Z,{value:"HA 4 Nodes",label:"HA 4 Nodes",mdxType:"TabItem"},(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This document will refer to parameters that vary from one installation to another (e.g., names and IP addresses of nodes) via. ",(0,a.kt)("a",s({parentName:"p"},{href:"/centreon-documentation/pr-preview/pr-2832/docs/installation/installation-of-centreon-ha/installation-4-nodes#defining-hosts-names-and-addresses"}),"macros defined here"))),(0,a.kt)("h2",s({},{id:"requirements-of-the-tests-1"}),"Requirements of the tests"),(0,a.kt)("p",null,"To verify the proper functioning of your cluster, you will get all the commands to perform a failover test and simulate network failures."),(0,a.kt)("p",null,"It is necessary to check the state of the cluster before performing the acceptance tests. "),(0,a.kt)("h3",s({},{id:"check-the-state-of-the-cluster-1"}),"Check the state of the cluster"),(0,a.kt)("p",null,"To check the general state of the cluster, run the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs status\n")),(0,a.kt)("p",null,"The command should return the following information:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Check the resources for ",(0,a.kt)("inlineCode",{parentName:"p"},"Failed")," errors and correct them with the help of the ",(0,a.kt)("a",s({parentName:"p"},{href:"/centreon-documentation/pr-preview/pr-2832/docs/administration/centreon-ha/troubleshooting-guide"}),"troubleshooting guide"),".")),(0,a.kt)("h3",s({},{id:"check-the-constraints-1"}),"Check the constraints"),(0,a.kt)("p",null,"To check that there are no ",(0,a.kt)("inlineCode",{parentName:"p"},"Location Constraints"),", execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs constraint\n")),(0,a.kt)("p",null,"The command should return this:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Location Constraints:\n  Resource: cbd_rrd-clone\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: centreon\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: ms_mysql-clone\n    Disabled on: @CENTRAL_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: php-clone\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\nOrdering Constraints:\nColocation Constraints:\n  vip_mysql with ms_mysql-clone (score:INFINITY) (rsc-role:Started) (with-rsc-role:Master)\n  ms_mysql-clone with vip_mysql (score:INFINITY) (rsc-role:Master) (with-rsc-role:Started)\nTicket Constraints:\n")))),(0,a.kt)("h3",s({},{id:"check-the-status-of-the-database-synchronization-1"}),"Check the status of the database synchronization"),(0,a.kt)("p",null,"To verify that the database synchronization is working, performs the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The command should return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"Connection MASTER Status '@DATABASE_MASTER_NAME@' [OK]\nConnection SLAVE Status '@DATABASE_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If the synchronization shows ",(0,a.kt)("inlineCode",{parentName:"p"},"KO")," you have to fix it with the help of the ",(0,a.kt)("a",s({parentName:"p"},{href:"/centreon-documentation/pr-preview/pr-2832/docs/administration/centreon-ha/operating-guide"}),"operating-guide"),".")),(0,a.kt)("h2",s({},{id:"centreon-resource-failover-1"}),"Centreon resource failover"),(0,a.kt)("h3",s({},{id:"state-of-the-cluster-before-the-failover-1"}),"State of the cluster before the failover"),(0,a.kt)("p",null,"Before running a failover test, check the status of the cluster with the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs status\n")),(0,a.kt)("p",null,"The expected output is:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("h3",s({},{id:"perform-a-failover-1"}),"Perform a failover"),(0,a.kt)("p",null,"To move the resources, run the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs resource move centreon\n")),(0,a.kt)("p",null,"You can also use the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command to watch the failover as it happens. It will be necessary to use Ctrl+c to exit the command."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Warning: The ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs resource move centreon")," command sets an ",(0,a.kt)("inlineCode",{parentName:"p"},"-INFINITY")," constraint on the node hosting the resource, no longer allowed to be running on that node.")),(0,a.kt)("p",null,"As a result, the resources move to another node. Following this manipulation, it is, thus, necessary to execute the command ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs resource clear centreon")," to ensure the resources can be moved back to this node in the future."),(0,a.kt)("p",null,"To verify that the resources have moved to the second node, performs the command: "),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs status\n")),(0,a.kt)("p",null,"The expected output is:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("p",null,"Once the failover is completed, execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs resource clear centreon\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This will remove the constraints established during the failover.")),(0,a.kt)("p",null,"Also, check that MySQL replication is still operational using the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Connection MASTER Status '@CENTRAL_MASTER_NAME@' [OK]\nConnection SLAVE Status '@CENTRAL_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If the synchronization has ",(0,a.kt)("inlineCode",{parentName:"p"},"KO")," you have to fix it with the help of the ",(0,a.kt)("a",s({parentName:"p"},{href:"/centreon-documentation/pr-preview/pr-2832/docs/administration/centreon-ha/operating-guide"}),"operating-guide"),".")),(0,a.kt)("h3",s({},{id:"back-to-the-nominal-situation-1"}),"Back to the nominal situation"),(0,a.kt)("p",null,"To return to the nominal situation, you must launch the resource failover."),(0,a.kt)("p",null,"Execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs status\n")),(0,a.kt)("p",null,"The output should be:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("p",null,"Then, run the constraint cleanup command in case you have ",(0,a.kt)("inlineCode",{parentName:"p"},"Location Constraints"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs resource clear centreon\n")),(0,a.kt)("p",null,"Then, execute the failover command: "),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs resource move centreon\n")),(0,a.kt)("p",null,"As before, you can follow the failover with the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command."),(0,a.kt)("p",null,"Finally, remove the constraints with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"pcs resource clear centreon\n")),(0,a.kt)("h2",s({},{id:"simulate-the-loss-of-the-secondary-node-1"}),"Simulate the loss of the secondary node"),(0,a.kt)("p",null,"To simulate a network failure that would isolate the @CENTRAL_SLAVE_NAME@, you can use ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," to drop traffic from and to the @CENTRAL_SLAVE_NAME@.\nThe @CENTRAL_SLAVE_NAME@ will be completely excluded from the cluster. The @CENTRAL_MASTER_NAME@ keeps the majority with the QDevice."),(0,a.kt)("h3",s({},{id:"processing-2"}),"Processing"),(0,a.kt)("p",null,"To perform this test, launch the ",(0,a.kt)("inlineCode",{parentName:"p"},"iptables")," commands on the @CENTRAL_SLAVE_NAME@. Be carreful avoid @CENTRAL_SLAVE_IPADDR@ otherwise you loose SSH connection on this node."),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -A INPUT -s @CENTRAL_MASTER_IPADDR@ -j DROP\niptables -A OUTPUT -d @CENTRAL_MASTER_IPADDR@ -j DROP\niptables -A INPUT -s @DATABASE_MASTER_IPADDR@ -j DROP\niptables -A OUTPUT -d @DATABASE_MASTER_IPADDR@ -j DROP\niptables -A INPUT -s @DATABASE_SLAVE_IPADDR@ -j DROP\niptables -A OUTPUT -d @DATABASE_SLAVE_IPADDR@ -j DROP\niptables -A INPUT -s @QDEVICE_IPADDR@ -j DROP\niptables -A OUTPUT -d @QDEVICE_IPADDR@ -j DROP\n")),(0,a.kt)("p",null,"Executing the command results in no active resources being seen on the secondary node and the primary node being seen as ",(0,a.kt)("inlineCode",{parentName:"p"},"offline"),".\nThe resources and the cluster are still working by performing a ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs status")," on the primary node."),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Thu May  5 10:34:05 2022\nLast change: Thu May  5 09:09:50 2022 by root via crm_resource on @CENTRAL_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\nOFFLINE: [ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("h3",s({},{id:"back-to-nominal-situation-2"}),"Back to nominal situation"),(0,a.kt)("p",null,"To check the various iptables rules configured on the primary node, run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -L\n")),(0,a.kt)("p",null,"The command must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Chain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  @CENTRAL_SLAVE_NAME@                 anywhere\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  anywhere             @CENTRAL_SLAVE_NAME@\n")),(0,a.kt)("p",null,"If you do not have any other iptables rules configured, you can execute the following command to remove the rules related to the test:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -F\n")),(0,a.kt)("p",null,"Otherwise, it will be necessary to list the rule numbers with the specific command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -L --line-numbers\n")),(0,a.kt)("p",null,"And delete it with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -D INPUT @RULE_NUMBER@\niptables -D OUTPUT @RULE_NUMBER@\n")),(0,a.kt)("p",null,"The secondary node is again seen ",(0,a.kt)("inlineCode",{parentName:"p"},"online")," by the cluster:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Cluster name: centreon_cluster\nStack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Wed May  4 15:36:20 2022\nLast change: Mon May  2 18:20:27 2022 by root via crm_attribute on @DATABASE_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n vip_mysql      (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_MASTER_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_MASTER_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_MASTER_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_MASTER_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_MASTER_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_MASTER_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_MASTER_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_MASTER_NAME@\n\nDaemon Status:\n  corosync: active/enabled\n  pacemaker: active/enabled\n  pcsd: active/enabled\n")))),(0,a.kt)("p",null,"Also check MySQL replication is still operational using the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The order must return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Connection MASTER Status '@DATABASE_MASTER_NAME@' [OK]\nConnection SLAVE Status '@DATABASE_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("h2",s({},{id:"simulate-the-loss-of-the-primary-node-1"}),"Simulate the loss of the primary node"),(0,a.kt)("h3",s({},{id:"processing-3"}),"Processing"),(0,a.kt)("p",null,"To perform this test, run the commands on the @CENTRAL_MASTER_NAME@:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -A INPUT -s @CENTRAL_SLAVE_IPADDR@ -j DROP\niptables -A OUTPUT -d @CENTRAL_SLAVE_IPADDR@ -j DROP\niptables -A INPUT -s @DATABASE_MASTER_IPADDR@ -j DROP\niptables -A OUTPUT -d @DATABASE_MASTER_IPADDR@ -j DROP\niptables -A INPUT -s @DATABASE_SLAVE_IPADDR@ -j DROP\niptables -A OUTPUT -d @DATABASE_SLAVE_IPADDR@ -j DROP\niptables -A INPUT -s @QDEVICE_IPADDR@ -j DROP\niptables -A OUTPUT -d @QDEVICE_IPADDR@ -j DROP\n")),(0,a.kt)("p",null,"Resources on the @CENTRAL_MASTER_NAME@ should stop and should start on the @CENTRAL_SLAVE_NAME@. You can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr")," command on the @CENTRAL_SLAVE_NAME@ to watch the startup of resources:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Stack: corosync\nCurrent DC: @CENTRAL_MASTER_NAME@ (version 1.1.23-1.el8_9.1-9acf116022) - partition with quorum\nLast updated: Thu May  5 11:06:38 2022\nLast change: Thu May  5 09:09:50 2022 by root via crm_resource on @CENTRAL_MASTER_NAME@\n\n4 nodes configured\n21 resource instances configured\n\nOnline: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_SLAVE_NAME@ ]\nOFFLINE: [ @CENTRAL_MASTER_NAME@ ]\n\nFull list of resources:\n\n Master/Slave Set: ms_mysql-clone [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nvip_mysql       (ocf::heartbeat:IPaddr2):       Started @DATABASE_MASTER_NAME@\n Clone Set: php-clone [php]\n     Started: [ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Clone Set: cbd_rrd-clone [cbd_rrd]\n     Started: [ @CENTRAL_SLAVE_NAME@ ]\n     Stopped: [ @DATABASE_MASTER_NAME@ @CENTRAL_MASTER_NAME@ @DATABASE_SLAVE_NAME@ ]\n Resource Group: centreon\n     vip        (ocf::heartbeat:IPaddr2):       Started @CENTRAL_SLAVE_NAME@\n     http       (systemd:httpd24-httpd):        Started @CENTRAL_SLAVE_NAME@\n     gorgone    (systemd:gorgoned):     Started @CENTRAL_SLAVE_NAME@\n     centreon_central_sync      (systemd:centreon-central-sync):        Started @CENTRAL_SLAVE_NAME@\n     cbd_central_broker (systemd:cbd-sql):      Started @CENTRAL_SLAVE_NAME@\n     centengine (systemd:centengine):   Started @CENTRAL_SLAVE_NAME@\n     centreontrapd      (systemd:centreontrapd):        Started @CENTRAL_SLAVE_NAME@\n     snmptrapd  (systemd:snmptrapd):    Started @CENTRAL_SLAVE_NAME@\n\nMigration Summary:\n* Node @DATABASE_MASTER_NAME@:\n* Node @CENTRAL_SLAVE_NAME@:\n* Node @DATABASE_SLAVE_NAME@:\n")))),(0,a.kt)("p",null,"This test checks that resources will be switched to the secondary node if the primary node is unavailable and allows for continuity of service."),(0,a.kt)("h3",s({},{id:"back-to-nominal-situation-3"}),"Back to nominal situation"),(0,a.kt)("p",null,"To check the various iptables rules configured on the primary node, run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -L\n")),(0,a.kt)("p",null,"The command should return the following information:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-text"}),"Chain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  @CENTRAL_SLAVE_NAME@  anywhere\nDROP       all  --  @DATABASE_MASTER_NAME@  anywhere\nDROP       all  --  @DATABASE_SLAVE_NAME@  anywhere\nDROP       all  --  @QDEVICE_NAME@  anywhere\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  anywhere             @CENTRAL_SLAVE_NAME@\nDROP       all  --  anywhere             @DATABASE_MASTER_NAME@\nDROP       all  --  anywhere             @DATABASE_SLAVE_NAME@\nDROP       all  --  anywhere             @QDEVICE_NAME@\n")),(0,a.kt)("p",null,"If you do not have any other iptables rules configured, you can execute the following command to remove the rules related to the test:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -F\n")),(0,a.kt)("p",null,"Otherwise, it will be necessary to list the rule numbers with the specific command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -L --line-numbers\n")),(0,a.kt)("p",null,"And delete it with the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",s({parentName:"pre"},{className:"language-bash"}),"iptables -D INPUT @RULE_NUMBER@;\niptables -D OUTPUT @RULE_NUMBER@\n")),(0,a.kt)("p",null,"By running the ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon")," command on the second node, you will see the primary node move up in the cluster.\nIf you want to switch to the primary node, run the ",(0,a.kt)("a",s({parentName:"p"},{href:"/centreon-documentation/pr-preview/pr-2832/docs/administration/centreon-ha/acceptance-guide#return-to-nominal-situation"}),"failover commands"),"."))))}E.isMDXComponent=!0}}]);