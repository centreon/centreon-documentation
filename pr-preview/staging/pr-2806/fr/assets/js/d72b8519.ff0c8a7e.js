"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[95618],{99234:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>l,default:()=>g,frontMatter:()=>o,metadata:()=>p,toc:()=>d});n(67294);var a=n(3905);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}const o={id:"database-partitioning",title:"Partitionnement des bases de donn\xe9es"},l=void 0,p={unversionedId:"administration/database-partitioning",id:"version-23.10/administration/database-partitioning",title:"Partitionnement des bases de donn\xe9es",description:"Pr\xe9sentation",source:"@site/i18n/fr/docusaurus-plugin-content-docs/version-23.10/administration/database-partitioning.md",sourceDirName:"administration",slug:"/administration/database-partitioning",permalink:"/centreon-documentation/pr-preview/staging/pr-2806/fr/docs/administration/database-partitioning",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/i18n/fr/docusaurus-plugin-content-docs/version-23.10/administration/database-partitioning.md",tags:[],version:"23.10",lastUpdatedAt:1699872045,formattedLastUpdatedAt:"13 nov. 2023",frontMatter:{id:"database-partitioning",title:"Partitionnement des bases de donn\xe9es"},sidebar:"version-23.10/docs",previous:{title:"Licences",permalink:"/centreon-documentation/pr-preview/staging/pr-2806/fr/docs/administration/licenses"},next:{title:"Sauvegarde",permalink:"/centreon-documentation/pr-preview/staging/pr-2806/fr/docs/administration/backup"}},u={},d=[{value:"Pr\xe9sentation",id:"pr\xe9sentation",level:2},{value:"Pr\xe9requis",id:"pr\xe9requis",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Fonctionnement",id:"fonctionnement",level:2},{value:"Migration des tables non partitionn\xe9es",id:"migration-des-tables-non-partitionn\xe9es",level:2},{value:"Supervision du fonctionnement du partitionnement",id:"supervision-du-fonctionnement-du-partitionnement",level:2}],c={toc:d},m="wrapper";function g(e){var{components:t}=e,o=s(e,["components"]);return(0,a.kt)(m,i(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),a.forEach((function(t){r(e,t,n[t])}))}return e}({},c,o),{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"pr\xe9sentation"},"Pr\xe9sentation"),(0,a.kt)("p",null,"Certaines tables de la base de donn\xe9es 'centreon","_","storage' sont partitionn\xe9es\nafin :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"D'optimiser le temps d'ex\xe9cution de nombreuses requ\xeates."),(0,a.kt)("li",{parentName:"ul"},"D'optimiser la purge des donn\xe9es."),(0,a.kt)("li",{parentName:"ul"},"De minimiser la reconstruction des tables en erreur lors d'un crash du SGBD.")),(0,a.kt)("p",null,"Une partition par jour est cr\xe9\xe9e pour les tables suivantes :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"data","_","bin")," : donn\xe9es de performance."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"logs")," : journaux d'\xe9v\xe8nements de la collecte des moteurs de supervision."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"log","_","archive","_","host")," : donn\xe9es de disponibilit\xe9 des h\xf4tes."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"log","_","archive","_","service")," : donn\xe9es de disponibilit\xe9 des services.")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Ce partitionnement comporte des limitations :"),(0,a.kt)("ul",{parentName:"blockquote"},(0,a.kt)("li",{parentName:"ul"},"Le nombre maximal de partitions (pour une table) est 1024"),(0,a.kt)("li",{parentName:"ul"},"Les cl\xe9s \xe9trang\xe8res ne sont pas support\xe9es"))),(0,a.kt)("p",null,"Plus de d\xe9tails sur le partitionnement MariaDB ",(0,a.kt)("a",{parentName:"p",href:"https://mariadb.com/kb/en/library/partitioning-overview/"},"\xe0 cette\nadresse"),"."),(0,a.kt)("h2",{id:"pr\xe9requis"},"Pr\xe9requis"),(0,a.kt)("p",null,"Les pr\xe9requis n\xe9cessaires pour l'utilisation de ce module sont les suivants :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"php-mysql"),(0,a.kt)("li",{parentName:"ul"},"Pear-DB"),(0,a.kt)("li",{parentName:"ul"},"MariaDB (",">","= 10.1)")),(0,a.kt)("p",null,"Le param\xe8tre MariaDB ",(0,a.kt)("strong",{parentName:"p"},"open","_","files","_","limit")," doit \xeatre fix\xe9 \xe0 32000 dans la section\n","[","server","]"," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"[server]\nopen_files_limit = 32000\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Si vous\ninstallez Centreon via les RPM sur votre propre server RedHat, vous\nserez oblig\xe9 de r\xe9aliser cette configuration manuellement. N'oubliez pas de\nred\xe9marrer le service mysql / mariadb si vous avez besoin de configurer ce\nparam\xe8tre dans le fichier my.cnf.")),(0,a.kt)("p",null,"Si vous utilisez systemd, il est n\xe9cessaire de cr\xe9er le fichier\n",(0,a.kt)("strong",{parentName:"p"},"/etc/systemd/system/mariadb.service.d/mariadb.conf")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"[Service]\nLimitNOFILE=32000\n")),(0,a.kt)("p",null,"Puis recharger systemd et MariaDB :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl daemon-reload\nsystemctl restart mariadb\n")),(0,a.kt)("h2",{id:"configuration"},"Configuration"),(0,a.kt)("p",null,"La dur\xe9e de r\xe9tention des donn\xe9es est programm\xe9e dans le menu `Administration"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Param\xe8tres > Options` :")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"image",src:n(470).Z,width:"857",height:"151"})),(0,a.kt)("p",null,"Le param\xe9trage est le suivant :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Retention duration for partitioning")," : dur\xe9e de r\xe9tention pour les tables\npartitionn\xe9es, par d\xe9faut ",(0,a.kt)("strong",{parentName:"li"},"365 jours"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Forward provisioning")," : nombre de partitions cr\xe9\xe9es en avance, par d\xe9faut\n",(0,a.kt)("strong",{parentName:"li"},"10 jours"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Backup directory for partitioning")," : r\xe9pertoire de sauvegarde des\npartitions, par d\xe9faut ",(0,a.kt)("strong",{parentName:"li"},"/var/cache/centreon/backup"),".")),(0,a.kt)("h2",{id:"fonctionnement"},"Fonctionnement"),(0,a.kt)("p",null,"Le partitionnement utilise des fichiers XML, pr\xe9sents dans le r\xe9pertoire\n",(0,a.kt)("strong",{parentName:"p"},"/usr/share/centreon/config/partition.d/")," pour cr\xe9er les partitions\nn\xe9cessaires."),(0,a.kt)("p",null,"Chaque jour, un script lanc\xe9 par un cron r\xe9alise la cr\xe9ation des tables\nmanquantes ou celles en avance :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"0 4 * * * centreon /bin/php /usr/share/centreon/cron/centreon-partitioning.php >> /var/log/centreon/centreon-partitioning.log 2>&1\n")),(0,a.kt)("p",null,"Exemple de fichier de partitionnement ",(0,a.kt)("strong",{parentName:"p"},"partitioning-data","_","bin.xml")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-xml"},"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<centreon-partitioning>\n    <table name=\"data_bin\" schema=\"centreon_storage\">\n        <activate>1</activate>\n        <column>ctime</column>\n        <type>date</type>\n        <createstmt>\nCREATE TABLE IF NOT EXISTS `data_bin` (\n    `id_metric` int(11) DEFAULT NULL,\n    `ctime` int(11) DEFAULT NULL,\n    `value` float DEFAULT NULL,\n    `status` enum('0','1','2','3','4') DEFAULT NULL,\n    KEY `index_metric` (`id_metric`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n        </createstmt>\n    </table>\n</centreon-partitioning>\n")),(0,a.kt)("h2",{id:"migration-des-tables-non-partitionn\xe9es"},"Migration des tables non partitionn\xe9es"),(0,a.kt)("p",null,"La ligne de commande ex\xe9cute la proc\xe9dure suivante :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Renomme la table existante (\u2018xxx\u2019 devient \u2018xxx","_","old\u2019)"),(0,a.kt)("li",{parentName:"ul"},"Cr\xe9e une table partitionn\xe9e vide"),(0,a.kt)("li",{parentName:"ul"},"Migre les donn\xe9es dans la table partitionn\xe9e (instructions \u2018SELECT INSERT\u2019)")),(0,a.kt)("p",null,"Des v\xe9rifications doivent \xeatre faites avant :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"L\u2019espace disponible sur le volume sur lequel se trouvent les bases MariaDB\ndoit \xeatre suffisant pour contenir deux fois la taille des tables trait\xe9es\n(Index + donn\xe9es)."),(0,a.kt)("li",{parentName:"ul"},"Les tables ne doivent pas contenir de donn\xe9es dans le futur (le temps est un\nfacteur cl\xe9 pour la mise en place du partitionnement)."),(0,a.kt)("li",{parentName:"ul"},"La m\xe9moire sur le serveur MariaDB doit \xeatre suffisante.")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Les requ\xeates/instructions \u2018SELECT INSERT\u2019 vont verrouiller la table et\nprobablement certains traitements.")),(0,a.kt)("p",null,"La migration de la table est effectu\xe9e en utilisant l\u2019option ",(0,a.kt)("strong",{parentName:"p"},"-m")," et en\npr\xe9cisant le nom de la table \xe0 migrer :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"/bin/php /usr/share/centreon/bin/centreon-partitioning.php -m data_bin\n")),(0,a.kt)("p",null,"Si la migration de la table est ok l\u2019ancienne table peut \xeatre supprim\xe9e avec la\ncommande suivante :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"DROP TABLE centreon_storage.data_bin_old;\n")),(0,a.kt)("h2",{id:"supervision-du-fonctionnement-du-partitionnement"},"Supervision du fonctionnement du partitionnement"),(0,a.kt)("p",null,"Le connecteur de supervision ",(0,a.kt)("strong",{parentName:"p"},"Centreon Database")," permet de contr\xf4ler que le nombre de\npartitions cr\xe9\xe9es en avances est suffisant. Il est recommand\xe9 d'installer et de\nd\xe9ployer ce dernier."),(0,a.kt)("p",null,"Il est \xe9galement possible de visualiser les tables partitionn\xe9es et la\nconsommation associ\xe9e \xe0 chaque partition via le menu ",(0,a.kt)("inlineCode",{parentName:"p"},"Administration > Statut\nde la plateforme > Bases de donn\xe9es")," :"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"image",src:n(63518).Z,width:"810",height:"453"})),(0,a.kt)("p",null,"Des informations plus globales sur l\u2019\xe9tat de sant\xe9 des bases de donn\xe9es sont\n\xe9galement pr\xe9sentes :"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"image",src:n(6286).Z,width:"547",height:"253"})))}g.isMDXComponent=!0},6286:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/database-information-d481307f1eab69dfb9d7d6073d1519fa.png"},470:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/partitioning-configuration-e8446c4d86ac2400e5d98b02b5716136.png"},63518:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/partitioning-state-a40fa5a154534bc982fb536468ce3d47.png"}}]);