"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[80880],{611:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>c,default:()=>A,frontMatter:()=>d,metadata:()=>u,toc:()=>m});t(67294);var a=t(3905),r=t(51715),s=t(7626);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})),e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}const d={id:"installation-4-nodes",title:"Installation d'un cluster \xe0 4 n\u0153uds"},c=void 0,u={unversionedId:"installation/installation-of-centreon-ha/installation-4-nodes",id:"version-23.10/installation/installation-of-centreon-ha/installation-4-nodes",title:"Installation d'un cluster \xe0 4 n\u0153uds",description:"Pr\xe9requis",source:"@site/i18n/fr/docusaurus-plugin-content-docs/version-23.10/installation/installation-of-centreon-ha/installation-4-nodes.md",sourceDirName:"installation/installation-of-centreon-ha",slug:"/installation/installation-of-centreon-ha/installation-4-nodes",permalink:"/centreon-documentation/pr-preview/staging/pr-2806/fr/docs/installation/installation-of-centreon-ha/installation-4-nodes",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/i18n/fr/docusaurus-plugin-content-docs/version-23.10/installation/installation-of-centreon-ha/installation-4-nodes.md",tags:[],version:"23.10",lastUpdatedAt:1699631982,formattedLastUpdatedAt:"10 nov. 2023",frontMatter:{id:"installation-4-nodes",title:"Installation d'un cluster \xe0 4 n\u0153uds"},sidebar:"version-23.10/docs",previous:{title:"Installation d'un cluster \xe0 2 n\u0153uds",permalink:"/centreon-documentation/pr-preview/staging/pr-2806/fr/docs/installation/installation-of-centreon-ha/installation-2-nodes"},next:{title:"Int\xe9grer des pollers dans un cluster Centreon-HA",permalink:"/centreon-documentation/pr-preview/staging/pr-2806/fr/docs/installation/installation-of-centreon-ha/integrating-pollers"}},p={},m=[{value:"Pr\xe9requis",id:"pr\xe9requis",level:2},{value:"Compr\xe9hension",id:"compr\xe9hension",level:3},{value:"Flux r\xe9seaux",id:"flux-r\xe9seaux",level:3},{value:"Installation de Centreon",id:"installation-de-centreon",level:3},{value:"Quorum Device",id:"quorum-device",level:3},{value:"D\xe9finition des noms et adresses IP des serveurs",id:"d\xe9finition-des-noms-et-adresses-ip-des-serveurs",level:3},{value:"Configuration de centreon-broker",id:"configuration-de-centreon-broker",level:3},{value:"Liaison au service cbd",id:"liaison-au-service-cbd",level:4},{value:"Double flux RRD",id:"double-flux-rrd",level:4},{value:"Exporter la configuration",id:"exporter-la-configuration",level:4},{value:"Modification de la commande de rechargement de <code>cbd</code>",id:"modification-de-la-commande-de-rechargement-de-cbd",level:3},{value:"Pr\xe9paration du syst\xe8me",id:"pr\xe9paration-du-syst\xe8me",level:2},{value:"Optimisation de la configuration r\xe9seau",id:"optimisation-de-la-configuration-r\xe9seau",level:3},{value:"R\xe9solution de noms",id:"r\xe9solution-de-noms",level:3},{value:"Installation des paquets",id:"installation-des-paquets",level:3},{value:"Serveurs Centraux",id:"serveurs-centraux",level:4},{value:"Serveurs Base de donn\xe9es",id:"serveurs-base-de-donn\xe9es",level:4},{value:"\xc9changes de clefs SSH",id:"\xe9changes-de-clefs-ssh",level:3},{value:"Compte <code>centreon</code>",id:"compte-centreon",level:4},{value:"Compte <code>mysql</code>",id:"compte-mysql",level:4},{value:"Mise en place de la r\xe9plication MariaDB",id:"mise-en-place-de-la-r\xe9plication-mariadb",level:2},{value:"Configuration de MariaDB",id:"configuration-de-mariadb",level:3},{value:"S\xe9curisation de la base de donn\xe9es",id:"s\xe9curisation-de-la-base-de-donn\xe9es",level:3},{value:"Cr\xe9ation du compte centreon",id:"cr\xe9ation-du-compte-centreon",level:3},{value:"Cr\xe9ation du compte de r\xe9plication",id:"cr\xe9ation-du-compte-de-r\xe9plication",level:3},{value:"Configuration des variables d&#39;environnement des scripts MariaDB",id:"configuration-des-variables-denvironnement-des-scripts-mariadb",level:3},{value:"Passage en read-only",id:"passage-en-read-only",level:3},{value:"Synchroniser les bases et lancer la r\xe9plication MariaDB",id:"synchroniser-les-bases-et-lancer-la-r\xe9plication-mariadb",level:3},{value:"Mise en place du cluster Centreon",id:"mise-en-place-du-cluster-centreon",level:2},{value:"Configuration du service de synchronisation",id:"configuration-du-service-de-synchronisation",level:3},{value:"Suppression des crons",id:"suppression-des-crons",level:3},{value:"Modification des droits",id:"modification-des-droits",level:3},{value:"Arr\xeat et d\xe9sactivation des services",id:"arr\xeat-et-d\xe9sactivation-des-services",level:3},{value:"Cr\xe9ation du cluster",id:"cr\xe9ation-du-cluster",level:3},{value:"Activation des services de clustering",id:"activation-des-services-de-clustering",level:4},{value:"Pr\xe9paration du serveur qui jouera le r\xf4le de <em>Quorum Device</em>",id:"pr\xe9paration-du-serveur-qui-jouera-le-r\xf4le-de-quorum-device",level:4},{value:"Authentification aupr\xe8s des membres du cluster",id:"authentification-aupr\xe8s-des-membres-du-cluster",level:4},{value:"Cr\xe9ation du cluster",id:"cr\xe9ation-du-cluster-1",level:4},{value:"Ajout du <em>Quorum Device</em>",id:"ajout-du-quorum-device",level:4},{value:"Cr\xe9ation des ressources MariaDB",id:"cr\xe9ation-des-ressources-mariadb",level:3},{value:"Process MariaDB Primaire/secondaire",id:"process-mariadb-primairesecondaire",level:4},{value:"Adresse VIP Serveurs bases de donn\xe9es",id:"adresse-vip-serveurs-bases-de-donn\xe9es",level:5},{value:"Cr\xe9ation des ressources clones",id:"cr\xe9ation-des-ressources-clones",level:3},{value:"PHP8",id:"php8",level:4},{value:"Broker RRD",id:"broker-rrd",level:4},{value:"Cr\xe9ation du groupe de ressources Centreon",id:"cr\xe9ation-du-groupe-de-ressources-centreon",level:3},{value:"Adresse VIP Serveurs Centraux",id:"adresse-vip-serveurs-centraux",level:4},{value:"Service httpd",id:"service-httpd",level:4},{value:"Service Gorgone",id:"service-gorgone",level:4},{value:"Service centreon-central-sync",id:"service-centreon-central-sync",level:4},{value:"Broker SQL",id:"broker-sql",level:4},{value:"Service centengine",id:"service-centengine",level:4},{value:"Service centreontrapd",id:"service-centreontrapd",level:4},{value:"Service snmptrapd",id:"service-snmptrapd",level:4},{value:"Contraintes",id:"contraintes",level:3},{value:"Lancement du Cluster et contr\xf4le de l&#39;\xe9tat des ressources",id:"lancement-du-cluster-et-contr\xf4le-de-l\xe9tat-des-ressources",level:3},{value:"Activer les ressources",id:"activer-les-ressources",level:4},{value:"Contr\xf4le de l&#39;\xe9tat du cluster",id:"contr\xf4le-de-l\xe9tat-du-cluster",level:3},{value:"Contr\xf4le de l&#39;\xe9tat des ressources",id:"contr\xf4le-de-l\xe9tat-des-ressources",level:4},{value:"Ressources d\xe9sactiv\xe9es",id:"ressources-d\xe9sactiv\xe9es",level:4},{value:"Contr\xf4ler la synchronisation des bases",id:"contr\xf4ler-la-synchronisation-des-bases",level:4},{value:"Contr\xf4le de l&#39;absence de contraintes",id:"contr\xf4le-de-labsence-de-contraintes",level:4},{value:"Modifications des fichiers de configuration Centreon",id:"modifications-des-fichiers-de-configuration-centreon",level:2},{value:"Modification des outputs central-broker-master",id:"modification-des-outputs-central-broker-master",level:3},{value:"Exporter la configuration",id:"exporter-la-configuration-1",level:3},{value:"Modification des 3 fichiers de configuration",id:"modification-des-3-fichiers-de-configuration",level:3},{value:"Int\xe9grer des collecteurs",id:"int\xe9grer-des-collecteurs",level:2}],N={toc:m},k="wrapper";function A(e){var{components:n}=e,t=o(e,["components"]);return(0,a.kt)(k,i(function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{},a=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),a.forEach((function(n){l(e,n,t[n])}))}return e}({},N,t),{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"pr\xe9requis"},"Pr\xe9requis"),(0,a.kt)("h3",{id:"compr\xe9hension"},"Compr\xe9hension"),(0,a.kt)("p",null,"Avant de suivre cette proc\xe9dure, il est recommand\xe9 d'avoir un niveau de connaissance satisfaisant du syst\xe8me d'exploitation Linux, de Centreon\net des outils de clustering Pacemaker-Corosync pour bien comprendre ce qui va \xeatre fait et pour pouvoir se sortir d'un \xe9ventuel faux pas."),(0,a.kt)("h3",{id:"flux-r\xe9seaux"},"Flux r\xe9seaux"),(0,a.kt)("p",null,"En plus des flux r\xe9seaux n\xe9cessaires d\xe9crits dans le chapitre ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/staging/pr-2806/fr/docs/installation/architectures#tableaux-des-flux-r%C3%A9seau"},"pr\xe9requis"),"\nIl sera n\xe9cessaire d'ouvrir les flux suppl\xe9mentaires suivants :"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"left"},"Source"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Destination"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Protocole"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Port"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Commentaires"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"N\u0153ud Central actif"),(0,a.kt)("td",{parentName:"tr",align:"left"},"N\u0153ud Central passif"),(0,a.kt)("td",{parentName:"tr",align:"left"},"SSH"),(0,a.kt)("td",{parentName:"tr",align:"left"},"TCP 22"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Synchronisation des fichiers de configuration (Le flux doit \xeatre aussi ouvert dans le sens passif --\x3e actif)")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"N\u0153ud Central actif"),(0,a.kt)("td",{parentName:"tr",align:"left"},"N\u0153ud Central passif"),(0,a.kt)("td",{parentName:"tr",align:"left"},"BDDO"),(0,a.kt)("td",{parentName:"tr",align:"left"},"TCP 5670"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Synchronisation des RRDs (Le flux doit \xeatre aussi ouvert dans le sens passif --\x3e actif)")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"N\u0153ud BDD actif"),(0,a.kt)("td",{parentName:"tr",align:"left"},"N\u0153ud BDD passif"),(0,a.kt)("td",{parentName:"tr",align:"left"},"MySQL"),(0,a.kt)("td",{parentName:"tr",align:"left"},"TCP 3306"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Synchronisation MySQL (Le flux doit \xeatre aussi ouvert dans le sens passif --\x3e actif)")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"N\u0153ud BDD actif"),(0,a.kt)("td",{parentName:"tr",align:"left"},"N\u0153ud BDD passif"),(0,a.kt)("td",{parentName:"tr",align:"left"},"SSH"),(0,a.kt)("td",{parentName:"tr",align:"left"},"TCP 22"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Synchronisation MySQL (Le flux doit \xeatre aussi ouvert dans le sens passif --\x3e actif)")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"Serveurs Centraux + BDD + QDevice"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Serveurs Centraux + BDD + QDevice"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Corosync"),(0,a.kt)("td",{parentName:"tr",align:"left"},"UDP 5404"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Communication au sein du cluster (Multicast)")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"Serveurs Centraux + BDD + QDevice"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Serveurs Centraux + BDD + QDevice"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Corosync"),(0,a.kt)("td",{parentName:"tr",align:"left"},"UDP 5405"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Communication au sein du cluster (Unicast)")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"Serveurs Centraux + BDD + QDevice"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Serveurs Centraux + BDD + QDevice"),(0,a.kt)("td",{parentName:"tr",align:"left"},"PCS"),(0,a.kt)("td",{parentName:"tr",align:"left"},"TCP 2224"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Communication au sein du cluster")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"Serveurs Centraux + BDD + QDevice"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Serveurs Centraux + BDD + QDevice"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Corosync"),(0,a.kt)("td",{parentName:"tr",align:"left"},"TCP 5403"),(0,a.kt)("td",{parentName:"tr",align:"left"},"Communication avec le QDevice")))),(0,a.kt)("h3",{id:"installation-de-centreon"},"Installation de Centreon"),(0,a.kt)("p",null,"L'installation d'un cluster Centreon-HA ne peut se faire que sur la base d'une installation fonctionnelle de Centreon. Avant de suivre cette proc\xe9dure, il est donc imp\xe9ratif d'avoir appliqu\xe9 ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("a",{parentName:"strong",href:"/centreon-documentation/pr-preview/staging/pr-2806/fr/docs/installation/introduction"},"cette proc\xe9dure d'installation"))," jusqu'au bout ",(0,a.kt)("strong",{parentName:"p"},"en r\xe9servant environ 5GB de libre")," sur le ",(0,a.kt)("em",{parentName:"p"},"volume group")," qui contient  les donn\xe9es MariaDB (point de montage ",(0,a.kt)("inlineCode",{parentName:"p"},"/var/lib/mysql")," par d\xe9faut)."),(0,a.kt)("p",null,"La commande ",(0,a.kt)("inlineCode",{parentName:"p"},"vgs")," doit retourner un affichage de la forme ci-dessous (en particulier la valeur sous ",(0,a.kt)("inlineCode",{parentName:"p"},"VFree"),") :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"  VG                    #PV #LV #SN Attr   VSize   VFree \n  centos_centreon-c1      1   5   0 wz--n- <31,00g <5,00g\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Les fichiers MariaDB ",(0,a.kt)("inlineCode",{parentName:"li"},"ibdata*")," et ",(0,a.kt)("inlineCode",{parentName:"li"},"ib_logfile*"),' doivent \xeatre dans le r\xe9pertoire "datadir" ou dans un sous-r\xe9pertoire (les scripts ',(0,a.kt)("inlineCode",{parentName:"li"},"centreondb-smooth-backup.sh")," et ",(0,a.kt)("inlineCode",{parentName:"li"},"mysql-sync-bigdb.sh")," ne sont pas compatibles avec cette op\xe9ration) ;"),(0,a.kt)("li",{parentName:"ul"},"Les fichiers MariaDB ",(0,a.kt)("inlineCode",{parentName:"li"},"log-bin*")," et ",(0,a.kt)("inlineCode",{parentName:"li"},"relay-log*"),' peuvent \xeatre situ\xe9s dans un r\xe9pertoire (ou un sous-r\xe9pertoire) diff\xe9rent de "datadir". Ils peuvent \xe9galement se trouver sur un volume logique (',(0,a.kt)("inlineCode",{parentName:"li"},"lvm"),') diff\xe9rent de "datadir". Cependant, le volume logique doit \xeatre situ\xe9 dans le groupe de volume o\xf9 "datadir" est stock\xe9.')),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"AVERTISSEMENT :")," Si ces pr\xe9requis sp\xe9cifiques ne sont pas respect\xe9s, la m\xe9thode de synchronisation des bases de donn\xe9es d\xe9crite ci-dessous ne fonctionnera pas.")),(0,a.kt)("h3",{id:"quorum-device"},"Quorum Device"),(0,a.kt)("p",null,"Pour le bon fonctionnement du cluster, en particulier pour \xe9viter les cas de split-brain, il est n\xe9cessaire d'avoir un serveur tiers pour tenir le r\xf4le d'arbitre. Il est possible d'utiliser un collecteur pour remplir ce r\xf4le."),(0,a.kt)("p",null,"Afin de respecter les meilleures pratiques et de b\xe9n\xe9ficier d'une infrastructure aussi r\xe9siliente que possible, le placement du serveur\nQuorum doit \xeatre sur un site diff\xe9rent des deux n\u0153uds principaux, avec des attachements r\xe9seaux ind\xe9pendants."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"AVERTISSEMENT:")," Assurez-vous que SELinux et Firewalld sont d\xe9sactiv\xe9s.")),(0,a.kt)("h3",{id:"d\xe9finition-des-noms-et-adresses-ip-des-serveurs"},"D\xe9finition des noms et adresses IP des serveurs"),(0,a.kt)("p",null,"Dans cette proc\xe9dure, nous ferons r\xe9f\xe9rence \xe0 des param\xe8tres variant d'une installation \xe0 une autre (noms et adresses IP des n\u0153uds par exemple) par l'interm\xe9diaire des macros suivantes :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_MASTER_IPADDR@")," : adresse IP du serveur Centreon-Web principal"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_MASTER_NAME@")," : nom du serveur Centreon-Web principal (doit \xeatre identique au r\xe9sultat de ",(0,a.kt)("inlineCode",{parentName:"li"},"hostname -s"),")"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_SLAVE_IPADDR@")," : adresse IP du serveur Centreon-Web secondaire"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_SLAVE_NAME@")," : nom du serveur Centreon-Web secondaire (doit \xeatre identique au r\xe9sultat de ",(0,a.kt)("inlineCode",{parentName:"li"},"hostname -s"),")"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DATABASE_MASTER_IPADDR@")," : adresse IP du serveur de base de donn\xe9es principal"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DATABASE_MASTER_NAME@")," : nom du serveur de base de donn\xe9es principal (doit \xeatre identique au r\xe9sultat de ",(0,a.kt)("inlineCode",{parentName:"li"},"hostname -s"),")"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DATABASE_SLAVE_IPADDR@")," : adresse IP du serveur de base de donn\xe9es secondaire"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DATABASE_SLAVE_NAME@")," : nom du serveur de base de donn\xe9es secondaire (doit \xeatre identique au r\xe9sultat de ",(0,a.kt)("inlineCode",{parentName:"li"},"hostname -s"),")"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@QDEVICE_IPADDR@")," : adresse IP du serveur supportant le ",(0,a.kt)("em",{parentName:"li"},"quorum device")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@QDEVICE_NAME@")," : nom du serveur supportant le ",(0,a.kt)("em",{parentName:"li"},"quorum device")," (doit \xeatre identique au r\xe9sultat de ",(0,a.kt)("inlineCode",{parentName:"li"},"hostname -s"),")"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MARIADB_REPL_USER@")," : nom du compte MariaDB de r\xe9plication (sugg\xe9r\xe9 : centreon-repl)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MARIADB_REPL_PASSWD@")," : mot de passe de ce compte"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MARIADB_CENTREON_USER@")," : nom du compte MariaDB de Centreon (sugg\xe9r\xe9 : centreon)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MARIADB_CENTREON_PASSWD@")," : mot de passe de ce compte"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@VIP_IPADDR@")," : adresse IP virtuelle du cluster"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@VIP_IFNAME@")," : nom de l'interface qui portera la VIP"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@VIP_CIDR_NETMASK@")," : masque de sous-r\xe9seau exprim\xe9 en nombre de bits sans le '/' (exemple : 24)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@VIP_BROADCAST_IPADDR@")," : adresse de broadcast"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@VIP_SQL_IPADDR@")," : adresse IP virtuelle du cluster"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@VIP_SQL_IFNAME@")," : nom de l'interface qui portera la VIP"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@VIP_SQL_CIDR_NETMASK@")," : masque de sous-r\xe9seau exprim\xe9 en nombre de bits sans le '/' (exemple : 24)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@VIP_SQL_BROADCAST_IPADDR@")," : adresse de broadcast"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTREON_CLUSTER_PASSWD@")," : mot de passe du compte ",(0,a.kt)("inlineCode",{parentName:"li"},"hacluster"))),(0,a.kt)("h3",{id:"configuration-de-centreon-broker"},"Configuration de centreon-broker"),(0,a.kt)("h4",{id:"liaison-au-service-cbd"},"Liaison au service cbd"),(0,a.kt)("p",null,"Dans une installation standard de Centreon, le service ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd")," pilote deux instances de ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon-broker-daemon")," :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"central-broker-master"),' : que l\'on appelle aussi "broker central" ou encore "broker SQL", qui redirige toutes les entr\xe9es-sorties en provenance des pollers, vers les bases de donn\xe9es, vers le broker RRD, etc.'),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"central-rrd-master")," : le broker RRD qui re\xe7oit son flux du broker SQL, et dont la seule fonction est d'\xe9crire les fichiers RRD utilis\xe9s pour afficher les graphes.")),(0,a.kt)("p",null,"Dans un cluster Centreon-HA, les deux processus broker vont \xeatre g\xe9r\xe9s chacun via un service distinct qui sera pilot\xe9 par le cluster :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"central-broker-master")," en tant que la ressource ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd_central_broker"),", li\xe9e au service ",(0,a.kt)("em",{parentName:"li"},"systemd")," ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd-sql")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"central-rrd-master")," en tant que la ressource clone ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd_rrd"),", li\xe9e au service ",(0,a.kt)("em",{parentName:"li"},"systemd")," ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd")," standard de Centreon.")),(0,a.kt)("p",null,"Pour que tout se mette bien en place dans la suite, il faut d\xe8s \xe0 pr\xe9sent d\xe9faire la liaison entre central-broker-master et le service ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd")," ",(0,a.kt)("strong",{parentName:"p"},'en cochant "non" pour le param\xe8tre "Li\xe9 au service cbd"')," dans ",(0,a.kt)("em",{parentName:"p"},"Configuration")," > ",(0,a.kt)("em",{parentName:"p"},"Pollers")," > ",(0,a.kt)("em",{parentName:"p"},"Broker configuration")," > ",(0,a.kt)("em",{parentName:"p"},"central-broker-master")," dans l'onglet ",(0,a.kt)("em",{parentName:"p"},"General"),"."),(0,a.kt)("h4",{id:"double-flux-rrd"},"Double flux RRD"),(0,a.kt)("p",null,"Plut\xf4t que de mettre en place une r\xe9plication en temps r\xe9el des fichiers de donn\xe9es RRD, le choix technique qui a \xe9t\xe9 fait pour permettre d'afficher les graphes sur n'importe quel n\u0153ud d\xe8s qu'il devient ",(0,a.kt)("inlineCode",{parentName:"p"},"master")," a \xe9t\xe9 de dupliquer le flux de sortie (",(0,a.kt)("inlineCode",{parentName:"p"},"output"),") de ",(0,a.kt)("inlineCode",{parentName:"p"},"central-broker-master")," vers ",(0,a.kt)("inlineCode",{parentName:"p"},"central-rrd-master"),". Cela se configure dans le m\xeame menu qu'au paragraphe pr\xe9c\xe9dent, mais cette fois dans l'onglet ",(0,a.kt)("em",{parentName:"p"},"Output")," de ",(0,a.kt)("em",{parentName:"p"},"Configuration  >  Collecteurs  >  Configuration de Centreon Broker"),"."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},'Modifier la sortie "IPv4" en rempla\xe7ant "localhost" par ',(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_MASTER_IPADDR@"))),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Output IPv4"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Nom"),(0,a.kt)("td",{parentName:"tr",align:null},"centreon-broker-master-rrd")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Port de connexion"),(0,a.kt)("td",{parentName:"tr",align:null},"5670")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"H\xf4te distant"),(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"@CENTRAL_MASTER_IPADDR@"))),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Temps avant activation du processus de basculement (failover)"),(0,a.kt)("td",{parentName:"tr",align:null},"0")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Intervalle entre 2 tentatives"),(0,a.kt)("td",{parentName:"tr",align:null},"60")))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},'Ajouter une nouvelle sortie IPv4, similaire \xe0 la premi\xe8re et nomm\xe9e par exemple "centreon-broker-slave-rrd" pointant cette fois vers ',(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_SLAVE_IPADDR@"),".")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Output IPv4"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Nom"),(0,a.kt)("td",{parentName:"tr",align:null},"centreon-broker-slave-rrd")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Port de connexion"),(0,a.kt)("td",{parentName:"tr",align:null},"5670")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"H\xf4te distant"),(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"@CENTRAL_SLAVE_IPADDR@"))),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Temps avant activation du processus de basculement (failover)"),(0,a.kt)("td",{parentName:"tr",align:null},"0")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Intervalle entre 2 tentatives"),(0,a.kt)("td",{parentName:"tr",align:null},"60")))),(0,a.kt)("h4",{id:"exporter-la-configuration"},"Exporter la configuration"),(0,a.kt)("p",null,'Une fois que les actions des deux pr\xe9c\xe9dents paragraphes ont \xe9t\xe9 r\xe9alis\xe9es, il faut exporter la configuration (3 premi\xe8res cases pour l\'export du collecteur "Central") pour que celle-ci soit effective.'),(0,a.kt)("p",null,"Ces actions doivent \xeatre r\xe9alis\xe9es soit sur les deux n\u0153uds, soit uniquement sur ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," puis les fichiers de configuration de broker doivent \xeatre copi\xe9s vers ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rsync -a /etc/centreon-broker/*json @CENTRAL_SLAVE_IPADDR@:/etc/centreon-broker/\n")),(0,a.kt)("h3",{id:"modification-de-la-commande-de-rechargement-de-cbd"},"Modification de la commande de rechargement de ",(0,a.kt)("inlineCode",{parentName:"h3"},"cbd")),(0,a.kt)("p",null,"Cela n'est pas forc\xe9ment connu de tous les utilisateurs de Centreon, mais chaque fois qu'un rechargement de la configuration du collecteur central est effectu\xe9 via l'interface, le service broker (",(0,a.kt)("inlineCode",{parentName:"p"},"cbd"),') est recharg\xe9 (pas seulement centengine), d\'o\xf9 le param\xe8tre "Centreon Broker reload command" dans ',(0,a.kt)("em",{parentName:"p"},"Configuration > Collecteurs > Central"),"."),(0,a.kt)("p",null,"Ainsi que cela a \xe9t\xe9 expliqu\xe9 plus haut, les processus broker sont r\xe9partis entre deux services : ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd")," pour le broker RRD, ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd-sql")," pour le broker central. Dans le cadre d'un cluster centreon-ha, service que l'on doit recharger lors de l'export de configuration est ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd-sql")," et non plus ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd"),". Il faut donc appliquer la valeur ",(0,a.kt)("inlineCode",{parentName:"p"},"service cbd-sql reload"),' au param\xe8tre "Centreon Broker reload command".'),(0,a.kt)("h2",{id:"pr\xe9paration-du-syst\xe8me"},"Pr\xe9paration du syst\xe8me"),(0,a.kt)("p",null,"Avant d'en arriver au param\xe9trage du cluster \xe0 proprement parler, quelques \xe9tapes pr\xe9paratoires sont n\xe9cessaires au niveau de l'OS."),(0,a.kt)("h3",{id:"optimisation-de-la-configuration-r\xe9seau"},"Optimisation de la configuration r\xe9seau"),(0,a.kt)("p",null,"Afin d'am\xe9liorer la fiabilit\xe9 du cluster et \xe9tant donn\xe9 que ",(0,a.kt)("em",{parentName:"p"},"Centreon HA")," ne fonctionne qu'en IP v4, il est recommand\xe9 d'appliquer le tuning suivant sur tous les serveurs de la plateforme Centreon :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cat >> /etc/sysctl.conf <<EOF\nnet.ipv6.conf.all.disable_ipv6 = 1\nnet.ipv6.conf.default.disable_ipv6 = 1\nnet.ipv4.tcp_retries2 = 3\nnet.ipv4.tcp_keepalive_time = 200\nnet.ipv4.tcp_keepalive_probes = 2\nnet.ipv4.tcp_keepalive_intvl = 2\nEOF\nsystemctl restart NetworkManager\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cat >> /etc/sysctl.conf <<EOF\nnet.ipv6.conf.all.disable_ipv6 = 1\nnet.ipv6.conf.default.disable_ipv6 = 1\nnet.ipv4.tcp_retries2 = 3\nnet.ipv4.tcp_keepalive_time = 200\nnet.ipv4.tcp_keepalive_probes = 2\nnet.ipv4.tcp_keepalive_intvl = 2\nEOF\nreboot\n")))),(0,a.kt)("h3",{id:"r\xe9solution-de-noms"},"R\xe9solution de noms"),(0,a.kt)("p",null,"Pour s\xe9curiser le bon fonctionnement du cluster m\xeame en cas de panne du service de r\xe9solution de noms, il est imp\xe9ratif que les n\u0153uds se connaissent ",(0,a.kt)("em",{parentName:"p"},"via")," le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat >/etc/hosts <<"EOF"\n127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n@CENTRAL_MASTER_IPADDR@ @CENTRAL_MASTER_NAME@\n@CENTRAL_SLAVE_IPADDR@ @CENTRAL_SLAVE_NAME@\n@DATABASE_MASTER_IPADDR@ @DATABASE_MASTER_NAME@\n@DATABASE_SLAVE_IPADDR@ @DATABASE_SLAVE_NAME@\n@QDEVICE_IPADDR@ @QDEVICE_NAME@\nEOF\n')),(0,a.kt)("p",null,"Dans la suite de ce document, on parlera de n\u0153ud principal pour le premier et de n\u0153ud secondaire pour le second. Cette distinction est purement arbitraire, les r\xf4les pourront bien s\xfbr \xeatre \xe9chang\xe9s une fois l'installation termin\xe9e."),(0,a.kt)("h3",{id:"installation-des-paquets"},"Installation des paquets"),(0,a.kt)("p",null,"Centreon propose les paquets ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon-ha-common")," et ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon-ha-web"),", qui fournit tous les scripts et les d\xe9pendances n\xe9cessaires au fonctionnement d'un cluster Centreon."),(0,a.kt)("h4",{id:"serveurs-centraux"},"Serveurs Centraux"),(0,a.kt)("p",null,"Ces paquets sont \xe0 installer sur l'ensemble les 2 Serveurs Centraux :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma Linux 8",label:"Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ha\ndnf install centreon-ha-web pcs pacemaker corosync corosync-qdevice\n"))),(0,a.kt)(s.Z,{value:"RHEL 8",label:"RHEL 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf -y install dnf-plugins-core https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm\nsubscription-manager repos --enable rhel-8-for-x86_64-highavailability-rpms\ndnf install centreon-ha-web pcs pacemaker corosync corosync-qdevice\n"))),(0,a.kt)(s.Z,{value:"Oracle Linux 8",label:"Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ol8_addons\ndnf install centreon-ha-web pcs pacemaker corosync corosync-qdevice\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"apt update && apt install centreon-ha-web pcs pacemaker corosync corosync-qdevice \n")))),(0,a.kt)("h4",{id:"serveurs-base-de-donn\xe9es"},"Serveurs Base de donn\xe9es"),(0,a.kt)("p",null,"These packages must be installed on both Database Servers (Except Quorum):"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma Linux 8",label:"Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ha\ndnf install centreon-ha-common pcs pacemaker corosync corosync-qdevice\n"))),(0,a.kt)(s.Z,{value:"RHEL 8",label:"RHEL 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf -y install dnf-plugins-core https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm\nsubscription-manager repos --enable rhel-8-for-x86_64-highavailability-rpms\ndnf install centreon-ha-common pcs pacemaker corosync corosync-qdevice\n"))),(0,a.kt)(s.Z,{value:"Oracle Linux 8",label:"Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ol8_addons\ndnf install centreon-ha-common pcs pacemaker corosync corosync-qdevice\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"apt update && apt install centreon-ha-common pcs pacemaker corosync corosync-qdevice \n")))),(0,a.kt)("h3",{id:"\xe9changes-de-clefs-ssh"},"\xc9changes de clefs SSH"),(0,a.kt)("p",null,"Afin de permettre aux deux serveurs centraux d'\xe9changer des fichiers et des commandes, il faut mettre en place la possibilit\xe9 de se connecter ",(0,a.kt)("em",{parentName:"p"},"via")," SSH d'un serveur \xe0 l'autre pour les utilisateurs :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mysql")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"centreon"))),(0,a.kt)("p",null,"Il existe 2 fa\xe7ons d'\xe9changer des clefs SSH :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"En utilisant ",(0,a.kt)("inlineCode",{parentName:"li"},"ssh-copy-id")," : l'utilisation de cette commande n\xe9cessite de pouvoir valider l'authentification au moyen d'un mot de passe. Or, il n'est pas souhaitable, pour les comptes de service dont il est question ici, de d\xe9finir de mot de passe. Si cette m\xe9thode est retenue malgr\xe9 tout, il est recommand\xe9 de supprimer le mot de passe apr\xe8s l'\xe9change, avec les commandes ",(0,a.kt)("inlineCode",{parentName:"li"},"passwd -d centreon")," et ",(0,a.kt)("inlineCode",{parentName:"li"},"passwd -d mysql")),(0,a.kt)("li",{parentName:"ul"},"En copiant manuellement la clef publique dans ",(0,a.kt)("inlineCode",{parentName:"li"},"~/.ssh/authorized_keys"),". Cette m\xe9thode est \xe0 privil\xe9gier, mais demande, pour fonctionner correctement, que seul le propri\xe9taire du fichier soit capable d'acc\xe9der en lecture \xe0 celui-ci.")),(0,a.kt)("p",null,"C'est la seconde m\xe9thode qui sera propos\xe9e plus bas."),(0,a.kt)("h4",{id:"compte-centreon"},"Compte ",(0,a.kt)("inlineCode",{parentName:"h4"},"centreon")),(0,a.kt)("p",null,"Cette proc\xe9dure est \xe0 appliquer sur les deux n\u0153uds centraux. Pour commencer passer dans l'environnement ",(0,a.kt)("inlineCode",{parentName:"p"},"bash")," de ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"su - centreon\n")),(0,a.kt)("p",null,"Puis lancer ces commandes sur les deux n\u0153uds centraux :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-keygen -t ed25519 -a 100\ncat ~/.ssh/id_ed25519.pub\n")),(0,a.kt)("p",null,"Apr\xe8s avoir lanc\xe9 ces commandes sur les deux n\u0153uds, copier le contenu du fichier qui s'est affich\xe9 sous la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"cat")," et le coller dans le fichier (\xe0 cr\xe9er) ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.ssh/authorized_keys"),", sur l'autre noeud puis appliquer les bons droits sur le fichier (toujours en tant que ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon"),") :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 600 ~/.ssh/authorized_keys\n")),(0,a.kt)("p",null,"L'\xe9change de clefs doit ensuite \xeatre valid\xe9 par une premi\xe8re connexion qui permettra d'accepter la signature du serveur SSH (toujours en tant que ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon"),") :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssh <nom de l'autre n\u0153ud>\n")),(0,a.kt)("p",null,"Puis sortir de la session de ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon")," avec ",(0,a.kt)("inlineCode",{parentName:"p"},"exit")," ou ",(0,a.kt)("inlineCode",{parentName:"p"},"Ctrl-D"),"."),(0,a.kt)("h4",{id:"compte-mysql"},"Compte ",(0,a.kt)("inlineCode",{parentName:"h4"},"mysql")),(0,a.kt)("p",null,"Pour le compte ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," la proc\xe9dure diff\xe8re quelque peu, car cet utilisateur n'a normalement pas de ",(0,a.kt)("em",{parentName:"p"},"home directory")," ni la possibilit\xe9 d'ouvrir une session Shell. Cette proc\xe9dure est \xe0 appliquer sur les deux n\u0153uds base de donn\xe9es."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop mariadb\nmkdir /home/mysql\nchown mysql: /home/mysql\nusermod -d /home/mysql mysql\nusermod -s /bin/bash mysql\nsystemctl start mariadb\nsu - mysql\n")),(0,a.kt)("p",null,"Une fois dans l'environnement ",(0,a.kt)("inlineCode",{parentName:"p"},"bash")," de ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),", lancer ces commandes sur les deux n\u0153uds centraux :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-keygen -t ed25519 -a 100\ncat ~/.ssh/id_ed25519.pub\n")),(0,a.kt)("p",null,"Apr\xe8s avoir lanc\xe9 ces commandes sur les deux n\u0153uds, copier le contenu du fichier et le coller dans ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.ssh/authorized_keys"),", sur l'autre noeud puis appliquer les bons droits sur le fichier (toujours en tant que ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),") :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 600 ~/.ssh/authorized_keys\n")),(0,a.kt)("p",null,"L'\xe9change de clefs doit ensuite \xeatre valid\xe9 par une premi\xe8re connexion qui permettra d'accepter la signature du serveur SSH (toujours en tant que ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),") :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssh <nom de l'autre n\u0153ud>\n")),(0,a.kt)("p",null,"Puis sortir de la session de ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," avec ",(0,a.kt)("inlineCode",{parentName:"p"},"exit")," ou ",(0,a.kt)("inlineCode",{parentName:"p"},"Ctrl-D"),"."),(0,a.kt)("h2",{id:"mise-en-place-de-la-r\xe9plication-mariadb"},"Mise en place de la r\xe9plication MariaDB"),(0,a.kt)("p",null,"Afin que les deux n\u0153uds soient interchangeables \xe0 tout moment, il faut que les deux bases de donn\xe9es soient r\xe9pliqu\xe9es en continu. Pour cela, nous allons mettre en place une r\xe9plication Master-Slave."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Remarque :")," sauf une mention contraire, chacune des \xe9tapes suivantes est \xe0 r\xe9aliser ",(0,a.kt)("strong",{parentName:"p"},"sur les deux n\u0153uds de bases de donn\xe9es"),"."),(0,a.kt)("h3",{id:"configuration-de-mariadb"},"Configuration de MariaDB"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("p",null,"Pour commencer, il faut optimiser la configuration de MariaDB, qui sera concentr\xe9e dans le seul fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/my.cnf.d/server.cnf"),". Par d\xe9faut, la section ",(0,a.kt)("inlineCode",{parentName:"p"},"[server]")," de ce fichier est vide, c'est l\xe0 que doit \xeatre coll\xe9es les lignes suivantes :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nserver-id=1 # SET TO 1 FOR MASTER AND 2 FOR SLAVE\n#read_only\nlog-bin=mysql-bin\nbinlog-do-db=centreon\nbinlog-do-db=centreon_storage\ninnodb_flush_log_at_trx_commit=1\nsync_binlog=1\nbinlog_format=MIXED\nslave_compressed_protocol=1\nslave_parallel_mode=conservative\ndatadir=/var/lib/mysql\npid-file=/var/lib/mysql/mysql.pid\nskip-slave-start\nlog-slave-updates\ngtid_strict_mode=ON\nexpire_logs_days=7\nignore-db-dir=lost+found                       \n\n# Tuning standard Centreon\ninnodb_file_per_table=1\nopen_files_limit=32000\nkey_buffer_size=256M\nsort_buffer_size=32M\njoin_buffer_size=4M\nthread_cache_size=64\nread_buffer_size=512K\nread_rnd_buffer_size=256K\nmax_allowed_packet=64M\n# Uncomment for 4 Go Ram\n#innodb_buffer_pool_size=512M\n# Uncomment for 8 Go Ram\n#innodb_buffer_pool_size=1G\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("p",null,"Pour commencer, il faut am\xe9liorer la configuration de MariaDB, qui sera concentr\xe9e dans le seul fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/mysql/mariadb.conf.d/50-server.cnf"),". Par d\xe9faut, la section ",(0,a.kt)("inlineCode",{parentName:"p"},"[server]")," de ce fichier est vide, c'est l\xe0 que doit \xeatre coll\xe9es les lignes suivantes :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nserver-id=1 # SET TO 1 FOR MASTER AND 2 FOR SLAVE\n#read_only\nlog-bin=mysql-bin\nbinlog-do-db=centreon\nbinlog-do-db=centreon_storage\ninnodb_flush_log_at_trx_commit=1\nsync_binlog=1\nbinlog_format=MIXED\nslave_compressed_protocol=1\nslave_parallel_mode=conservative\ndatadir=/var/lib/mysql\npid-file=/run/mysqld/mysql.pid\nskip-slave-start\nlog-slave-updates\ngtid_strict_mode=ON\nexpire_logs_days=7\nignore-db-dir=lost+found\n\n# Tuning standard Centreon\ninnodb_file_per_table=1\nopen_files_limit=32000\nkey_buffer_size=256M\nsort_buffer_size=32M\njoin_buffer_size=4M\nthread_cache_size=64\nread_buffer_size=512K\nread_rnd_buffer_size=256K\nmax_allowed_packet=64M\n# Uncomment for 4 Go Ram\n#innodb_buffer_pool_size=512M\n# Uncomment for 8 Go Ram\n#innodb_buffer_pool_size=1G\n")),(0,a.kt)("p",null,"De plus, commentez la ligne :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"#bind-address            = 127.0.0.1\n")))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"Important :")," la valeur de ",(0,a.kt)("inlineCode",{parentName:"p"},"server-id")," doit \xeatre diff\xe9rente d'un serveur \xe0 l'autre, pour qu'ils puissent s'identifier correctement. Les valeurs 1 => Master et 2 => Slave ne sont pas obligatoires, mais sont recommand\xe9es.")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"NB :")," Ne pas oublier de d\xe9commenter (supprimer le '#' en d\xe9but de ligne) le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"innodb_buffer_pool_size")," qui correspond \xe0 votre plateforme."),(0,a.kt)("p",null,"Pour que ces modifications soient bien prises en compte, il faut red\xe9marrer le serveur de base de donn\xe9es :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart mariadb\n")),(0,a.kt)("p",null,"Bien s'assurer que le red\xe9marrage s'est bien d\xe9roul\xe9 avec la commande suivante :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl status mariadb\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"Avertissement :")," Le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.cnf")," ne sera plus pris en compte, si des param\xe8tres y ont \xe9t\xe9 personnalis\xe9s, il faut les reporter dans ",(0,a.kt)("inlineCode",{parentName:"p"},"server.cnf"),".")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"Attention:")," N'oubliez pas de modifier le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"Chemin d'acc\xe8s au fichier de configuration MySQL")," in ",(0,a.kt)("strong",{parentName:"p"},"Administration > Param\xe8tres > Backup"))),(0,a.kt)("h3",{id:"s\xe9curisation-de-la-base-de-donn\xe9es"},"S\xe9curisation de la base de donn\xe9es"),(0,a.kt)("p",null,"L'acc\xe8s aux bases de donn\xe9es doit \xeatre limit\xe9 de la fa\xe7on la plus stricte possible. La commande ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql_secure_installation")," permet de supprimer les acc\xe8s non prot\xe9g\xe9s par des mots de passe et la base de donn\xe9es de test. Lancer cette commande et se laisser guider par les choix par d\xe9faut. Attention \xe0 choisir un mot de passe n'appartenant \xe0 aucun dictionnaire."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mysql_secure_installation\n")),(0,a.kt)("h3",{id:"cr\xe9ation-du-compte-centreon"},"Cr\xe9ation du compte centreon"),(0,a.kt)("p",null,"Pour pouvoir administrer les utilisateurs MariaDB, il faut d'abord se connecter en tant que root (avec le mot de passe saisi au paragraphe pr\xe9c\xe9dent) :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"mysql -p\n")),(0,a.kt)("p",null,"Coller alors dans le prompt MariaDB les commandes ci-dessous en modifiant les adresses IP ainsi que les mots de passe."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER '@MARIADB_CENTREON_USER@'@'@DATABASE_SLAVE_IPADDR@' IDENTIFIED BY '@MARIADB_CENTREON_PASSWD@';\nGRANT ALL PRIVILEGES ON centreon.* TO '@MARIADB_CENTREON_USER@'@'@DATABASE_SLAVE_IPADDR@';\nGRANT ALL PRIVILEGES ON centreon_storage.* TO '@MARIADB_CENTREON_USER@'@'@DATABASE_SLAVE_IPADDR@';\n\nCREATE USER '@MARIADB_CENTREON_USER@'@'@DATABASE_MASTER_IPADDR@' IDENTIFIED BY '@MARIADB_CENTREON_PASSWD@';\nGRANT ALL PRIVILEGES ON centreon.* TO '@MARIADB_CENTREON_USER@'@'@DATABASE_MASTER_IPADDR@';\nGRANT ALL PRIVILEGES ON centreon_storage.* TO '@MARIADB_CENTREON_USER@'@'@DATABASE_MASTER_IPADDR@';\n")),(0,a.kt)("p",null,"Optionnellement, et pour que les scripts d'administration fonctionnent sur l'ensemble des n\u0153uds du Cluster (Centraux Web inclus), les utilisateurs suivants:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER '@MARIADB_CENTREON_USER@'@'@CENTRAL_SLAVE_IPADDR@' IDENTIFIED BY '@MARIADB_CENTREON_PASSWD@';\nGRANT ALL PRIVILEGES ON centreon.* TO '@MARIADB_CENTREON_USER@'@'@CENTRAL_SLAVE_IPADDR@';\nGRANT ALL PRIVILEGES ON centreon_storage.* TO '@MARIADB_CENTREON_USER@'@'@CENTRAL_SLAVE_IPADDR@';\n\nCREATE USER '@MARIADB_CENTREON_USER@'@'@CENTRAL_MASTER_IPADDR@' IDENTIFIED BY '@MARIADB_CENTREON_PASSWD@';\nGRANT ALL PRIVILEGES ON centreon.* TO '@MARIADB_CENTREON_USER@'@'@CENTRAL_MASTER_IPADDR@';\nGRANT ALL PRIVILEGES ON centreon_storage.* TO '@MARIADB_CENTREON_USER@'@'@CENTRAL_MASTER_IPADDR@';\n")),(0,a.kt)("p",null,"Lors d'un upgrade de centreon-ha depuis une plateforme Centreon ou un d\xe9ploiement de VM via OVA/OVF, mettre \xe0 jour le mot de passe ",(0,a.kt)("inlineCode",{parentName:"p"},"'@MARIADB_CENTREON_USER@'@'localhost'"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"ALTER USER '@MARIADB_CENTREON_USER@'@'localhost' IDENTIFIED BY '@MARIADB_CENTREON_PASSWD@';\n")),(0,a.kt)("h3",{id:"cr\xe9ation-du-compte-de-r\xe9plication"},"Cr\xe9ation du compte de r\xe9plication"),(0,a.kt)("p",null,"Toujours dans le prompt MariaDB (cf paragraphe pr\xe9c\xe9dent) cr\xe9er l'utilisateur ",(0,a.kt)("inlineCode",{parentName:"p"},"@MARIADB_REPL_USER@"),", d\xe9di\xe9 \xe0 la r\xe9plication, \xe0 l'aide des commandes suivantes :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT SHUTDOWN, PROCESS, RELOAD, SUPER, SELECT, REPLICATION CLIENT, REPLICATION SLAVE ON *.* \nTO '@MARIADB_REPL_USER@'@'localhost' IDENTIFIED BY '@MARIADB_REPL_PASSWD@';\n\nGRANT SHUTDOWN, PROCESS, RELOAD, SUPER, SELECT, REPLICATION CLIENT, REPLICATION SLAVE ON *.* \nTO '@MARIADB_REPL_USER@'@'@DATABASE_SLAVE_IPADDR@' IDENTIFIED BY '@MARIADB_REPL_PASSWD@';\n\nGRANT SHUTDOWN, PROCESS, RELOAD, SUPER, SELECT, REPLICATION CLIENT, REPLICATION SLAVE ON *.* \nTO '@MARIADB_REPL_USER@'@'@DATABASE_MASTER_IPADDR@' IDENTIFIED BY '@MARIADB_REPL_PASSWD@';\n")),(0,a.kt)("p",null,"Optionnellement, et pour que les scripts d'administration fonctionnent sur l'ensemble des n\u0153uds du Cluster (Centraux Web inclus), les utilisateurs suivants:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT SHUTDOWN, PROCESS, RELOAD, SUPER, SELECT, REPLICATION CLIENT, REPLICATION SLAVE ON *.* \nTO '@MARIADB_REPL_USER@'@'@CENTRAL_SLAVE_IPADDR@' IDENTIFIED BY '@MARIADB_REPL_PASSWD@';\n\nGRANT SHUTDOWN, PROCESS, RELOAD, SUPER, SELECT, REPLICATION CLIENT, REPLICATION SLAVE ON *.* \nTO '@MARIADB_REPL_USER@'@'@CENTRAL_MASTER_IPADDR@' IDENTIFIED BY '@MARIADB_REPL_PASSWD@';\n")),(0,a.kt)("h3",{id:"configuration-des-variables-denvironnement-des-scripts-mariadb"},"Configuration des variables d'environnement des scripts MariaDB"),(0,a.kt)("p",null,"Le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/centreon-ha/mysql-resources.sh")," contient des variables d'environnement qu'il faut adapter \xe0 l'installation courante en rempla\xe7ant les macros par la valeur qui convient."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\n###############################\n# Database access credentials #\n###############################\n\nDBHOSTNAMEMASTER='@DATABASE_MASTER_NAME@'\nDBHOSTNAMESLAVE='@DATABASE_SLAVE_NAME@'\nDBREPLUSER='@MARIADB_REPL_USER@'\nDBREPLPASSWORD='@MARIADB_REPL_PASSWD@'\nDBROOTUSER='@MARIADB_REPL_USER@'\nDBROOTPASSWORD='@MARIADB_REPL_PASSWD@'\nCENTREON_DB='centreon'\nCENTREON_STORAGE_DB='centreon_storage'\n\n###############################\n")),(0,a.kt)("p",null,"Pour s'assurer que les derni\xe8res \xe9tapes ont \xe9t\xe9 effectu\xe9es correctement, et que les bons noms, logins et mots de passe ont bien \xe9t\xe9 saisis dans le fichier de configuration, il faut lancer la commande depuis un serveur database (ou depuis n'importe quel serveur si vous avez ajout\xe9 les comptes optionnels) :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"Le r\xe9sultat attendu est :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection MASTER Status '@DATABASE_MASTER_NAME@' [OK]\nConnection SLAVE Status '@DATABASE_SLAVE_NAME@' [OK]\nSlave Thread Status [KO]\nError reports:\n    No slave (maybe because we cannot check a server).\nPosition Status [SKIP]\n!Error reports:\n    Skip because we can't identify a unique slave.\n")),(0,a.kt)("p",null,"Ce qu'il est important de v\xe9rifier est que les deux premiers tests de connexion sont ",(0,a.kt)("inlineCode",{parentName:"p"},"OK"),"."),(0,a.kt)("h3",{id:"passage-en-read-only"},"Passage en read-only"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("p",null,"Maintenant, que tout est bien configur\xe9, il faut activer le mode ",(0,a.kt)("inlineCode",{parentName:"p"},"read_only")," sur les deux serveurs en d\xe9commentant (",(0,a.kt)("em",{parentName:"p"},"ie.")," retirer le ",(0,a.kt)("inlineCode",{parentName:"p"},"#")," en d\xe9but de ligne) cette instruction dans le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/my.cnf.d/server.cnf")," :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"N\u0153ud de bases de donn\xe9es principal")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nserver-id=1\nread_only\nlog-bin=mysql-bin\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"N\u0153ud de bases de donn\xe9es secondaire")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nserver-id=2\nread_only\nlog-bin=mysql-bin\n")),(0,a.kt)("p",null,"Appliquer ensuite ce changement par un red\xe9marrage de MariaDB sur les deux n\u0153uds :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart mariadb\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("p",null,"Maintenant, que tout est bien configur\xe9, il faut activer le mode ",(0,a.kt)("inlineCode",{parentName:"p"},"read_only")," sur les deux serveurs en d\xe9commentant (",(0,a.kt)("em",{parentName:"p"},"ie.")," retirer le ",(0,a.kt)("inlineCode",{parentName:"p"},"#")," en d\xe9but de ligne) cette instruction dans le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/mysql/mariadb.conf.d/50-server.cnf")," :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"N\u0153ud principal")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nserver-id=1\nread_only\nlog-bin=mysql-bin\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"N\u0153ud secondaire")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nserver-id=2\nread_only\nlog-bin=mysql-bin\n")),(0,a.kt)("p",null,"Appliquer ensuite ce changement par un red\xe9marrage de MariaDB sur les deux n\u0153uds :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart mariadb\n")))),(0,a.kt)("h3",{id:"synchroniser-les-bases-et-lancer-la-r\xe9plication-mariadb"},"Synchroniser les bases et lancer la r\xe9plication MariaDB"),(0,a.kt)("p",null,"Pour synchroniser les bases, arr\xeater le service ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," sur le n\u0153ud de bases de donn\xe9es secondaire pour \xe9craser ses donn\xe9es avec celles du serveur principal."),(0,a.kt)("p",null,"Il faut donc lancer la commande suivante sur ",(0,a.kt)("strong",{parentName:"p"},"le n\u0153ud de bases de donn\xe9es secondaire")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop mariadb\n")),(0,a.kt)("p",null,"Dans certains cas, il se peut que systemd ne parvienne pas \xe0 arr\xeater le service ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),", pour s'en assurer, v\xe9rifier que la commande suivante ne retourne aucune ligne :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ps -ef | grep mariadb[d]\n")),(0,a.kt)("p",null,"Si un processus ",(0,a.kt)("inlineCode",{parentName:"p"},"mysqld")," est toujours en activit\xe9, alors il faut lancer la commande suivante pour l'arr\xeater (et fournir le mot de passe du compte root de mysql quand il est demand\xe9) :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mysqladmin -p shutdown\n")),(0,a.kt)("p",null,"Une fois que le service est bien arr\xeat\xe9 sur ",(0,a.kt)("strong",{parentName:"p"},"le n\u0153ud de bases de donn\xe9es secondaire"),", lancer le script de synchronisation ",(0,a.kt)("strong",{parentName:"p"},"depuis le n\u0153ud de bases de donn\xe9es principal")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-sync-bigdb.sh\n")),(0,a.kt)("p",null,"Ce script effectue les op\xe9rations suivantes :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"v\xe9rifier que mysql est arr\xeat\xe9 sur le n\u0153ud secondaire"),(0,a.kt)("li",{parentName:"ul"},"arr\xeater mysql sur le n\u0153ud principal"),(0,a.kt)("li",{parentName:"ul"},"monter un snapshot LVM sur le ",(0,a.kt)("em",{parentName:"li"},"volume group")," qui supporte la partition /var/lib/mysql"),(0,a.kt)("li",{parentName:"ul"},"d\xe9marrer mysql sur le n\u0153ud principal"),(0,a.kt)("li",{parentName:"ul"},"m\xe9moriser la position courante dans les logs binaires"),(0,a.kt)("li",{parentName:"ul"},"d\xe9sactiver la variable globale MariaDB ",(0,a.kt)("inlineCode",{parentName:"li"},"read_only")," sur le n\u0153ud principal (",(0,a.kt)("em",{parentName:"li"},"ie.")," le n\u0153ud principal est maintenant autoris\xe9 \xe0 \xe9crire dans sa base)"),(0,a.kt)("li",{parentName:"ul"},"synchroniser tous les fichiers de donn\xe9es (hors base syst\xe8me ",(0,a.kt)("inlineCode",{parentName:"li"},"mysql"),") en \xe9crasant les fichiers du n\u0153ud secondaire"),(0,a.kt)("li",{parentName:"ul"},"d\xe9monter le snapshot LVM"),(0,a.kt)("li",{parentName:"ul"},"cr\xe9er le thread de r\xe9plication qui va maintenir les donn\xe9es \xe0 jour sur le n\u0153ud secondaire")),(0,a.kt)("p",null,"Ce script est tr\xe8s verbeux, et tout ce qui s'affiche n'est pas forc\xe9ment compr\xe9hensible, mais pour s'assurer qu'il s'est bien d\xe9roul\xe9 jusqu'au bout, il suffit de s'assurer que la fin ressemble bien \xe0 :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},'Umount and Delete LVM snapshot\n  Logical volume "dbbackupdatadir" successfully removed\nStart MySQL Slave\nStart Replication\nId User Host db Command Time State Info Progress\n[nombre variable de lignes]\n')),(0,a.kt)("p",null,"Ce qu'il est important de v\xe9rifier est que les lignes ",(0,a.kt)("inlineCode",{parentName:"p"},"Start MySQL Slave")," et ",(0,a.kt)("inlineCode",{parentName:"p"},"Start Replication")," ne soient suivies d'aucune erreur."),(0,a.kt)("p",null,"Si tout s'est bien pass\xe9, alors la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql-check-status.sh")," doit renvoyer un r\xe9sultat sans erreurs :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"R\xe9sultat attendu :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection MASTER Status '@DATABASE_MASTER_NAME@' [OK]\nConnection SLAVE Status '@DATABASE_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("h2",{id:"mise-en-place-du-cluster-centreon"},"Mise en place du cluster Centreon"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Informations :")," Ces op\xe9rations sont \xe0 r\xe9alis\xe9es sur les noeuds ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," et ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@")),(0,a.kt)("h3",{id:"configuration-du-service-de-synchronisation"},"Configuration du service de synchronisation"),(0,a.kt)("p",null,"Le service de synchronisation ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon-central-sync")," n\xe9cessite que l'on d\xe9finisse pour chaque n\u0153ud dans ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/centreon-ha/centreon_central_sync.pm")," l'adresse IP de son correspondant :"),(0,a.kt)("p",null,"Ainsi pour le serveur ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," on doit avoir :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-perl"},'our %centreon_central_sync_config = (\n    peer_addr => "@CENTRAL_SLAVE_IPADDR@"\n);\n1;\n')),(0,a.kt)("p",null,"Et pour le serveur ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@")," on doit avoir :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-perl"},'our %centreon_central_sync_config = (\n    peer_addr => "@CENTRAL_MASTER_IPADDR@"\n);\n1;\n')),(0,a.kt)("h3",{id:"suppression-des-crons"},"Suppression des crons"),(0,a.kt)("p",null,"Les t\xe2ches planifi\xe9es de type ",(0,a.kt)("strong",{parentName:"p"},"cron")," sont ex\xe9cut\xe9es directement par le processus gorgone dans les architectures hautement disponibles. Cela permet de garantir la non-concurrence de leur ex\xe9cution sur les n\u0153uds centraux. Il est donc n\xe9cessaire de les supprimer manuellement :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rm -f /etc/cron.d/centreon\nrm -f /etc/cron.d/centstorage\nrm -f /etc/cron.d/centreon-auto-disco\nrm -f /etc/cron.d/centreon-ha-mysql\n")),(0,a.kt)("h3",{id:"modification-des-droits"},"Modification des droits"),(0,a.kt)("p",null,"Les r\xe9pertoires /var/log/centreon-engine et /tmp/centreon-autodisco sont partag\xe9s entre plusieurs processus. Il est n\xe9cessaire\nde modifier les droits des r\xe9pertoires et fichiers pour garantir le bon fonctionnement de la r\xe9plication de fichiers et de la\nd\xe9couverte automatique des services :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"R\xe9plication des fichiers")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'chmod 775 /var/log/centreon-engine/\nmkdir /var/log/centreon-engine/archives\nchown centreon-engine: /var/log/centreon-engine/archives\nchmod 775 /var/log/centreon-engine/archives/\nfind /var/log/centreon-engine/ -type f -exec chmod 664 {} \\;\nfind /usr/share/centreon/www/img/media -type d -exec chmod 775 {} \\;\nfind /usr/share/centreon/www/img/media -type f \\( ! -iname ".keep" ! -iname ".htaccess" \\) -exec chmod 664 {} \\;\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"D\xe9couverte des services")),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /tmp/centreon-autodisco/\nchown apache: /tmp/centreon-autodisco/\nchmod 775 /tmp/centreon-autodisco/\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /tmp/centreon-autodisco/\nchown www-data: /tmp/centreon-autodisco/\nchmod 775 /tmp/centreon-autodisco/\n")))),(0,a.kt)("h3",{id:"arr\xeat-et-d\xe9sactivation-des-services"},"Arr\xeat et d\xe9sactivation des services"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Informations :")," Ces op\xe9rations sont \xe0 r\xe9aliser sur l'ensemble des n\u0153uds ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"@DATABASE_MASTER_NAME@")," et ",(0,a.kt)("inlineCode",{parentName:"p"},"@DATABASE_SLAVE_NAME@"),". Centreon est install\xe9 par d\xe9pendances du paquet centreon-ha sur les n\u0153uds de bases de donn\xe9es, cela n'a pas d'incidences  sur le fonctionnement."),(0,a.kt)("p",null,"Les services applicatifs de Centreon ne seront plus lanc\xe9s au d\xe9marrage du serveur comme c'est le cas pour une installation standard, ce sont les services de clustering qui s'en chargeront. Il faut donc arr\xeater et d\xe9sactiver ces services."),(0,a.kt)("p",null,"For ",(0,a.kt)("strong",{parentName:"p"},"Central nodes")),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop centengine snmptrapd centreontrapd gorgoned cbd httpd php-fpm centreon\nsystemctl disable centengine snmptrapd centreontrapd gorgoned cbd httpd php-fpm centreon\n"))),(0,a.kt)(s.Z,{value:"Debian 11 ",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop centengine snmptrapd centreontrapd gorgoned cbd apache2 php8.1-fpm centreon \nsystemctl disable centengine snmptrapd centreontrapd gorgoned cbd apache2 php8.1-fpm centreon \n")))),(0,a.kt)("p",null,"And for ",(0,a.kt)("strong",{parentName:"p"},"Database nodes")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop mariadb\nsystemctl disable mariadb\n")),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("p",null,"Le service MariaDB \xe9tant sur un mode mixte entre SysV init et systemd, pour bien s'assurer qu'il ne soit plus lanc\xe9 au d\xe9marrage, il faut \xe9galement lancer la commande :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chkconfig mysql off\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("p",null,"Le service MariaDB \xe9tant sur un mode mixte entre SysV init et systemd, pour bien s'assurer qu'il ne soit plus lanc\xe9 au d\xe9marrage, il faut \xe9galement lancer la commande :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"update-rc.d -f mariadb remove\n")))),(0,a.kt)("h3",{id:"cr\xe9ation-du-cluster"},"Cr\xe9ation du cluster"),(0,a.kt)("h4",{id:"activation-des-services-de-clustering"},"Activation des services de clustering"),(0,a.kt)("p",null,"Pour commencer, d\xe9marrer le service pcsd sur l'ensemble des n\u0153uds :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl start pcsd\n")),(0,a.kt)("h4",{id:"pr\xe9paration-du-serveur-qui-jouera-le-r\xf4le-de-quorum-device"},"Pr\xe9paration du serveur qui jouera le r\xf4le de ",(0,a.kt)("em",{parentName:"h4"},"Quorum Device")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Informations :")," Cette op\xe9ration doit \xeatre r\xe9alis\xe9e sur le serveur ",(0,a.kt)("inlineCode",{parentName:"p"},"@QDEVICE_NAME@")),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma Linux 8",label:"Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ha\ndnf install pcs corosync-qnetd\nsystemctl start pcsd.service\nsystemctl enable pcsd.service\npcs qdevice setup model net --enable --start\npcs qdevice status net --full\n"))),(0,a.kt)(s.Z,{value:"RHEL 8",label:"RHEL 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf -y install dnf-plugins-core https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm\nsubscription-manager repos --enable rhel-8-for-x86_64-highavailability-rpms\ndnf install pcs corosync-qnetd\nsystemctl start pcsd.service\nsystemctl enable pcsd.service\npcs qdevice setup model net --enable --start\npcs qdevice status net --full\n"))),(0,a.kt)(s.Z,{value:"Oracle Linux 8",label:"Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ol8_addons\ndnf install pcs corosync-qnetd\nsystemctl start pcsd.service\nsystemctl enable pcsd.service\npcs qdevice setup model net --enable --start\npcs qdevice status net --full\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"apt install pcs corosync-qnetd\nsystemctl start pcsd.service\nsystemctl enable pcsd.service\npcs qdevice setup model net --enable --start\npcs qdevice status net --full\n")))),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("p",null,"Modifier le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"COROSYNC_QNETD_OPTIONS")," du fichier de configuration ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/sysconfig/corosync-qnetd")," du Quorum afin de restreindre les connexions entrant \xe0 IPv4."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'COROSYNC_QNETD_OPTIONS="-4"\n'))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("p",null,"Modifier le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"COROSYNC_QNETD_OPTIONS")," du fichier de configuration ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/default/corosync-qnetd")," du Quorum afin de restreindre les connexions entrant \xe0 IPv4."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'COROSYNC_QNETD_OPTIONS="-4"\n')))),(0,a.kt)("h4",{id:"authentification-aupr\xe8s-des-membres-du-cluster"},"Authentification aupr\xe8s des membres du cluster"),(0,a.kt)("p",null,"Par mesure de simplicit\xe9, nous allons d\xe9finir le m\xeame mot de passe pour le compte ",(0,a.kt)("inlineCode",{parentName:"p"},"hacluster")," sur l'ensemble des n\u0153uds ",(0,a.kt)("inlineCode",{parentName:"p"},"@QDEVICE_NAME@")," inclus:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"passwd hacluster\n")),(0,a.kt)("p",null,"Une fois ce mot de passe commun d\xe9fini, il est possible pour un n\u0153ud de s'authentifier sur les autres. ",(0,a.kt)("strong",{parentName:"p"},"La commande suivante ainsi que toutes les commandes agissant sur le cluster doivent \xeatre lanc\xe9e sur un seul n\u0153ud.")),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs host auth \\\n    "@CENTRAL_MASTER_NAME@" \\\n    "@CENTRAL_SLAVE_NAME@" \\\n    "@DATABASE_MASTER_NAME@" \\\n    "@DATABASE_SLAVE_NAME@" \\\n    "@QDEVICE_NAME@" \\\n    -u "hacluster" \\\n    -p \'@CENTREON_CLUSTER_PASSWD@\'\n'))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("p",null,"Sur Debian, le cluster est autoconfigur\xe9 avec des valeurs par d\xe9faut. Afin d'installer notre cluster, nous devons d\xe9truire se pr\xe9param\xe9trage avec cette commande :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs cluster destroy\n")),(0,a.kt)("p",null,"Puis vous pouvez lancer l'authentification du cluster :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs host auth \\\n    "@CENTRAL_MASTER_NAME@" \\\n    "@CENTRAL_SLAVE_NAME@" \\\n    "@DATABASE_MASTER_NAME@" \\\n    "@DATABASE_SLAVE_NAME@" \\\n    "@QDEVICE_NAME@" \\\n    -u "hacluster" \\\n    -p \'@CENTREON_CLUSTER_PASSWD@\'\n')))),(0,a.kt)("h4",{id:"cr\xe9ation-du-cluster-1"},"Cr\xe9ation du cluster"),(0,a.kt)("p",null,"Cette commande doit \xeatre lanc\xe9e sur un des n\u0153uds :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs cluster setup \\\n    centreon_cluster \\\n    "@CENTRAL_MASTER_NAME@" \\\n    "@CENTRAL_SLAVE_NAME@" \\\n    "@DATABASE_MASTER_NAME@" \\\n    "@DATABASE_SLAVE_NAME@" \\\n    --force\n'))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs cluster setup \\\n    centreon_cluster \\\n    "@CENTRAL_MASTER_NAME@" \\\n    "@CENTRAL_SLAVE_NAME@" \\\n    "@DATABASE_MASTER_NAME@" \\\n    "@DATABASE_SLAVE_NAME@" \\\n    --force\n')))),(0,a.kt)("p",null,"D\xe9marrer ensuite ",(0,a.kt)("inlineCode",{parentName:"p"},"pacemaker")," sur l'ensemble des n\u0153uds :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable pacemaker pcsd corosync\nsystemctl start pacemaker\n")),(0,a.kt)("p",null,"Puis d\xe9finir les propri\xe9t\xe9s par d\xe9faut sur un des n\u0153uds :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs property set symmetric-cluster="true"\npcs property set stonith-enabled="false"\npcs resource defaults resource-stickiness="100"\n')),(0,a.kt)("p",null,"L'\xe9tat du cluster peut \xeatre suivi en temps r\xe9el avec la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -f"),", qui vous permettra de voir appara\xeetre les nouvelles ressources au fur et \xe0 mesure."),(0,a.kt)("h4",{id:"ajout-du-quorum-device"},"Ajout du ",(0,a.kt)("em",{parentName:"h4"},"Quorum Device")),(0,a.kt)("p",null,"Cette commande est lanc\xe9e depuis un seul n\u0153ud, le Cluster va automatiquement r\xe9pliquer la configuration sur les autres :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs quorum device add model net \\\n    host="@QDEVICE_NAME@" \\\n    algorithm="ffsplit"\n')),(0,a.kt)("h3",{id:"cr\xe9ation-des-ressources-mariadb"},"Cr\xe9ation des ressources MariaDB"),(0,a.kt)("p",null,"Les commandes de cette section doivent \xeatre lanc\xe9es depuis un seul n\u0153ud, le Cluster va automatiquement r\xe9pliquer la configuration sur les autres."),(0,a.kt)("h4",{id:"process-mariadb-primairesecondaire"},"Process MariaDB Primaire/secondaire"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create "ms_mysql" \\\n    ocf:heartbeat:mariadb-centreon \\\n    config="/etc/my.cnf.d/server.cnf" \\\n    pid="/var/lib/mysql/mysql.pid" \\\n    datadir="/var/lib/mysql" \\\n    socket="/var/lib/mysql/mysql.sock" \\\n    binary="/usr/bin/mysqld_safe" \\\n    node_list="@DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@" \\\n    replication_user="@MARIADB_REPL_USER@" \\\n    replication_passwd=\'@MARIADB_REPL_PASSWD@\' \\\n    test_user="@MARIADB_REPL_USER@" \\\n    test_passwd="@MARIADB_REPL_PASSWD@" \\\n    test_table=\'centreon.host\'\n'))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create "ms_mysql" \\\n    ocf:heartbeat:mariadb-centreon \\\n    config="/etc/mysql/mariadb.conf.d/50-server.cnf" \\\n    pid="/run/mysqld/mysqld.pid" \\\n    datadir="/var/lib/mysql" \\\n    socket="/run/mysqld/mysqld.sock" \\\n    binary="/usr/bin/mysqld_safe" \\\n    node_list="@CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@" \\\n    replication_user="@MARIADB_REPL_USER@" \\\n    replication_passwd=\'@MARIADB_REPL_PASSWD@\' \\\n    test_user="@MARIADB_REPL_USER@" \\\n    test_passwd="@MARIADB_REPL_PASSWD@" \\\n    test_table=\'centreon.host\'\n')))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"ATTENTION :")," la commande suivante varie suivant la distribution Linux utilis\xe9e.")),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource promotable ms_mysql \\\n    master-node-max="1" \\\n    clone_max="2" \\\n    globally-unique="false" \\\n    clone-node-max="1" \\\n    notify="true"\n'))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource promotable ms_mysql \\\n    master-node-max="1" \\\n    clone_max="2" \\\n    globally-unique="false" \\\n    clone-node-max="1" \\\n    notify="true"\n')))),(0,a.kt)("h5",{id:"adresse-vip-serveurs-bases-de-donn\xe9es"},"Adresse VIP Serveurs bases de donn\xe9es"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create vip_mysql \\\n    ocf:heartbeat:IPaddr2 \\\n    ip="@VIP_SQL_IPADDR@" \\\n    nic="@VIP_SQL_IFNAME@" \\\n    cidr_netmask="@VIP_SQL_CIDR_NETMASK@" \\\n    broadcast="@VIP_SQL_BROADCAST_IPADDR@" \\\n    flush_routes="true" \\\n    meta target-role="stopped" \\\n    op start interval="0s" timeout="20s" \\\n    stop interval="0s" timeout="20s" \\\n    monitor interval="10s" timeout="20s"\n')),(0,a.kt)("h3",{id:"cr\xe9ation-des-ressources-clones"},"Cr\xe9ation des ressources clones"),(0,a.kt)("p",null,"Les ressources clones sont des ressources actives sur les deux n\u0153uds Centraux."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"Avertissement :")," Toutes les commandes qui suivent ne doivent \xeatre lanc\xe9es que sur un seul des n\u0153uds.")),(0,a.kt)("h4",{id:"php8"},"PHP8"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create "php" \\\n    systemd:php-fpm \\\n    meta target-role="started" \\\n    op start interval="0s" timeout="30s" \\\n    stop interval="0s" timeout="30s" \\\n    monitor interval="5s" timeout="30s" \\\n    clone\n'))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create "php" \\\n    systemd:php8.1-fpm \\\n    meta target-role="started" \\\n    op start interval="0s" timeout="30s" \\\n    stop interval="0s" timeout="30s" \\\n    monitor interval="5s" timeout="30s" \\\n    clone\n')))),(0,a.kt)("h4",{id:"broker-rrd"},"Broker RRD"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create "cbd_rrd" \\\n    systemd:cbd \\\n    meta target-role="stopped" \\\n    op start interval="0s" timeout="90s" \\\n    stop interval="0s" timeout="90s" \\\n    monitor interval="20s" timeout="30s" \\\n    clone\n')),(0,a.kt)("h3",{id:"cr\xe9ation-du-groupe-de-ressources-centreon"},"Cr\xe9ation du groupe de ressources Centreon"),(0,a.kt)("h4",{id:"adresse-vip-serveurs-centraux"},"Adresse VIP Serveurs Centraux"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create vip \\\n    ocf:heartbeat:IPaddr2 \\\n    ip="@VIP_IPADDR@" \\\n    nic="@VIP_IFNAME@" \\\n    cidr_netmask="@VIP_CIDR_NETMASK@" \\\n    broadcast="@VIP_BROADCAST_IPADDR@" \\\n    flush_routes="true" \\\n    meta target-role="stopped" \\\n    op start interval="0s" timeout="20s" \\\n    stop interval="0s" timeout="20s" \\\n    monitor interval="10s" timeout="20s" \\\n    --group centreon\n')),(0,a.kt)("h4",{id:"service-httpd"},"Service httpd"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create http \\\n    systemd:httpd \\\n    meta target-role="started" \\\n    op start interval="0s" timeout="40s" \\\n    stop interval="0s" timeout="40s" \\\n    monitor interval="5s" timeout="20s" \\\n    --group centreon \\\n    --force\n'))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create http \\\n    systemd:apache2 \\\n    meta target-role="started" \\\n    op start interval="0s" timeout="40s" \\\n    stop interval="0s" timeout="40s" \\\n    monitor interval="5s" timeout="20s" \\\n    --group centreon \\\n    --force\n')))),(0,a.kt)("h4",{id:"service-gorgone"},"Service Gorgone"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create gorgone \\\n    systemd:gorgoned \\\n    meta target-role="stopped" \\\n    op start interval="0s" timeout="90s" \\\n    stop interval="0s" timeout="90s" \\\n    monitor interval="5s" timeout="20s" \\\n    --group centreon\n')),(0,a.kt)("h4",{id:"service-centreon-central-sync"},"Service centreon-central-sync"),(0,a.kt)("p",null,"Ce service est sp\xe9cifique \xe0 ",(0,a.kt)("em",{parentName:"p"},"Centreon HA"),". Sa fonction est de r\xe9pliquer les changements de configuration, l'ajout d'images via l'interface, etc."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create centreon_central_sync \\\n    systemd:centreon-central-sync \\\n    meta target-role="stopped" \\\n    op start interval="0s" timeout="90s" \\\n    stop interval="0s" timeout="90s" \\\n    monitor interval="5s" timeout="20s" \\\n    --group centreon\n')),(0,a.kt)("h4",{id:"broker-sql"},"Broker SQL"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create cbd_central_broker \\\n    systemd:cbd-sql \\\n    meta target-role="stopped" \\\n    op start interval="0s" timeout="90s" \\\n    stop interval="0s" timeout="90s" \\\n    monitor interval="5s" timeout="30s" \\\n    --group centreon\n')),(0,a.kt)("h4",{id:"service-centengine"},"Service centengine"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create centengine \\\n    systemd:centengine \\\n    meta multiple-active="stop_start" target-role="stopped" \\\n    op start interval="0s" timeout="90s" stop interval="0s" timeout="90s" \\\n    monitor interval="5s" timeout="30s" \\\n    --group centreon\n')),(0,a.kt)("h4",{id:"service-centreontrapd"},"Service centreontrapd"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create centreontrapd \\\n    systemd:centreontrapd \\\n    meta target-role="stopped" \\\n    op start interval="0s" timeout="30s" \\\n    stop interval="0s" timeout="30s" \\\n    monitor interval="5s" timeout="20s" \\\n    --group centreon\n')),(0,a.kt)("h4",{id:"service-snmptrapd"},"Service snmptrapd"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource create snmptrapd \\\n    systemd:snmptrapd \\\n    meta target-role="stopped" \\\n    op start interval="0s" timeout="30s" \\\n    stop interval="0s" timeout="30s" \\\n    monitor interval="5s" timeout="20s" \\\n    --group centreon\n')),(0,a.kt)("h3",{id:"contraintes"},"Contraintes"),(0,a.kt)("p",null,"Dans le cadre d'un Cluster avec bases de donn\xe9es d\xe9port\xe9es, il est n\xe9cessaire de d\xe9finir des contraintes pour sp\xe9cifier sur quels n\u0153uds les ressources doivent \xeatre ex\xe9cut\xe9es."),(0,a.kt)("p",null,"Ex\xe9cuter les commandes suivantes pour indiquer au Cluster que les ressources vip_mysql & le r\xf4le primaire doivent \xeatre d\xe9marr\xe9es sur le m\xeame n\u0153ud :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs constraint colocation add "vip_mysql" with master "ms_mysql-clone"\npcs constraint colocation add master "ms_mysql-clone" with "vip_mysql"\n'))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs constraint colocation add "vip_mysql" with master "ms_mysql-clone"\npcs constraint colocation add master "ms_mysql-clone" with "vip_mysql"\n')))),(0,a.kt)("p",null,"Ex\xe9cuter les commandes suivantes pour indiquer au Cluster sur quels n\u0153uds les ressources doivent \xeatre ex\xe9cut\xe9es :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs constraint location centreon avoids @DATABASE_MASTER_NAME@=INFINITY @DATABASE_SLAVE_NAME@=INFINITY\npcs constraint location ms_mysql-clone avoids @CENTRAL_MASTER_NAME@=INFINITY @CENTRAL_SLAVE_NAME@=INFINITY\npcs constraint location cbd_rrd-clone avoids @DATABASE_MASTER_NAME@=INFINITY @DATABASE_SLAVE_NAME@=INFINITY\npcs constraint location php-clone avoids @DATABASE_MASTER_NAME@=INFINITY @DATABASE_SLAVE_NAME@=INFINITY\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs constraint location centreon avoids @DATABASE_MASTER_NAME@=INFINITY @DATABASE_SLAVE_NAME@=INFINITY\npcs constraint location ms_mysql-clone avoids @CENTRAL_MASTER_NAME@=INFINITY @CENTRAL_SLAVE_NAME@=INFINITY\npcs constraint location cbd_rrd-clone avoids @DATABASE_MASTER_NAME@=INFINITY @DATABASE_SLAVE_NAME@=INFINITY\npcs constraint location php-clone avoids @DATABASE_MASTER_NAME@=INFINITY @DATABASE_SLAVE_NAME@=INFINITY\n")))),(0,a.kt)("h3",{id:"lancement-du-cluster-et-contr\xf4le-de-l\xe9tat-des-ressources"},"Lancement du Cluster et contr\xf4le de l'\xe9tat des ressources"),(0,a.kt)("h4",{id:"activer-les-ressources"},"Activer les ressources"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'pcs resource enable php-clone\npcs resource enable cbd_rrd-clone\npcs resource meta vip target-role="started"\npcs resource meta vip_mysql target-role="started"\npcs resource meta centreontrapd target-role="started"\npcs resource meta snmptrapd target-role="started"\npcs resource meta centengine target-role="started"\npcs resource meta cbd_central_broker target-role="started"\npcs resource meta gorgone target-role="started"\npcs resource meta centreon_central_sync target-role="started"\npcs resource meta http target-role="started"\n')),(0,a.kt)("h3",{id:"contr\xf4le-de-l\xe9tat-du-cluster"},"Contr\xf4le de l'\xe9tat du cluster"),(0,a.kt)("h4",{id:"contr\xf4le-de-l\xe9tat-des-ressources"},"Contr\xf4le de l'\xe9tat des ressources"),(0,a.kt)("p",null,"Il est possible de suivre l'\xe9tat du cluster en temps r\xe9el via la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -f"),". Suite \xe0 l'activation  des ressources, vous devriez obtenir une sortie similaire \xe0 celle-ci:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 22 15:00:13 2021\n  * Last change:  Wed Sep 15 16:26:53 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 4 nodes configured\n  * 21 resource instances configured\n\nNode List:\n  * Online: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nActive Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @DATABASE_MASTER_NAME@ ]\n    * Slaves: [ @DATABASE_SLAVE_NAME@ ]\n  * vip_mysql   (ocf::heartbeat:IPaddr2):        Started @DATABASE_MASTER_NAME@\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.0.5-9.0.1.el8_4.1-ba59be7122) - partition with quorum\n  * Last updated: Wed Sep 22 15:00:13 2021\n  * Last change:  Wed Sep 15 16:26:53 2021 by root via crm_attribute on @CENTRAL_MASTER_NAME@\n  * 4 nodes configured\n  * 21 resource instances configured\n\nNode List:\n  * Online: [ @DATABASE_MASTER_NAME@ @DATABASE_SLAVE_NAME@ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n\nActive Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ @DATABASE_MASTER_NAME@ ]\n    * Slaves: [ @DATABASE_SLAVE_NAME@ ]\n  * vip_mysql   (ocf::heartbeat:IPaddr2):        Started @DATABASE_MASTER_NAME@\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started @CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\n")))),(0,a.kt)("p",null,"Si la ressource ",(0,a.kt)("strong",{parentName:"p"},"centreon_central_sync")," ne veut pas d\xe9marrer, v\xe9rifiez si le dossier ",(0,a.kt)("inlineCode",{parentName:"p"},"/usr/share/centreon-broker/lua")," existe ",(0,a.kt)("strong",{parentName:"p"},"sur les deux noeuds centraux"),"."),(0,a.kt)("p",null,"Si non, vous pouvez le cr\xe9er avec cette commande ",(0,a.kt)("inlineCode",{parentName:"p"},"mkdir -p /usr/share/centreon-broker/lua"),". Puis, lancez un cleanup avec cette commande ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs resource cleanup"),"."),(0,a.kt)("h4",{id:"ressources-d\xe9sactiv\xe9es"},"Ressources d\xe9sactiv\xe9es"),(0,a.kt)("p",null,"Lorsque vous faites un ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -f")," et que vous avez une ressource qui est d\xe9sactiv\xe9e :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"...\n Master/Slave Set: ms_mysql-master [ms_mysql]\n     Masters: [ @DATABASE_MASTER_NAME@ ]\n     Slaves: [ @DATABASE_SLAVE_NAME@ ]\n     Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\nvip_mysql       (ocf::heartbeat:IPaddr2):       Stopped (disabled)\n...\n")),(0,a.kt)("p",null,"Vous devez activer la ressource avec la commande suivante :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource enable @RESSOURCE_NAME@\n")),(0,a.kt)("p",null,"Dans notre cas :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource enable vip_mysql\n")),(0,a.kt)("h4",{id:"contr\xf4ler-la-synchronisation-des-bases"},"Contr\xf4ler la synchronisation des bases"),(0,a.kt)("p",null,"L'\xe9tat de la r\xe9plication MariaDB peut \xeatre v\xe9rifi\xe9 \xe0 n'importe quel moment gr\xe2ce \xe0 la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql-check-status.sh")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"R\xe9sultat attendu :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Connection MASTER Status '@DATABASE_MASTER_NAME@' [OK]\nConnection SLAVE Status '@DATABASE_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("p",null,"Il est possible qu'imm\xe9diatement apr\xe8s l'installation, le thread de r\xe9plication ne soit pas actif. Un red\xe9marrage de la ressource ",(0,a.kt)("inlineCode",{parentName:"p"},"ms_mysql")," doit permettre d'y rem\xe9dier."),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource restart ms_mysql-clone\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource restart ms_mysql-clone\n")))),(0,a.kt)("h4",{id:"contr\xf4le-de-labsence-de-contraintes"},"Contr\xf4le de l'absence de contraintes"),(0,a.kt)("p",null,"En temps normal, seules les contraintes de colocation doivent \xeatre actives sur le cluster. La commande ",(0,a.kt)("inlineCode",{parentName:"p"},"pcs constraint show")," doit retourner :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Location Constraints:\n  Resource: cbd_rrd-clone\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: centreon\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: ms_mysql-clone\n    Disabled on: @CENTRAL_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @CENTRAL_SLAVE_NAME@ (score:-INFINITY)\n  Resource: php-clone\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\nOrdering Constraints:\nColocation Constraints:\n  vip_mysql with ms_mysql-clone (score:INFINITY) (rsc-role:Started) (with-rsc-role:Master)\n  ms_mysql-clone with vip_mysql (score:INFINITY) (rsc-role:Master) (with-rsc-role:Started)\nTicket Constraints:\n"))),(0,a.kt)(s.Z,{value:"Debian 11",label:"Debian 11",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Location Constraints:\n  Resource: cbd_rrd-clone\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: centreon\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\n  Resource: ms_mysql-clone\n    Disabled on: @CENTRAL_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @CENTRAL_SLAVE_NAME@ (score:-INFINITY)\n  Resource: php-clone\n    Disabled on: @DATABASE_MASTER_NAME@ (score:-INFINITY)\n    Disabled on: @DATABASE_SLAVE_NAME@ (score:-INFINITY)\nOrdering Constraints:\nColocation Constraints:\n  vip_mysql with ms_mysql-clone (score:INFINITY) (rsc-role:Started) (with-rsc-role:Master)\n  ms_mysql-clone with vip_mysql (score:INFINITY) (rsc-role:Master) (with-rsc-role:Started)\nTicket Constraints:\n")))),(0,a.kt)("h2",{id:"modifications-des-fichiers-de-configuration-centreon"},"Modifications des fichiers de configuration Centreon"),(0,a.kt)("p",null,"Suite \xe0 la mise en place du cluster et de la ",(0,a.kt)("em",{parentName:"p"},"vip_mysql"),", il est n\xe9cessaire de modifier les outputs du Centreon Broker et 3 fichiers de configuration du Central. Ces \xe9l\xe9ments devront pointer sur la ",(0,a.kt)("em",{parentName:"p"},"vip_mysql")," afin de toujours pointer sur le n\u0153ud actif MariaDB.\nLes 3 fichiers sont :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"/etc/centreon/centreon.conf.php"),(0,a.kt)("li",{parentName:"ul"},"/etc/centreon/conf.pm"),(0,a.kt)("li",{parentName:"ul"},"/etc/centreon/config.d/10-database.yaml\nIl sera n\xe9cessaire modifier l'IP de l'ancien n\u0153ud actif par l'IP de la ",(0,a.kt)("em",{parentName:"li"},"vip_mysql"),".")),(0,a.kt)("h3",{id:"modification-des-outputs-central-broker-master"},"Modification des outputs central-broker-master"),(0,a.kt)("p",null,"La configuration des ",(0,a.kt)("em",{parentName:"p"},"Output")," Broker du central-broker-master se fait \xe0 l'aide du menu ",(0,a.kt)("em",{parentName:"p"},"Configuration  >  Collecteurs  >  Configuration de Centreon Broker"),"."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},'Modifier la sortie "IPv4" en rempla\xe7ant "@DATABASE_MASTER_IPADDR@" par @VIP_SQL_IPADDR@ dans la configuration ',(0,a.kt)("em",{parentName:"li"},"central-broker-master")," :")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Broker Output"),(0,a.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,a.kt)("th",{parentName:"tr",align:null},"Value"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Unified SQL"),(0,a.kt)("td",{parentName:"tr",align:null},"DB host"),(0,a.kt)("td",{parentName:"tr",align:null},"@VIP_SQL_IPADDR@")))),(0,a.kt)("h3",{id:"exporter-la-configuration-1"},"Exporter la configuration"),(0,a.kt)("p",null,'Une fois que les actions des deux pr\xe9c\xe9dents paragraphes ont \xe9t\xe9 r\xe9alis\xe9es, il faut exporter la configuration (3 premi\xe8res cases pour l\'export du collecteur "Central") pour que celle-ci soit effective.'),(0,a.kt)("p",null,"Ces actions uniquement sur le ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," puis les fichiers de configuration de broker doivent \xeatre copi\xe9s vers ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rsync -a /etc/centreon-broker/*json @CENTRAL_SLAVE_IPADDR@:/etc/centreon-broker/\n")),(0,a.kt)("h3",{id:"modification-des-3-fichiers-de-configuration"},"Modification des 3 fichiers de configuration"),(0,a.kt)("p",null,"Apr\xe8s avoir modifi\xe9 l'output du broker, il nous faut modifier les fichiers de configuration de Centreon.\nPour ce faire \xe9diter tout d'abord le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/centreon/conf.pm")," et remplacer @DATABASE_MASTER_IPADDR@ par l'adresse de la ",(0,a.kt)("em",{parentName:"p"},"vip-mysql")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'#############################################\n# File Added by Centreon\n#\n$centreon_config = {\n       VarLib => "/var/lib/centreon",\n       CentreonDir => "/usr/share/centreon/",\n       CacheDir => "/var/cache/centreon/",\n       "centreon_db" => "centreon",\n       "centstorage_db" => "centreon_storage",\n       "db_host" => "@VIP_SQL_IPADDR@:3306",\n       "db_user" => "@MARIADB_CENTREON_USER@",\n       "db_passwd" => \'@MARIADB_CENTREON_PASSWD@\'\n};\n# Central or Poller ?\n$instance_mode = "central";\n# Centreon Centcore Command File\n$cmdFile = "/var/lib/centreon/centcore.cmd";\n# Deprecated format of Config file.\n$mysql_user = "@MARIADB_CENTREON_USER@";\n$mysql_passwd = \'@MARIADB_CENTREON_PASSWD@\';\n$mysql_host = "@VIP_SQL_IPADDR@:3306";\n$mysql_database_oreon = "centreon";\n$mysql_database_ods = "centreon_storage";\n1;\n')),(0,a.kt)("p",null,"Puis faite la m\xeame op\xe9ration dans le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/centreon/centreon.conf.php")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"<?php\n/*\n * Centreon is developped with GPL Licence 2.0 :\n * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt\n * Developped by : Julien Mathis - Romain Le Merlus - Christophe Coraboeuf\n *\n * The Software is provided to you AS IS and WITH ALL FAULTS.\n * Centreon makes no representation and gives no warranty whatsoever,\n * whether express or implied, and without limitation, with regard to the quality,\n * safety, contents, performance, merchantability, non-infringement or suitability for\n * any particular or intended purpose of the Software found on the Centreon web site.\n * In no event will Centreon be liable for any direct, indirect, punitive, special,\n * incidental or consequential damages however they may arise and even if Centreon has\n * been previously advised of the possibility of such damages.\n *\n * For information : contact@centreon.com\n */\n/*      Database */\n$conf_centreon['hostCentreon'] = \"@VIP_SQL_IPADDR@\";\n$conf_centreon['hostCentstorage'] = \"@VIP_SQL_IPADDR@\";\n$conf_centreon['user'] = \"@MARIADB_CENTREON_USER@\";\n$conf_centreon['password'] = '@MARIADB_CENTREON_PASSWD@';\n$conf_centreon['db'] = \"centreon\";\n$conf_centreon['dbcstg'] = \"centreon_storage\";\n$conf_centreon['port'] = \"3306\";\n/* path to classes */\n$classdir='./class';\n/* Centreon Path */\n$centreon_path='/usr/share/centreon/';\n?>\n")),(0,a.kt)("p",null,"Et terminer sur avec le dernier fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/centreon/config.d/10-database.yaml")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'database:\n  db_configuration:\n    dsn: "mysql:host=@VIP_SQL_IPADDR@:3306;dbname=centreon"\n    username: "@MARIADB_CENTREON_USER@"\n    password: "@MARIADB_CENTREON_PASSWD@"\n  db_realtime:\n    dsn: "mysql:host=@VIP_SQL_IPADDR@:3306;dbname=centreon_storage"\n    username: "@MARIADB_CENTREON_USER@"\n    password: "@MARIADB_CENTREON_PASSWD@"\n')),(0,a.kt)("p",null,"Ensuite, vous devez red\xe9marrer les ressources gorgone et cbd_central_broker pour que les changements prennent effet.\nUtilisez la commande suivante pour red\xe9marrer la ressource gorgone et toutes les ressources suivantes :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource restart gorgone\n")),(0,a.kt)("p",null,"Et apr\xe8s le red\xe9marrage des ressources, v\xe9rifiez si tout est OK avec la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"crm_mon -fr"),", le r\xe9sultat devrait \xeatre similaire \xe0 ceci :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Cluster Summary:\n  * Stack: corosync\n  * Current DC: @CENTRAL_MASTER_NAME@ (version 2.1.4-5.el8_7.2-dc6eb4362e) - partition with quoru\nm\n  * Last updated: Wed Nov 23 10:27:48 2022\n  * Last change:  Wed Nov 23 10:27:43 2022 by hacluster via crmd on @CENTRAL_MASTER_NAME@\n  * 4 nodes configured\n  * 21 resource instances configured\n\nNode List:\n  * Online: [ @CENTRAL_MASTER_NAME@ centreon-rhel8-pri-bdd @CENTRAL_SLAVE_NAME@ @DATABASE_SLAVE_NAME@\n]\n\nFull List of Resources:\n  * Clone Set: ms_mysql-clone [ms_mysql] (promotable):\n    * Masters: [ centreon-rhel8-pri-bdd ]\n    * Slaves: [ @DATABASE_SLAVE_NAME@ ]\n    * Stopped: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n  * vip_mysql   (ocf::heartbeat:IPaddr2):        Started centreon-rhel8-pri-bdd\n  * Clone Set: php-clone [php]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n    * Stopped: [ centreon-rhel8-pri-bdd @DATABASE_SLAVE_NAME@ ]\n  * Clone Set: cbd_rrd-clone [cbd_rrd]:\n    * Started: [ @CENTRAL_MASTER_NAME@ @CENTRAL_SLAVE_NAME@ ]\n    * Stopped: [ centreon-rhel8-pri-bdd @DATABASE_SLAVE_NAME@ ]\n  * Resource Group: centreon:\n    * vip       (ocf::heartbeat:IPaddr2):        Started @CENTRAL_MASTER_NAME@\n    * http      (systemd:httpd):         Started @CENTRAL_MASTER_NAME@\n    * gorgone   (systemd:gorgoned):      Started @CENTRAL_MASTER_NAME@\n    * centreon_central_sync     (systemd:centreon-central-sync):         Started @CENTRAL_MASTER_NAME@\n    * cbd_central_broker        (systemd:cbd-sql):       Started @CENTRAL_MASTER_NAME@\n    * centengine        (systemd:centengine):    Started @CENTRAL_MASTER_NAME@\n    * centreontrapd     (systemd:centreontrapd):         Started@CENTRAL_MASTER_NAME@\n    * snmptrapd (systemd:snmptrapd):     Started @CENTRAL_MASTER_NAME@\n\nMigration Summary:\n")),(0,a.kt)("p",null,'Si une erreur est trouv\xe9e pendant l\'ex\xe9cution de vos ressources, essayez de "nettoyer" avec cette commande :'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pcs resource cleanup\n")),(0,a.kt)("h2",{id:"int\xe9grer-des-collecteurs"},"Int\xe9grer des collecteurs"),(0,a.kt)("p",null,"Il ne reste maintenant plus qu'\xe0 ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/staging/pr-2806/fr/docs/installation/installation-of-centreon-ha/integrating-pollers"},"int\xe9grer des collecteurs")," et commencer \xe0 superviser !"))}A.isMDXComponent=!0}}]);