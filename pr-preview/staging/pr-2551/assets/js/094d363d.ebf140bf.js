"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[23609],{55770:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>m,contentTitle:()=>d,default:()=>N,frontMatter:()=>c,metadata:()=>p,toc:()=>u});t(67294);var a=t(3905),r=t(51715),o=t(7626);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})),e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}const c={id:"centreon-ha-4-nodes-installation-manual-failover",title:"4-node manual failover installation"},d=void 0,p={unversionedId:"installation/installation-of-centreon-ha-manual/centreon-ha-4-nodes-installation-manual-failover",id:"version-23.10/installation/installation-of-centreon-ha-manual/centreon-ha-4-nodes-installation-manual-failover",title:"4-node manual failover installation",description:"Prerequisites",source:"@site/versioned_docs/version-23.10/installation/installation-of-centreon-ha-manual/installation-4-nodes.md",sourceDirName:"installation/installation-of-centreon-ha-manual",slug:"/installation/installation-of-centreon-ha-manual/centreon-ha-4-nodes-installation-manual-failover",permalink:"/centreon-documentation/pr-preview/staging/pr-2551/docs/installation/installation-of-centreon-ha-manual/centreon-ha-4-nodes-installation-manual-failover",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/versioned_docs/version-23.10/installation/installation-of-centreon-ha-manual/installation-4-nodes.md",tags:[],version:"23.10",lastUpdatedAt:1699282580,formattedLastUpdatedAt:"Nov 6, 2023",frontMatter:{id:"centreon-ha-4-nodes-installation-manual-failover",title:"4-node manual failover installation"},sidebar:"version-23.10/docs",previous:{title:"2-node manual failover installation",permalink:"/centreon-documentation/pr-preview/staging/pr-2551/docs/installation/installation-of-centreon-ha-manual/centreon-ha-2-nodes-installation-manual-failover"},next:{title:"Integrating new pollers in a manual Centreon-HA cluster",permalink:"/centreon-documentation/pr-preview/staging/pr-2551/docs/installation/installation-of-centreon-ha-manual/integrating-pollers"}},m={},u=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Understanding",id:"understanding",level:3},{value:"Installation of Centreon",id:"installation-of-centreon",level:3},{value:"Definition of server names and IP addresses",id:"definition-of-server-names-and-ip-addresses",level:3},{value:"Centreon-broker configuration",id:"centreon-broker-configuration",level:3},{value:"Linking to the cbd service",id:"linking-to-the-cbd-service",level:4},{value:"Dual RRD streams",id:"dual-rrd-streams",level:4},{value:"Export the configuration",id:"export-the-configuration",level:4},{value:"Modification of the <code>cbd</code> reload command",id:"modification-of-the-cbd-reload-command",level:3},{value:"Synchronize Centreon configuration files (PHP, Perl, Gorgone)",id:"synchronize-centreon-configuration-files-php-perl-gorgone",level:3},{value:"System preparation",id:"system-preparation",level:2},{value:"Tuning the network configuration",id:"tuning-the-network-configuration",level:3},{value:"Name resolution",id:"name-resolution",level:3},{value:"Installing the packages",id:"installing-the-packages",level:3},{value:"SSH key exchange",id:"ssh-key-exchange",level:3},{value:"Centreon account",id:"centreon-account",level:4},{value:"Mysql account",id:"mysql-account",level:4},{value:"Setting up MySQL replication",id:"setting-up-mysql-replication",level:2},{value:"MySQL configuration",id:"mysql-configuration",level:3},{value:"Securing the database",id:"securing-the-database",level:3},{value:"Creating the centreon account",id:"creating-the-centreon-account",level:3},{value:"Creating the replication account",id:"creating-the-replication-account",level:3},{value:"Configuring environment variables for MySQL scripts",id:"configuring-environment-variables-for-mysql-scripts",level:3},{value:"Switching to read-only",id:"switching-to-read-only",level:3},{value:"Authorization of centreon and mysql accounts",id:"authorization-of-centreon-and-mysql-accounts",level:3},{value:"Synchronize databases and start MySQL replication",id:"synchronize-databases-and-start-mysql-replication",level:3},{value:"Creating the MySQL VIP",id:"creating-the-mysql-vip",level:3},{value:"Setting up the Centreon cluster",id:"setting-up-the-centreon-cluster",level:2},{value:"Configuring the Synchronization Service",id:"configuring-the-synchronization-service",level:3},{value:"Removing crons",id:"removing-crons",level:2},{value:"Changing rights",id:"changing-rights",level:2},{value:"Stop and disable services",id:"stop-and-disable-services",level:3},{value:"Redefine service startup rules",id:"redefine-service-startup-rules",level:3},{value:"PHP service",id:"php-service",level:4},{value:"RRD Broker service",id:"rrd-broker-service",level:4},{value:"Creating the Centreon VIP",id:"creating-the-centreon-vip",level:4},{value:"Httpd service",id:"httpd-service",level:4},{value:"Gorgone service",id:"gorgone-service",level:4},{value:"Centreon-central-sync service",id:"centreon-central-sync-service",level:4},{value:"Broker SQL service",id:"broker-sql-service",level:4},{value:"Centengine service",id:"centengine-service",level:4},{value:"Centreontrapd service",id:"centreontrapd-service",level:4},{value:"Snmptrapd service",id:"snmptrapd-service",level:4},{value:"Initial launch of all services",id:"initial-launch-of-all-services",level:3},{value:"Installation of the Centreon virtual IP address",id:"installation-of-the-centreon-virtual-ip-address",level:4},{value:"Taking into account the changes made to the services",id:"taking-into-account-the-changes-made-to-the-services",level:4},{value:"Standard manual HA operation",id:"standard-manual-ha-operation",level:2},{value:"Switch Centreon services from one node to another",id:"switch-centreon-services-from-one-node-to-another",level:3},{value:"Reverse MySQL SLAVE/MASTER roles",id:"reverse-mysql-slavemaster-roles",level:3},{value:"Checking database synchronization",id:"checking-database-synchronization",level:3},{value:"Integrating pollers",id:"integrating-pollers",level:2}],h={toc:u},k="wrapper";function N(e){var{components:n}=e,t=s(e,["components"]);return(0,a.kt)(k,i(function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{},a=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),a.forEach((function(n){l(e,n,t[n])}))}return e}({},h,t),{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,a.kt)("h3",{id:"understanding"},"Understanding"),(0,a.kt)("p",null,"Before you follow this procedure, we recommend that you have a good knowledge of the Linux operating system and Centreon so you can understand what you are doing and correct any mistakes that might occur."),(0,a.kt)("h3",{id:"installation-of-centreon"},"Installation of Centreon"),(0,a.kt)("p",null,"The installation of a Centreon-HA cluster can only be done on the basis of a functional installation of Centreon. Before following this procedure, it is therefore essential to have applied ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("a",{parentName:"strong",href:"https://docs.centreon.com/docs/installation/introduction/"},"this installation procedure"))," through to the end, ",(0,a.kt)("strong",{parentName:"p"},"reserving about 5 GB of free space")," on the ",(0,a.kt)("em",{parentName:"p"},"volume group")," that contains the MySQL data (mount point ",(0,a.kt)("inlineCode",{parentName:"p"},"/var/lib/mysql")," by default)."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"vgs")," command should return a display of the form below (especially the value under ",(0,a.kt)("inlineCode",{parentName:"p"},"VFree"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"  VG                    #PV #LV #SN Attr   VSize   VFree \n  centos_centreon-c1      1   5   0 wz--n- <31,00g <5,00g\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"WARNING:")," If this prerequisite is not fulfilled, it will not be possible to synchronize the databases as described in this document."),(0,a.kt)("h3",{id:"definition-of-server-names-and-ip-addresses"},"Definition of server names and IP addresses"),(0,a.kt)("p",null,"In this procedure we will refer to parameters that vary from one installation to another (names and IP addresses of nodes, for example) via the following macros:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_MASTER_IPADDR@"),": IP address of the main central server"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_MASTER_NAME@"),": name of the main central server"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_SLAVE_IPADDR@"),": IP address of the second central server"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_SLAVE_NAME@"),": name of the second central server"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_MASTER_IPADDR@"),": IP address of the main database server"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_MASTER_NAME@"),": name of the main database server"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_SLAVE_IPADDR@"),": IP address of the secondary database server"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_SLAVE_NAME@"),": name of the secondary database server"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MYSQL_REPL_USER@"),": MySQL replication account name (suggested: centreon-repl)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MYSQL_REPL_PASSWD@"),": password for this account"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MYSQL_CENTREON_USER@"),": MySQL account name of Centreon (suggested: centreon)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MYSQL_CENTREON_PASSWD@"),": password for this account"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_VIP_IPADDR@"),": virtual IP address of the cluster"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_VIP_IFNAME@"),": name of the interface that will carry the VIP"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_VIP_CIDR_NETMASK@"),": subnet mask expressed in the number of bits without the '/' (example: 24)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_VIP_BROADCAST_IPADDR@"),": broadcast address"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_VIP_IPADDR@"),": virtual IP address of the cluster. In the case of a two-node HA, this is the same as the central one."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_VIP_IFNAME@"),": name of the interface that will carry the VIP. In the case of a two-node HA, this is the same as the central one."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_VIP_CIDR_NETMASK@"),": subnet mask expressed in number of bits without the '/' (example: 24). In the case of a two-node HA, this is the same as the central one."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_VIP_BROADCAST_IPADDR@"),": broadcast address. In the case of a two-node HA, this is the same as the central one.")),(0,a.kt)("h3",{id:"centreon-broker-configuration"},"Centreon-broker configuration"),(0,a.kt)("h4",{id:"linking-to-the-cbd-service"},"Linking to the cbd service"),(0,a.kt)("p",null,"In a standard Centreon installation, the ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd")," service drives two instances of ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon-broker-daemon"),":"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"central-broker-master"),': also known as "central broker" or "SQL broker", which redirects all I/O from pollers to databases, to the RRD broker, etc.'),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"central-rrd-master"),": the RRD broker, which receives its flow from the SQL broker, and whose only function is to write the RRD files used to display the graphs. ")),(0,a.kt)("p",null,"In a Centreon-HA cluster, the two broker processes will each be managed via a separate service that will be driven by the cluster:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"central-broker-master")," as the ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd_central_broker")," resource, linked to the ",(0,a.kt)("em",{parentName:"li"},"systemd")," ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd-sql")," service"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"central-rrd-master")," as the clone resource ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd_rrd"),", linked to the standard Centreon ",(0,a.kt)("em",{parentName:"li"},"systemd")," ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd")," service.")),(0,a.kt)("p",null,"For everything to work properly from this point on, you must now undo the link between central-broker-master and the ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd")," service ",(0,a.kt)("strong",{parentName:"p"},' by checking "no" for the parameter "Linked to cbd service "')," in ",(0,a.kt)("em",{parentName:"p"},"Configuration")," > ",(0,a.kt)("em",{parentName:"p"},"Pollers")," > ",(0,a.kt)("em",{parentName:"p"},"Broker configuration")," > ",(0,a.kt)("em",{parentName:"p"},"central-broker-master")," in the ",(0,a.kt)("em",{parentName:"p"},"General")," tab."),(0,a.kt)("h4",{id:"dual-rrd-streams"},"Dual RRD streams"),(0,a.kt)("p",null,"Rather than setting up a real-time replication of RRD data files, the technical choice that was made to allow graphs to be displayed on any node as soon as it becomes ",(0,a.kt)("inlineCode",{parentName:"p"},"master")," was to duplicate the output stream from ",(0,a.kt)("inlineCode",{parentName:"p"},"central-broker-master")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"central-rrd-master"),". This is configured in the same menu as in the previous paragraph, but this time in the ",(0,a.kt)("em",{parentName:"p"},"Output")," tab of ",(0,a.kt)("em",{parentName:"p"},"Configuration > Collectors > Centreon Broker Configuration"),"."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},'Modify the output "IPv4" by replacing "localhost" with ',(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_MASTER_IPADDR@"),".")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Output IPv4"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Name"),(0,a.kt)("td",{parentName:"tr",align:null},"centreon-broker-master-rrd")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Connection port"),(0,a.kt)("td",{parentName:"tr",align:null},"5670")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Host to connect to"),(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"@CENTRAL_MASTER_IPADDR@"))),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Buffering timeout"),(0,a.kt)("td",{parentName:"tr",align:null},"0")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Retry interval"),(0,a.kt)("td",{parentName:"tr",align:null},"60")))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},'Add a new IPv4 output, similar to the first one and named for example "centreon-broker-slave-rrd", this time pointing to ',(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_SLAVE_IPADDR@"),".")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Output IPv4"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Name"),(0,a.kt)("td",{parentName:"tr",align:null},"centreon-broker-slave-rrd")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Connection port"),(0,a.kt)("td",{parentName:"tr",align:null},"5670")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Host to connect to"),(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"@CENTRAL_SLAVE_IPADDR@"))),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Buffering timeout"),(0,a.kt)("td",{parentName:"tr",align:null},"0")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Retry interval"),(0,a.kt)("td",{parentName:"tr",align:null},"60")))),(0,a.kt)("h4",{id:"export-the-configuration"},"Export the configuration"),(0,a.kt)("p",null,'Once the actions in the two previous paragraphs have been performed, the configuration must be exported (the first three boxes for the export of the "Central" Poller) for it to take effect.'),(0,a.kt)("p",null,"These actions must be performed either on both nodes or only on ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," and then the broker configuration files must be copied to ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rsync -a /etc/centreon-broker/*json @CENTRAL_SLAVE_IPADDR@:/etc/centreon-broker/\n")),(0,a.kt)("h3",{id:"modification-of-the-cbd-reload-command"},"Modification of the ",(0,a.kt)("inlineCode",{parentName:"h3"},"cbd")," reload command"),(0,a.kt)("p",null,"This may not be known to all Centreon users, but every time a reload of the Central Poller configuration is done via the interface, the broker service (",(0,a.kt)("inlineCode",{parentName:"p"},"cbd"),') is reloaded (not just centengine), hence the "Centreon Broker reload command" parameter in ',(0,a.kt)("em",{parentName:"p"},"Configuration > Pollers > Central"),"."),(0,a.kt)("p",null,"As explained above, the broker processes are split between two services: ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd")," for the RRD broker, ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd-sql")," for the central broker. In the context of a centreon-ha cluster, the service that must be reloaded during the configuration export is ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd-sql"),", not ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd"),". You must therefore apply the value ",(0,a.kt)("inlineCode",{parentName:"p"},"service cbd-sql reload"),' to the "Centreon Broker reload command" parameter.'),(0,a.kt)("h3",{id:"synchronize-centreon-configuration-files-php-perl-gorgone"},"Synchronize Centreon configuration files (PHP, Perl, Gorgone)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rsync -av /etc/centreon/* root@@CENTRAL_SLAVE_IPADDR@:/etc/centreon/\n")),(0,a.kt)("h2",{id:"system-preparation"},"System preparation"),(0,a.kt)("p",null,"Before getting to the actual cluster setup, a few preparatory steps are necessary at OS level."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note:")," unless otherwise stated, each of the following steps must be performed ",(0,a.kt)("strong",{parentName:"p"},"on both central nodes"),"."),(0,a.kt)("h3",{id:"tuning-the-network-configuration"},"Tuning the network configuration"),(0,a.kt)("p",null,"To improve the reliability of the cluster, and since ",(0,a.kt)("em",{parentName:"p"},"Centreon HA")," only runs on IP v4, it is recommended to apply the following tuning to all servers of the Centreon platform:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cat >> /etc/sysctl.conf <<EOF\nnet.ipv6.conf.all.disable_ipv6 = 1\nnet.ipv6.conf.default.disable_ipv6 = 1\nnet.ipv4.tcp_retries2 = 3\nnet.ipv4.tcp_keepalive_time = 200\nnet.ipv4.tcp_keepalive_probes = 2\nnet.ipv4.tcp_keepalive_intvl = 2\nEOF\nsystemctl restart NetworkManager\n")))),(0,a.kt)("p",null,"To avoid problems with the management of fixed and virtual IP addresses, it is necessary to declare the fixed IP address of each server in the network configuration."),(0,a.kt)("p",null,"To do this, execute the following commands on each node:"),(0,a.kt)("p",null,"For the server ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod @CENTRAL_VIP_IFNAME@ +ipv4.addresses "@CENTRAL_MASTER_IPADDR@/@CENTRAL_VIP_CIDR_NETMASK@"\nnmcli con up @CENTRAL_VIP_IFNAME@\n')),(0,a.kt)("p",null,"For the server ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod @CENTRAL_VIP_IFNAME@ +ipv4.addresses "@CENTRAL_SLAVE_IPADDR@/@CENTRAL_VIP_CIDR_NETMASK@"\nnmcli con up @CENTRAL_VIP_IFNAME@\n')),(0,a.kt)("p",null,"For the server ",(0,a.kt)("inlineCode",{parentName:"p"},"@DB_MASTER_NAME@"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod @DB_VIP_IFNAME@ +ipv4.addresses "@DB_MASTER_IPADDR@/@DB_VIP_CIDR_NETMASK@"\nnmcli con up @DB_VIP_IFNAME@\n')),(0,a.kt)("p",null,"For the server ",(0,a.kt)("inlineCode",{parentName:"p"},"@DB_SLAVE_NAME@"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod @DB_VIP_IFNAME@ +ipv4.addresses "@DB_SLAVE_IPADDR@/@DB_VIP_CIDR_NETMASK@"\nnmcli con up @DB_VIP_IFNAME@\n')),(0,a.kt)("p",null,"You can verify on each node if the IP address is declared with this command on the Central node, for example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cat /etc/sysconfig/network-scripts/ifcfg-@CENTRAL_VIP_IFNAME@\n")),(0,a.kt)("p",null,"The result is like this for ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"...\nDEVICE=@CENTRAL_VIP_IFNAME@\nONBOOT=yes\nIPADDR=@CENTRAL_MASTER_IPADDR@\nPREFIX=23\n...\n")),(0,a.kt)("h3",{id:"name-resolution"},"Name resolution"),(0,a.kt)("p",null,"In order to ensure that the cluster functions properly even if the name resolution service fails, the nodes must know each other through the ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/hosts")," file."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat >/etc/hosts <<"EOF"\n127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n@CENTRAL_MASTER_IPADDR@ @CENTRAL_MASTER_NAME@\n@CENTRAL_SLAVE_IPADDR@ @CENTRAL_SLAVE_NAME@\n@DB_MASTER_IPADDR@ @DB_MASTER_NAME@\n@DB_SLAVE_IPADDR@ @DB_SLAVE_NAME@\nEOF\n')),(0,a.kt)("p",null,"In the rest of this document, we will refer to the primary node as the primary node and the secondary node as the secondary node. This distinction is purely arbitrary; the roles can of course be exchanged once the installation is complete."),(0,a.kt)("h3",{id:"installing-the-packages"},"Installing the packages"),(0,a.kt)("p",null,"Centreon offers the ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon-ha")," package, which provides all the scripts and dependencies needed to run a Centreon cluster."),(0,a.kt)("p",null,"On the central servers:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma Linux 8",label:"Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ha\ndnf install centreon-ha-web\n"))),(0,a.kt)(o.Z,{value:"RHEL 8",label:"RHEL 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"subscription-manager repos --enable rhel-8-for-x86_64-highavailability-rpms\ndnf install centreon-ha-web\n"))),(0,a.kt)(o.Z,{value:"Oracle Linux 8",label:"Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ol8_addons\ndnf install centreon-ha-web\n")))),(0,a.kt)("p",null,"Then, on the database servers:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma Linux 8",label:"Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ha\ndnf install centreon-ha-common\n"))),(0,a.kt)(o.Z,{value:"RHEL 8",label:"RHEL 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"subscription-manager repos --enable rhel-8-for-x86_64-highavailability-rpms\ndnf install centreon-ha-common\n"))),(0,a.kt)(o.Z,{value:"Oracle Linux 8",label:"Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ol8_addons\ndnf install centreon-ha-common\n")))),(0,a.kt)("h3",{id:"ssh-key-exchange"},"SSH key exchange"),(0,a.kt)("p",null,"To allow servers to exchange files and commands, it is necessary to set up the possibility to connect through SSH from one server to the other for the users:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mysql")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"centreon"))),(0,a.kt)("p",null,"There are two ways to exchange SSH keys:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Using ",(0,a.kt)("inlineCode",{parentName:"li"},"sh-copy-id"),": using this command requires the ability to validate authentication with a password. However, it is not desirable to define a password for the service accounts we are talking about here. If this method is used anyway, we recommend that you remove the password after the exchange, using the commands ",(0,a.kt)("inlineCode",{parentName:"li"},"passwd -d centreon")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"passwd -d mysql"),"."),(0,a.kt)("li",{parentName:"ul"},"By manually copying the public key into ",(0,a.kt)("inlineCode",{parentName:"li"},"~/.ssh/authorized_keys"),". This method is to be preferred, but to work properly, only the owner of the file must be able to read it.")),(0,a.kt)("p",null,"This is the second method, which will be proposed below."),(0,a.kt)("h4",{id:"centreon-account"},"Centreon account"),(0,a.kt)("p",null,"This procedure must be applied to the two central nodes. To begin, switch to the ",(0,a.kt)("inlineCode",{parentName:"p"},"bash")," environment of ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"su - centreon\n")),(0,a.kt)("p",null,"Then run these commands on the two central nodes:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-keygen -t ed25519 -a 100\ncat ~/.ssh/id_ed25519.pub | tee ~/.ssh/authorized_keys\n")),(0,a.kt)("p",null,"After running these commands on both nodes, copy the contents of the file that was displayed under the ",(0,a.kt)("inlineCode",{parentName:"p"},"cat")," command and paste it into the ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.ssh/authorized_keys")," file ",(0,a.kt)("strong",{parentName:"p"},"on the other node")," and then apply the correct permissions to the file (still as ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 600 ~/.ssh/authorized_keys\n")),(0,a.kt)("p",null,"The key exchange must then be validated by a first connection that will accept the signature of the SSH server (still as ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssh @CENTRAL_MASTER_NAME@\nssh @CENTRAL_SLAVE_NAME@\n")),(0,a.kt)("p",null,"Then exit the ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon")," session using ",(0,a.kt)("inlineCode",{parentName:"p"},"exit")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"Ctrl-D"),"."),(0,a.kt)("h4",{id:"mysql-account"},"Mysql account"),(0,a.kt)("p",null,"For the ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," account, the procedure differs somewhat because this user does not normally have a ",(0,a.kt)("em",{parentName:"p"},"home directory")," or the ability to open a Shell session. This procedure must be applied to both database nodes."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop mysql\nmkdir /home/mysql\nchown mysql: /home/mysql\nusermod -d /home/mysql mysql\nusermod -s /bin/bash mysql\ntouch /var/log/mysqld.log\nchown mysql. /var/log/mysqld.log\nsystemctl start mysql\n")),(0,a.kt)("p",null,"Then switch to the ",(0,a.kt)("inlineCode",{parentName:"p"},"bash")," environment of ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," and generate the SSH keys. Run these commands on both ",(0,a.kt)("strong",{parentName:"p"},"database nodes"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"su - mysql\nssh-keygen -t ed25519 -a 100\ncat ~/.ssh/id_ed25519.pub | tee ~/.ssh/authorized_keys\n")),(0,a.kt)("p",null,"After running these commands on both nodes, copy the contents of the file and paste it into ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.ssh/authorized_keys")," ",(0,a.kt)("strong",{parentName:"p"},"on the other node")," and then apply the correct permissions to the file (still as ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 600 ~/.ssh/authorized_keys\n")),(0,a.kt)("p",null,'The key exchange must then be validated by a first connection that will accept the signature of the SSH server by typing "yes" (still as ',(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssh @DB_MASTER_NAME@\nssh @DB_SLAVE_NAME@\n")),(0,a.kt)("p",null,"Then exit the ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," session using ",(0,a.kt)("inlineCode",{parentName:"p"},"exit")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"Ctrl-D"),"."),(0,a.kt)("h2",{id:"setting-up-mysql-replication"},"Setting up MySQL replication"),(0,a.kt)("p",null,"For the two nodes to be interchangeable at any time, the two databases must be continuously replicated. To do this, we will set up a Master-Slave replication."),(0,a.kt)("p",null,"Since Centreon 22.04, MariaDB Replication is now based on  ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("a",{parentName:"strong",href:"https://mariadb.com/kb/en/gtid/"},"GTID")),"."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note:")," unless otherwise stated, each of the following steps must be performed ",(0,a.kt)("strong",{parentName:"p"},"on both database nodes"),"."),(0,a.kt)("h3",{id:"mysql-configuration"},"MySQL configuration"),(0,a.kt)("p",null,"To begin with, we need to tune the MySQL configuration, which will be concentrated in the single file ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/my.cnf.d/server.cnf"),".  By default, the ",(0,a.kt)("inlineCode",{parentName:"p"},"[server]")," section of this file is empty, which is where the following lines should be pasted:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nsql_mode = 'NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'\nserver-id=1 # SET TO 1 FOR MASTER AND 2 FOR SLAVE\n#read_only\nlog-bin=mysql-bin\nbinlog-do-db=centreon\nbinlog-do-db=centreon_storage\ninnodb_flush_log_at_trx_commit=1\nsync_binlog=1\nbinlog_format=MIXED\nslave_compressed_protocol=1\ndatadir=/var/lib/mysql\npid-file=/var/lib/mysql/mysql.pid\nskip-slave-start\nlog-slave-updates\ngtid_strict_mode=ON\nexpire_logs_days=7\nignore-db-dir=lost+found\n\n# Tuning standard Centreon\ninnodb_file_per_table=1\nopen_files_limit=32000\nkey_buffer_size=256M\nsort_buffer_size=32M\njoin_buffer_size=4M\nthread_cache_size=64\nread_buffer_size=512K\nread_rnd_buffer_size=256K\nmax_allowed_packet=64M\n# Uncomment for 4 Go Ram\n#innodb_buffer_pool_size=512M\n# Uncomment for 8 Go Ram\n#innodb_buffer_pool_size=1G\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Important:")," the value of ",(0,a.kt)("inlineCode",{parentName:"p"},"server-id")," must be different from one server to another, so that they can identify each other correctly. The values 1 => Master and 2 => Slave are not mandatory, but are recommended."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"N.B:")," Remember to uncomment (remove the '#' at the beginning of the line) the ",(0,a.kt)("inlineCode",{parentName:"p"},"innodb_buffer_pool_size")," parameter that corresponds to your platform."),(0,a.kt)("p",null,"For these modifications to be taken into account, you must restart the database server:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart mariadb\n")),(0,a.kt)("p",null,"Use the following command to make sure the reboot was successful:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl status mariadb\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Warning:")," The ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.cnf")," file will no longer be taken into account, so if any parameters were customized there, they must be transferred to ",(0,a.kt)("inlineCode",{parentName:"p"},"server.cnf"),"."),(0,a.kt)("h3",{id:"securing-the-database"},"Securing the database"),(0,a.kt)("p",null,"Access to databases should be restricted as strictly as possible. The command ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql_secure_installation")," is used to remove any accesses not protected by passwords and the test database. Run this command and be guided by the default choices. Be careful to choose a password that does not belong to any dictionary."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mysql_secure_installation\n")),(0,a.kt)("h3",{id:"creating-the-centreon-account"},"Creating the centreon account"),(0,a.kt)("p",null,"To be able to administer MySQL users, you must first connect as root (with the password entered in the previous paragraph):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"mysql -p\n")),(0,a.kt)("p",null,"Then, in the MySQL prompt, paste the commands below (changing the IP addresses and passwords appropriately)."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER '@MYSQL_CENTREON_USER@'@'@CENTRAL_SLAVE_IPADDR@' IDENTIFIED BY '@MYSQL_CENTREON_PASSWD@';\nGRANT ALL PRIVILEGES ON centreon.* TO '@MYSQL_CENTREON_USER@'@'@CENTRAL_SLAVE_IPADDR@';\nGRANT ALL PRIVILEGES ON centreon_storage.* TO '@MYSQL_CENTREON_USER@'@'@CENTRAL_SLAVE_IPADDR@';\n\nCREATE USER '@MYSQL_CENTREON_USER@'@'@CENTRAL_MASTER_IPADDR@' IDENTIFIED BY '@MYSQL_CENTREON_PASSWD@';\nGRANT ALL PRIVILEGES ON centreon.* TO '@MYSQL_CENTREON_USER@'@'@CENTRAL_MASTER_IPADDR@';\nGRANT ALL PRIVILEGES ON centreon_storage.* TO '@MYSQL_CENTREON_USER@'@'@CENTRAL_MASTER_IPADDR@';\n")),(0,a.kt)("h3",{id:"creating-the-replication-account"},"Creating the replication account"),(0,a.kt)("p",null,"Still in the MySQL prompt (see the previous paragraph), create the user ",(0,a.kt)("inlineCode",{parentName:"p"},"@MYSQL_REPL_USER@"),", dedicated to replication, using the following commands:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER '@MYSQL_REPL_USER@'@'localhost' IDENTIFIED BY '@MYSQL_REPL_PASSWD@';\nGRANT PROCESS, RELOAD, SHUTDOWN, SUPER, REPLICATION CLIENT, REPLICATION SLAVE ON *.* TO '@MYSQL_REPL_USER@'@'localhost';\n\nCREATE USER '@MYSQL_REPL_USER@'@'@CENTRAL_SLAVE_IPADDR@' IDENTIFIED BY '@MYSQL_REPL_PASSWD@';\nGRANT PROCESS, RELOAD, SHUTDOWN, SUPER, REPLICATION CLIENT, REPLICATION SLAVE ON *.* TO '@MYSQL_REPL_USER@'@'@DB_SLAVE_IPADDR@';\n\nCREATE USER '@MYSQL_REPL_USER@'@'@CENTRAL_MASTER_IPADDR@' IDENTIFIED BY '@MYSQL_REPL_PASSWD@';\nGRANT PROCESS, RELOAD, SHUTDOWN, SUPER, REPLICATION CLIENT, REPLICATION SLAVE ON *.* TO '@MYSQL_REPL_USER@'@'@DB_MASTER_IPADDR@';\n")),(0,a.kt)("h3",{id:"configuring-environment-variables-for-mysql-scripts"},"Configuring environment variables for MySQL scripts"),(0,a.kt)("p",null,"The file ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/centreon-ha/mysql-resources.sh")," contains environment variables that must be adapted to the current installation by replacing the macros with the appropriate value."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\n###############################\n# Database access credentials #\n###############################\n\nDBHOSTNAMEMASTER='@DB_MASTER_NAME@'\nDBHOSTNAMESLAVE='@DB_SLAVE_NAME@'\nDBREPLUSER='@MYSQL_REPL_USER@'\nDBREPLPASSWORD='@MYSQL_REPL_PASSWD@'\nDBROOTUSER='@MYSQL_REPL_USER@'\nDBROOTPASSWORD='@MYSQL_REPL_PASSWD@'\nCENTREON_DB='centreon'\nCENTREON_STORAGE_DB='centreon_storage'\n\n##########################################\n# Manual failover additional informations #\n##########################################\n\nCENTRAL_VIP_IPADDR='@CENTRAL_VIP_IPADDR@'\nCENTRAL_VIP_IFNAME='@CENTRAL_VIP_IFNAME@'\nCENTRAL_VIP_CIDR_NETMASK='@CENTRAL_VIP_CIDR_NETMASK@'\nCENTRAL_VIP_BROADCAST_IPADDR='@CENTRAL_VIP_BROADCAST_IPADDR@'\nMYSQL_VIP_IPADDR='@DB_VIP_IPADDR@'\nMYSQL_VIP_IFNAME='@DB_VIP_IFNAME@'\nMYSQL_VIP_CIDR_NETMASK='@DB_VIP_CIDR_NETMASK@'\nMYSQL_VIP_BROADCAST_IPADDR='@DB_VIP_BROADCAST_IPADDR@'\n")),(0,a.kt)("p",null,"To make sure that the last steps have been done correctly, and that the correct names, logins and passwords have been entered in the configuration file, run the command :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The expected outcome is:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection Status '@DB_MASTER_NAME@' [OK]\nConnection Status '@DB_SLAVE_NAME@' [OK]\nSlave Thread Status [KO]\nError reports:\n    No slave (maybe because we cannot check a server).\nPosition Status [SKIP]\n!Error reports:\n    Skip because we can't identify a unique slave.\n")),(0,a.kt)("p",null,"It is important to check that the first two connection tests are ",(0,a.kt)("inlineCode",{parentName:"p"},"OK"),"."),(0,a.kt)("h3",{id:"switching-to-read-only"},"Switching to read-only"),(0,a.kt)("p",null,"Now that everything is set up properly, we need to enable read_only mode on both servers by uncommenting (",(0,a.kt)("em",{parentName:"p"},"i.e.")," removing the ",(0,a.kt)("inlineCode",{parentName:"p"},"#")," at the beginning of the line) this statement in the ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/my.cnf.d/server.cnf")," file:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Main node")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nserver-id=1\nread_only\nlog-bin=mysql-bin\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Secondary node")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nserver-id=2\nread_only\nlog-bin=mysql-bin\n")),(0,a.kt)("p",null,"Then apply this change by restarting MariaDB on both nodes:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart mariadb\n")),(0,a.kt)("h3",{id:"authorization-of-centreon-and-mysql-accounts"},"Authorization of centreon and mysql accounts"),(0,a.kt)("p",null,"For the scripts to run correctly through the ssh connections via the centreon and mysql accounts, they must be given additional rights."),(0,a.kt)("p",null,"For the centreon account, edit the file ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/sudoers.d/centreon-cluster")," and add the following lines:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"CENTREON   ALL = NOPASSWD: /usr/bin/systemctl reload centreon\nCENTREON   ALL = NOPASSWD: /usr/bin/systemctl restart centreon\nCENTREON   ALL = NOPASSWD: /usr/bin/systemctl stop centreon\nCENTREON   ALL = NOPASSWD: /usr/bin/systemctl start centreon\n\nCENTREON   ALL = NOPASSWD: /usr/bin/nmcli\n")),(0,a.kt)("p",null,"For the mysql account, edit the file ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/sudoers.d/centreon-cluster-db")," and add the following line:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"MYSQL   ALL = NOPASSWD: /usr/bin/nmcli\n")),(0,a.kt)("h3",{id:"synchronize-databases-and-start-mysql-replication"},"Synchronize databases and start MySQL replication"),(0,a.kt)("p",null,"To synchronize the databases, stop the ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," service on the secondary node to overwrite its data with that of the main server. "),(0,a.kt)("p",null,"Run the following command ",(0,a.kt)("strong",{parentName:"p"},"on the secondary node"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop mariadb\n")),(0,a.kt)("p",null,"In some cases, systemd may fail to stop the ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," service. To be sure, check that the following command returns no lines:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ps -ef | grep mysql[d]\n")),(0,a.kt)("p",null,"If a ",(0,a.kt)("inlineCode",{parentName:"p"},"mysqld")," process is still running, then the following command should be run to stop it (and provide the mysql root password when prompted):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mysqladmin -p shutdown\n")),(0,a.kt)("p",null,"Once the service is stopped on the ",(0,a.kt)("strong",{parentName:"p"},"secondary")," node, run the synchronization script ",(0,a.kt)("strong",{parentName:"p"},"from the main node"),": "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-sync-bigdb.sh\n")),(0,a.kt)("p",null,"This script does the following:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"checks that mysql is stopped on the secondary node"),(0,a.kt)("li",{parentName:"ul"},"stops mysql on the primary node"),(0,a.kt)("li",{parentName:"ul"},"mounts an LVM snapshot on the ",(0,a.kt)("em",{parentName:"li"},"volume group")," that supports the /var/lib/mysql partition"),(0,a.kt)("li",{parentName:"ul"},"starts mysql on the primary node"),(0,a.kt)("li",{parentName:"ul"},"stores the current position in the binary logs"),(0,a.kt)("li",{parentName:"ul"},"disables the MySQL global variable ",(0,a.kt)("inlineCode",{parentName:"li"},"read_only")," on the master node (",(0,a.kt)("em",{parentName:"li"},"i.e.")," the master node is now allowed to write to its database)"),(0,a.kt)("li",{parentName:"ul"},"synchronizes all data files (excluding the ",(0,a.kt)("inlineCode",{parentName:"li"},"mysql")," system database) by overwriting the files on the secondary node"),(0,a.kt)("li",{parentName:"ul"},"unmounts the LVM snapshot"),(0,a.kt)("li",{parentName:"ul"},"creates the replication thread that will keep the data updated on the secondary node")),(0,a.kt)("p",null,"This script is very verbose, and not everything that is displayed is understandable, but to make sure that it has run to completion, just make sure that the end looks like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},'Umount and Delete LVM snapshot\n  Logical volume "dbbackupdatadir" successfully removed\nStart MySQL Slave\nOK\nStart Replication\nId  User    Host    db  Command Time    State   Info    Progress\n3   @MYSQL_REPL_USER@   @DB_MASTER_NAME@:33084  NULL    Query   0   init    show processlist    0.000\n')),(0,a.kt)("p",null,"If all went well, then the ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql-check-status.sh")," command should return an error-free result:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"Expected outcome:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection Status '@DB_MASTER_NAME@' [OK]\nConnection Status '@DB_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("h3",{id:"creating-the-mysql-vip"},"Creating the MySQL VIP"),(0,a.kt)("p",null,"The VIP will be added to the ",(0,a.kt)("inlineCode",{parentName:"p"},"@DB_VIP_IFNAME@")," interface configuration on ",(0,a.kt)("strong",{parentName:"p"},"the database master node"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod "@DB_VIP_IFNAME@" +ipv4.addresses "@DB_VIP_IPADDR@/@DB_VIP_CIDR_NETMASK@"\nnmcli connection up "@DB_VIP_IFNAME@"\n')),(0,a.kt)("p",null,"Then run the following script ",(0,a.kt)("strong",{parentName:"p"},"on one of the two MySQL nodes")," to check if the VIP is correctly mounted on the MySQL master server (this script can be run on either of the two nodes and it will detect by itself which is the master):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/move-mysql-vip-to-mysql-master.sh\n")),(0,a.kt)("p",null,"The result should be like this; if not, use the script to move the VIP to the correct place:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"The VIP address is already in the right place. Nothing to do.\n")),(0,a.kt)("h2",{id:"setting-up-the-centreon-cluster"},"Setting up the Centreon cluster"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note:")," unless otherwise noted, each of the following steps must be performed ",(0,a.kt)("strong",{parentName:"p"},"on both central nodes"),"."),(0,a.kt)("h3",{id:"configuring-the-synchronization-service"},"Configuring the Synchronization Service"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon-central-sync")," service requires that, for each node in ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/centreon-ha/centreon_central_sync.pm"),", we define the IP address of its correspondent:"),(0,a.kt)("p",null,"So for the server ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," we must have:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'our %centreon_central_sync_config = (\n    peer_addr => "@CENTRAL_SLAVE_IPADDR@"\n);\n1;\n')),(0,a.kt)("p",null,"And for the server ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@")," we must have:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'our %centreon_central_sync_config = (\n    peer_addr => "@CENTRAL_MASTER_IPADDR@"\n);\n1;\n')),(0,a.kt)("h2",{id:"removing-crons"},"Removing crons"),(0,a.kt)("p",null,"Scheduled cron tasks are executed directly by the gorgone process in the highly available architecture. This ensures that they do not compete with each other on the central nodes. It is therefore necessary to delete them manually:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rm -f /etc/cron.d/centreon\nrm -f /etc/cron.d/centstorage\nrm -f /etc/cron.d/centreon-auto-disco\n")),(0,a.kt)("h2",{id:"changing-rights"},"Changing rights"),(0,a.kt)("p",null,"The directories /var/log/centreon-engine and /tmp/centreon-autodisco are shared between several processes. It is necessary to modify the rights of the directories and files to ensure the proper functioning of file replication and automatic discovery of services:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 775 /var/log/centreon-engine/\nmkdir /var/log/centreon-engine/archives\nchown centreon-engine: /var/log/centreon-engine/archives\nchmod 775 /var/log/centreon-engine/archives/\nchmod 664 /var/log/centreon-engine/*\nchmod 664 /var/log/centreon-engine/archives/*\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /tmp/centreon-autodisco/\nchown apache: /tmp/centreon-autodisco/\nchmod 775 /tmp/centreon-autodisco/\n")),(0,a.kt)("h3",{id:"stop-and-disable-services"},"Stop and disable services"),(0,a.kt)("p",null,"The Centreon application services will no longer be launched on server startup as in the case of a standard installation; the clustering services will take care of it. It is therefore necessary to stop and disable these services."),(0,a.kt)("p",null,"On the central servers:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop centengine snmptrapd centreontrapd gorgoned cbd httpd php-fpm centreon\nsystemctl disable centengine snmptrapd centreontrapd gorgoned cbd httpd php-fpm centreon centreon-central-sync cbd-sql\n")))),(0,a.kt)("h3",{id:"redefine-service-startup-rules"},"Redefine service startup rules"),(0,a.kt)("p",null,"Some services should only be started on one node, but for others, it's OK or even desirable to start them on both nodes. We'll start with these services."),(0,a.kt)("h4",{id:"php-service"},"PHP service"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"php-fpm.service")," service does not need to be modified, but must be enabled so that it is started automatically when the central servers are started."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable php-fpm\n")),(0,a.kt)("h4",{id:"rrd-broker-service"},"RRD Broker service"),(0,a.kt)("p",null,'The "broker-rrd" process is started via the ',(0,a.kt)("inlineCode",{parentName:"p"},"cbd.service"),". By default, this is driven by ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.service"),", but in this configuration, it must be detached by modifying its definition on the two central nodes:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/cbd.service <<"EOF"\n[Unit]\nDescription=Centreon Broker watchdog\nAfter=syslog.target network.target\n\n[Service]\nExecStart=/usr/sbin/cbwd /etc/centreon-broker/watchdog.json\nExecReload=/bin/kill -HUP $MAINPID\nType=simple\nUser=centreon-broker\nUMask=0002\n\n[Install]\nWantedBy=multi-user.target\nEOF\n')),(0,a.kt)("p",null,"Then start it and activate it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl start cbd\nsystemctl enable cbd\n")),(0,a.kt)("h4",{id:"creating-the-centreon-vip"},"Creating the Centreon VIP"),(0,a.kt)("p",null,"The VIP will be added to the ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_VIP_IFNAME@")," interface configuration on ",(0,a.kt)("strong",{parentName:"p"},"central master node"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod "@CENTRAL_VIP_IFNAME@" +ipv4.addresses "@CENTRAL_VIP_IPADDR@/@CENTRAL_VIP_CIDR_NETMASK@"\nnmcli connection up "@CENTRAL_VIP_IFNAME@"\n')),(0,a.kt)("h4",{id:"httpd-service"},"Httpd service"),(0,a.kt)("p",null,"By default, the ",(0,a.kt)("inlineCode",{parentName:"p"},"httpd.service")," service is independent of ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.service"),", but in this configuration, it must be attached to it by modifying its definition on the two central nodes:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/httpd.service <<"EOF"\n[Unit]\nDescription=The Apache HTTP Server\nPartOf=centreon.service\nReloadPropagatedFrom=centreon.service\nAfter=centreon.service\n\n[Service]\nType=notify\nEnvironment=LANG=C\n\nExecStart=/usr/sbin/httpd $OPTIONS -DFOREGROUND\nExecReload=/usr/sbin/httpd $OPTIONS -k graceful\nExecStop=/usr/sbin/httpd $OPTIONS -k graceful-stop\n# Send SIGWINCH for graceful stop\nKillSignal=SIGCONT\nKillMode=mixed\nPrivateTmp=true\n\n[Install]\nWantedBy=centreon.service\nEOF\n')))),(0,a.kt)("h4",{id:"gorgone-service"},"Gorgone service"),(0,a.kt)("p",null,"By default, the ",(0,a.kt)("inlineCode",{parentName:"p"},"gorgoned.service")," service is independent of ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.service"),", but in this configuration, it must be attached to it by modifying its definition on the two central nodes:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /etc/systemd/system/gorgoned.service <<"EOF"\n[Unit]\nDescription=Centreon Gorgone\nPartOf=centreon.service\nAfter=httpd.service\nReloadPropagatedFrom=centreon.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/gorgoned\nExecStart=/usr/bin/perl /usr/bin/gorgoned $OPTIONS\nType=simple\nUser=centreon-gorgone\n\n[Install]\nWantedBy=centreon.service\nEOF\n')))),(0,a.kt)("h4",{id:"centreon-central-sync-service"},"Centreon-central-sync service"),(0,a.kt)("p",null,"This service is specific to ",(0,a.kt)("em",{parentName:"p"},"Centreon HA"),". Its function is to replicate configuration changes, add images via the interface, etc."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/centreon-central-sync.service <<"EOF"\n[Unit]\nDescription=Centreon Central Sync (failover only)\nPartOf=centreon.service\nReloadPropagatedFrom=centreon.service\nAfter=gorgoned.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/centreon_central_sync\nExecStart=/usr/share/centreon-ha/bin/centreon_central_sync $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nType=simple\nUser=centreon\n\n[Install]\nWantedBy=centreon.service\nEOF\n')),(0,a.kt)("h4",{id:"broker-sql-service"},"Broker SQL service"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/cbd-sql.service <<"EOF"\n[Unit]\nDescription=Centreon SQL Broker service\nPartOf=centreon.service\nReloadPropagatedFrom=centreon.service\nAfter=centreon-central-sync.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/cbd_sql\nExecStart=/usr/sbin/cbd $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nType=simple\nUser=centreon-broker\nUMask=0002\n\n[Install]\nWantedBy=centreon.service\nEOF\n')),(0,a.kt)("h4",{id:"centengine-service"},"Centengine service"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/centengine.service <<"EOF"\n[Unit]\nDescription=Centreon Engine\nPartOf=centreon.service\nReloadPropagatedFrom=centreon.service\nAfter=cbd-sql.service\n\n[Service]\nExecStart=/usr/sbin/centengine /etc/centreon-engine/centengine.cfg\nExecReload=/bin/kill -HUP $MAINPID\nType=simple\nUser=centreon-engine\n\n[Install]\nWantedBy=centreon.service\nEOF\n')),(0,a.kt)("h4",{id:"centreontrapd-service"},"Centreontrapd service"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/centreontrapd.service <<"EOF"\n[Unit]\nDescription=Centreon Trapd Daemon is a Centreon program that manages traps\nPartOf=centreon.service\nAfter=centreon.service\nReloadPropagatedFrom=centreon.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/centreontrapd\nExecStart=/usr/share/centreon/bin/centreontrapd $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nType=simple\nUser=centreon\n\n[Install]\nWantedBy=centreon.service\nEOF\n')),(0,a.kt)("h4",{id:"snmptrapd-service"},"Snmptrapd service"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/snmptrapd.service <<"EOF"\n[Unit]\nDescription=Simple Network Management Protocol (SNMP) Trap Daemon.\nPartOf=centreon.service\nAfter=centreontrapd.service\n\n[Service]\nType=notify\nEnvironment=OPTIONS="-Lsd"\nEnvironmentFile=-/etc/sysconfig/snmptrapd\nExecStart=/usr/sbin/snmptrapd $OPTIONS -f\nExecReload=/bin/kill -HUP $MAINPID\n\n[Install]\nWantedBy=centreon.service\nEOF\n')),(0,a.kt)("h3",{id:"initial-launch-of-all-services"},"Initial launch of all services"),(0,a.kt)("h4",{id:"installation-of-the-centreon-virtual-ip-address"},"Installation of the Centreon virtual IP address"),(0,a.kt)("p",null,"Normally, the VIP has already been mounted previously. Check that this is the case on the primary server defined above (normally ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@"),")"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ip a\n")),(0,a.kt)("p",null,"You should see the virtual IP ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_VIP_IPADDR@")," attached to the ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_VIP_IFNAME@")," interface appear in the return of the ",(0,a.kt)("inlineCode",{parentName:"p"},"ip a")," command."),(0,a.kt)("p",null,"If not, the virtual IP address must be mounted, for example on ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod "@CENTRAL_VIP_IFNAME@" +ipv4.addresses "@CENTRAL_VIP_IPADDR@/@CENTRAL_VIP_CIDR_NETMASK@"\nnmcli con up "@CENTRAL_VIP_IFNAME@"\n')),(0,a.kt)("h4",{id:"taking-into-account-the-changes-made-to-the-services"},"Taking into account the changes made to the services"),(0,a.kt)("p",null,"To take into account all the previous modifications, and to activate the services (so that starting the ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.service")," service starts them all), it is necessary to launch these commands on the two central nodes:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl daemon-reload\nsystemctl enable cbd httpd gorgoned centreon-central-sync cbd-sql centengine centreontrapd snmptrapd\n")))),(0,a.kt)("p",null,"And, finally, start them all via the ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.service")," on the node where the VIP was mounted:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl start centreon\n")),(0,a.kt)("p",null,"Then check the status of all services:"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl status cbd httpd gorgoned centreon-central-sync cbd-sql centengine centreontrapd snmptrapd\n")))),(0,a.kt)("p",null,"After this step, all resources should be active in the same place, and the platform should be functional and redundant. If not, refer to the troubleshooting guide in the next paragraph."),(0,a.kt)("h2",{id:"standard-manual-ha-operation"},"Standard manual HA operation"),(0,a.kt)("h3",{id:"switch-centreon-services-from-one-node-to-another"},"Switch Centreon services from one node to another"),(0,a.kt)("p",null,"This script can be run from any Centreon node, but you must (for now) specify the target node. For example, to change the active node from ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/set-centreon-master.sh @CENTRAL_SLAVE_NAME@\n")),(0,a.kt)("p",null,"The expected outcome is:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stopping centreon.service on @CENTRAL_MASTER_NAME@...\nUnmounting VIP on @CENTRAL_MASTER_NAME@...\nAdding vip to @CENTRAL_SLAVE_NAME@...\nStarting centreon.service on @CENTRAL_SLAVE_NAME@...\n")),(0,a.kt)("p",null,"If we try to switch to the node that is already active, we will get:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Host @CENTRAL_MASTER_NAME@ is already the current master :-)\n")),(0,a.kt)("h3",{id:"reverse-mysql-slavemaster-roles"},"Reverse MySQL SLAVE/MASTER roles"),(0,a.kt)("p",null,"This script can be launched from any database node. This time, we do not specify the name of the target server:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-switch-slave-master.sh\n")),(0,a.kt)("p",null,"The expected outcome is:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Locking master database on @DB_SLAVE_NAME@\nWaiting Relay log bin to finish proceed (TIMEOUT = 60sec)\nRemoving slave thread on @DB_MASTER_NAME@\nRecording binlog file and position from @DB_MASTER_NAME@\nUnlocking databases on @DB_MASTER_NAME@\nSetting and starting slave thread on @DB_SLAVE_NAME@\nWe have to move the VIP address\n")),(0,a.kt)("h3",{id:"checking-database-synchronization"},"Checking database synchronization"),(0,a.kt)("p",null,"The status of MySQL replication can be checked at any time using the command ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql-check-status.sh"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"The expected outcome is:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Connection Status '@DB_MASTER_NAME@' [OK]\nConnection Status '@DB_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("h2",{id:"integrating-pollers"},"Integrating pollers"),(0,a.kt)("p",null,"You can now ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/staging/pr-2551/docs/installation/installation-of-centreon-ha-manual/integrating-pollers"},"add your Pollers")," and start monitoring!"))}N.isMDXComponent=!0}}]);