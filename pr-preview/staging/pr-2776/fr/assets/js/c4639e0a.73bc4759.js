"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[50468],{63243:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>u,toc:()=>c});t(67294);var r=t(3905);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})),e}function i(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}const o={id:"backup",title:"Sauvegarde"},l=void 0,u={unversionedId:"administration/backup",id:"version-23.10/administration/backup",title:"Sauvegarde",description:"Fonctionnement",source:"@site/i18n/fr/docusaurus-plugin-content-docs/version-23.10/administration/backup.md",sourceDirName:"administration",slug:"/administration/backup",permalink:"/centreon-documentation/pr-preview/staging/pr-2776/fr/docs/administration/backup",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/i18n/fr/docusaurus-plugin-content-docs/version-23.10/administration/backup.md",tags:[],version:"23.10",lastUpdatedAt:1699375250,formattedLastUpdatedAt:"7 nov. 2023",frontMatter:{id:"backup",title:"Sauvegarde"},sidebar:"version-23.10/docs",previous:{title:"Partitionnement des bases de donn\xe9es",permalink:"/centreon-documentation/pr-preview/staging/pr-2776/fr/docs/administration/database-partitioning"},next:{title:"Base de connaissance",permalink:"/centreon-documentation/pr-preview/staging/pr-2776/fr/docs/administration/knowledge-base"}},d={},c=[{value:"Fonctionnement",id:"fonctionnement",level:2},{value:"Ex\xe9cution journali\xe8re",id:"ex\xe9cution-journali\xe8re",level:3},{value:"Types de sauvegarde",id:"types-de-sauvegarde",level:3},{value:"Sauvegarde de la base de donn\xe9es",id:"sauvegarde-de-la-base-de-donn\xe9es",level:4},{value:"Sauvegarde des fichiers de configuration",id:"sauvegarde-des-fichiers-de-configuration",level:4},{value:"Configuration",id:"configuration",level:2},{value:"Restauration d&#39;un serveur central Centreon",id:"restauration-dun-serveur-central-centreon",level:2},{value:"Restauration des fichiers de configuration de Centreon",id:"restauration-des-fichiers-de-configuration-de-centreon",level:3},{value:"Restauration des bases de donn\xe9es",id:"restauration-des-bases-de-donn\xe9es",level:3},{value:"Restauration des cl\xe9s SSH",id:"restauration-des-cl\xe9s-ssh",level:3},{value:"Restauration des plugins",id:"restauration-des-plugins",level:3},{value:"Restauration des scripts d&#39;initialisation",id:"restauration-des-scripts-dinitialisation",level:3},{value:"Restauration des agents de supervision",id:"restauration-des-agents-de-supervision",level:3},{value:"G\xe9n\xe9ration de la configuration du central",id:"g\xe9n\xe9ration-de-la-configuration-du-central",level:3},{value:"Reconstruction des graphiques",id:"reconstruction-des-graphiques",level:3}],p={toc:c},g="wrapper";function m(e){var{components:n}=e,o=i(e,["components"]);return(0,r.kt)(g,s(function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{},r=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),r.forEach((function(n){a(e,n,t[n])}))}return e}({},p,o),{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"fonctionnement"},"Fonctionnement"),(0,r.kt)("h3",{id:"ex\xe9cution-journali\xe8re"},"Ex\xe9cution journali\xe8re"),(0,r.kt)("p",null,"Le script de sauvegarde est ex\xe9cut\xe9 de mani\xe8re journali\xe8re par une t\xe2che\nplanifi\xe9e situ\xe9e dans ",(0,r.kt)("strong",{parentName:"p"},"/etc/cron.d/centreon"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"##########################\n# Cron for Centreon-Backup\n30 3 * * * root /usr/share/centreon/cron/centreon-backup.pl >> /var/log/centreon/centreon-backup.log 2&>1\n")),(0,r.kt)("p",null,"Dans cet exemple, le script lance une sauvegarde chaque jour \xe0 3H30."),(0,r.kt)("h3",{id:"types-de-sauvegarde"},"Types de sauvegarde"),(0,r.kt)("p",null,"Il y a deux types de sauvegarde : base de donn\xe9es et fichiers de configuration."),(0,r.kt)("h4",{id:"sauvegarde-de-la-base-de-donn\xe9es"},"Sauvegarde de la base de donn\xe9es"),(0,r.kt)("p",null,"La sauvegarde de la base de donn\xe9es peut \xeatre r\xe9alis\xe9e sur deux bases :\n",(0,r.kt)("strong",{parentName:"p"},"centreon")," et ",(0,r.kt)("strong",{parentName:"p"},"centreon","_","storage")),(0,r.kt)("p",null,"Il y a deux types de sauvegarde :"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"MySQLdump : la commande mysqldump est utilis\xe9e pour sauvegarder la base de\ndonn\xe9es. Attention, cette commande peut prendre un certain temps si la base\nest volumineuse."),(0,r.kt)("li",{parentName:"ul"},"LVM Snapshot : Copie binaire des fichiers MariaDB. Vous devez avoir un volume\nlogique d\xe9di\xe9 \xe0 MariaDB (ex: /var/lib/mysql) et 1Go d'espace disponible dans\nson groupe de volumes.")),(0,r.kt)("p",null,"Format de la sauvegarde :"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"YYYY-MM-DD-centreon.sql.gz"),(0,r.kt)("li",{parentName:"ul"},"YYYY-MM-DD-centreon","_","storage.sql.gz")),(0,r.kt)("h4",{id:"sauvegarde-des-fichiers-de-configuration"},"Sauvegarde des fichiers de configuration"),(0,r.kt)("p",null,"Tous les fichiers de configuration du serveur central sont sauvegard\xe9s : MySQL,\nApache, PHP, SNMP, centreon, centreon-broker"),(0,r.kt)("p",null,"Format de la sauvegarde :"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"YYYY-MM-DD-centreon-engine.tar.gz (fichiers de configuration\ncentreon-engine)"),(0,r.kt)("li",{parentName:"ul"},"YYYY-MM-DD-central.tar.gz (autres fichiers de configuration)")),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"Ce chapitre d\xe9crit la configuration de la sauvegarde."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Se rendre dans le menu ",(0,r.kt)("strong",{parentName:"li"},"Administration > Param\xe8tres > Backup"),".")),(0,r.kt)("p",null,"La fen\xeatre suivante est affich\xe9e :"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:t(59746).Z,width:"1361",height:"709"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Activer la sauvegarde")," : Activer/D\xe9sactiver la sauvegarde"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"R\xe9pertoire des sauvegardes")," : R\xe9pertoire de stockage des sauvegardes"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"R\xe9pertoire temporaire")," : R\xe9pertoire utilis\xe9 durant le processus de\nsauvegarde"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Sauvegarder la base de donn\xe9es Centreon")," : Activer la sauvegarde de la\nbase de donn\xe9es centreon"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Sauvegarder la base de donn\xe9es 'centreon","_","storage'")," : Activer la\nsauvegarde de la base de donn\xe9es centreon","_","storage"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"M\xe9thode de sauvegarde")," : Type de sauvegarde (MySQL dump ou snapshot LVM)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Sauvegarde compl\xe8te")," : P\xe9riode pour la sauvegarde compl\xe8te"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Sauvegarde de type partielle")," : P\xe9riode pour la sauvegarde partielle (seulement\ndisponible pour la sauvegarde par LVM snapshot)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Dur\xe9e de r\xe9tention des sauvegardes")," : Dur\xe9e de r\xe9tention des sauvegardes (en jours)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Sauvegarder les fichiers de configuration")," : Activer la sauvegarde des fichiers de\nconfiguration"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Chemin d'acc\xe8s au fichier de configuration MySQL")," : Chemin d'acc\xe8s au fichier de configuration\nMySQL"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Activer l'export SCP")," : Activer l'export des sauvegardes par SCP. "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Utilisateur"),":  Utilisateur distant pour l'export SCP"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"H\xf4te distant")," : H\xf4te distant pour l'export SCP"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"R\xe9pertoire distant")," : R\xe9pertoire distant pour l'export SCP")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"R\xe9pertoire temporaire")," ne peut pas \xeatre un sous-r\xe9pertoire de ",(0,r.kt)("strong",{parentName:"p"},"R\xe9pertoire\ndes sauvegardes"),".")),(0,r.kt)("h2",{id:"restauration-dun-serveur-central-centreon"},"Restauration d'un serveur central Centreon"),(0,r.kt)("p",null,"Le processus de restauration consiste en deux \xe9tapes :"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"R\xe9installer la plate-forme suivant la documentation d'installation de\nCentreon. Ne pas oublier de faire la mise \xe0 jour du syst\xe8me."),(0,r.kt)("li",{parentName:"ul"},"Restaurer les diff\xe9rents fichiers de configuration, puis les bases de\ndonn\xe9es Centreon.")),(0,r.kt)("h3",{id:"restauration-des-fichiers-de-configuration-de-centreon"},"Restauration des fichiers de configuration de Centreon"),(0,r.kt)("p",null,"Avant de restaurer les bases de donn\xe9es, il faudra restaurer certains fichiers\nde configuration dans un premier temps :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/cache/centreon/backup/\ntar -xvf YYYY-MM-DD-central.tar.gz\ncd central/etc/centreon/\ncp -r * /etc/centreon/\n")),(0,r.kt)("h3",{id:"restauration-des-bases-de-donn\xe9es"},"Restauration des bases de donn\xe9es"),(0,r.kt)("p",null,"Une fois le serveur Centreon r\xe9install\xe9 (",(0,r.kt)("strong",{parentName:"p"},"m\xeame version de Centreon"),"), il\nsuffit de d\xe9compresser les sauvegardes des bases de donn\xe9es ",(0,r.kt)("strong",{parentName:"p"},"centreon")," et\n",(0,r.kt)("strong",{parentName:"p"},"centreon","_","storage"),"."),(0,r.kt)("p",null,"Commencez par recr\xe9er les bases de donn\xe9es avec les commandes suivantes :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"DROP DATABASE centreon;\nDROP DATABASE centreon_storage;\nCREATE DATABASE centreon;\nCREATE DATABASE centreon_storage;\n")),(0,r.kt)("p",null,"Puis d\xe9compressez et chargez les dumps dans les bases :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/cache/centreon/backup/\ngzip -d YYYY-MM-DD-centreon.sql.gz\nmysql centreon < YYYY-MM-DD-centreon.sql\ngzip -d YYYY-MM-DD-centreon_storage.sql.gz\nmysql centreon_storage < YYYY-MM-DD-centreon_storage.sql\n")),(0,r.kt)("p",null,"Ces op\xe9rations peuvent prendre un certain temps du fait de la taille de la base\n",(0,r.kt)("strong",{parentName:"p"},"centreon","_","storage"),"."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Le mot de passe (",(0,r.kt)("strong",{parentName:"p"},"password")," ci-dessus), est stock\xe9 dans les fichiers de\nconfiguration restaur\xe9s pr\xe9c\xe9demment. Par exemple le champ ",(0,r.kt)("strong",{parentName:"p"},"$mysql","_","passwd"),"\ndans le fichier ",(0,r.kt)("strong",{parentName:"p"},"/etc/centreon/conf.pm"),".")),(0,r.kt)("p",null,"La manipulation ci-dessus est valide pour des versions identiques de Centreon."),(0,r.kt)("h3",{id:"restauration-des-cl\xe9s-ssh"},"Restauration des cl\xe9s SSH"),(0,r.kt)("p",null,"Cette \xe9tape consiste \xe0 restaurer les cl\xe9s SSH de l'utilisateur ",(0,r.kt)("strong",{parentName:"p"},"centreon"),",\nvoir ",(0,r.kt)("strong",{parentName:"p"},"centreon-engine")," dans le cadre d'un environnement distribu\xe9. Leur\nrestauration doit \xeatre manuelle. Il faut donc dans un premier temps extraire\ncette archive dans un r\xe9pertoire temporaire puis d\xe9placer un \xe0 un les fichiers\nsuivant leur emplacement."),(0,r.kt)("p",null,"Sur le serveur central:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/cache/centreon/backup/\ntar -xvf YYYY-MM-DD-centreon-engine.tar.gz\ncd central/ssh/\nmkdir -p /var/spool/centreon/.ssh/\nchmod 700 /var/spool/centreon/.ssh/\ncp -p id_rsa /var/spool/centreon/.ssh/\ncp -p id_rsa.pub /var/spool/centreon/.ssh/\n")),(0,r.kt)("p",null,"Test de connexion du central vers les satellites:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"su - centreon\nssh <adresse_ip_address>\n")),(0,r.kt)("p",null,'R\xe9pondre "Oui" \xe0 la question.'),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Cette op\xe9ration est \xe0 effectuer si et seulement si votre plate-forme est\ndistribu\xe9e.")),(0,r.kt)("h3",{id:"restauration-des-plugins"},"Restauration des plugins"),(0,r.kt)("p",null,'Les plugins ont \xe9t\xe9 sauvegard\xe9s dans l\'archive :\n"AAAA-MM-JJ-centreon-engine.tar.gz". Leur restauration doit \xeatre manuelle. Il\nfaut donc dans un premier temps extraire cette archive dans un r\xe9pertoire\ntemporaire puis d\xe9placer un \xe0 un les fichiers suivant leur emplacement.'),(0,r.kt)("p",null,"Sur chaque collecteur, il faudra r\xe9aliser l'action suivante :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/cache/centreon/backup/\ntar -xvf YYYY-MM-DD-centreon-engine.tar.gz\ncd central/plugins\ncp -pRf * /usr/lib64/nagios/plugins/\n")),(0,r.kt)("h3",{id:"restauration-des-scripts-dinitialisation"},"Restauration des scripts d'initialisation"),(0,r.kt)("p",null,"Certains points de contr\xf4les concernant Oracle ou SAP entra\xeenent la modification\ndu script d'initialisation de l'ordonnanceur afin d'y ajouter des variables\nd'environnements. Si vous avez modifi\xe9 le script d'initialisation de votre\nordonnanceur, il faudra le restaurer."),(0,r.kt)("p",null,"Dans un premier temps extraire cette archive dans un r\xe9pertoire temporaire puis\nd\xe9placer un \xe0 un les fichiers suivant leurs emplacements :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/backup\ntar -xvf YYYY-MM-DD-centreon-engine.tar.gz\ncd backup\ncp init_d_centengine /etc/init.d/centengine\n")),(0,r.kt)("h3",{id:"restauration-des-agents-de-supervision"},"Restauration des agents de supervision"),(0,r.kt)("p",null,"Si vous utilisez les agents NRPE, ou NSCA il faudra les r\xe9installer puis\nrestaurer leur configuration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/backup\ntar -xvf YYYY-MM-DD-centreon-engine.tar.gz\ncd backup/etc\ncp nrpe.cfg /etc/centreon-engine/\ncp nsca.cfg /etc/centreon-engine/\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Cette manipulation est \xe0 utiliser si et seulement si vous utilisez les agents\nNRPE ou NSCA. Si vous utilisez NSCA le fichier de configuration \xe0 copier n'est\npas nrpe.cfg mais nsca.cfg.")),(0,r.kt)("h3",{id:"g\xe9n\xe9ration-de-la-configuration-du-central"},"G\xe9n\xe9ration de la configuration du central"),(0,r.kt)("p",null,"Une fois toutes les \xe9tapes (n\xe9cessaires) effectu\xe9es, il faudra g\xe9n\xe9rer la\nconfiguration de chaque collecteur."),(0,r.kt)("h3",{id:"reconstruction-des-graphiques"},"Reconstruction des graphiques"),(0,r.kt)("p",null,'Une fois que vous avez restaur\xe9 votre plate-forme de supervision et que tout est\nen ordre, il faudra reconstruire les fichiers RRD afin de retrouver tous vos\n"anciens" graphiques de performance.'),(0,r.kt)("p",null,"Pour reconstruire les graphiques de performance, il faudra vous rendre dans le\nmenu ",(0,r.kt)("strong",{parentName:"p"},"Administration > Param\xe8tres > Donn\xe9es"),". Sur cette page, il\nfaudra s\xe9lectionner tous les services et cliquer sur ",(0,r.kt)("strong",{parentName:"p"},"Reg\xe9n\xe9rer les bases de\ndonn\xe9es RRD"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Le serveur central est maintenant restaur\xe9.")))}m.isMDXComponent=!0},59746:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/parameters-backup-04fde21f5d31fc415a844f19b4d66d6e.png"}}]);