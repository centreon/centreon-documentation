"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[74738],{77195:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>c,default:()=>v,frontMatter:()=>d,metadata:()=>u,toc:()=>m});t(67294);var a=t(3905),r=t(51715),s=t(7626);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})),e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}const d={id:"centreon-ha-4-nodes-installation-manual-failover",title:"Installation de Centreon-HA 4 n\u0153uds \xe0 basculement manuel"},c=void 0,u={unversionedId:"installation/installation-of-centreon-ha-manual/centreon-ha-4-nodes-installation-manual-failover",id:"version-23.10/installation/installation-of-centreon-ha-manual/centreon-ha-4-nodes-installation-manual-failover",title:"Installation de Centreon-HA 4 n\u0153uds \xe0 basculement manuel",description:"Conditions pr\xe9alables",source:"@site/i18n/fr/docusaurus-plugin-content-docs/version-23.10/installation/installation-of-centreon-ha-manual/installation-4-nodes.md",sourceDirName:"installation/installation-of-centreon-ha-manual",slug:"/installation/installation-of-centreon-ha-manual/centreon-ha-4-nodes-installation-manual-failover",permalink:"/centreon-documentation/pr-preview/staging/pr-2756/fr/docs/installation/installation-of-centreon-ha-manual/centreon-ha-4-nodes-installation-manual-failover",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/i18n/fr/docusaurus-plugin-content-docs/version-23.10/installation/installation-of-centreon-ha-manual/installation-4-nodes.md",tags:[],version:"23.10",lastUpdatedAt:1699633150,formattedLastUpdatedAt:"10 nov. 2023",frontMatter:{id:"centreon-ha-4-nodes-installation-manual-failover",title:"Installation de Centreon-HA 4 n\u0153uds \xe0 basculement manuel"},sidebar:"version-23.10/docs",previous:{title:"Installation de Centreon-HA 2 n\u0153uds \xe0 basculement manuel",permalink:"/centreon-documentation/pr-preview/staging/pr-2756/fr/docs/installation/installation-of-centreon-ha-manual/centreon-ha-2-nodes-installation-manual-failover"},next:{title:"Int\xe9grer des Pollers dans un cluster Centreon-HA manuel",permalink:"/centreon-documentation/pr-preview/staging/pr-2756/fr/docs/installation/installation-of-centreon-ha-manual/integrating-pollers"}},p={},m=[{value:"Conditions pr\xe9alables",id:"conditions-pr\xe9alables",level:2},{value:"Compr\xe9hension",id:"compr\xe9hension",level:3},{value:"Installation de Centreon",id:"installation-de-centreon",level:3},{value:"D\xe9finition des noms et adresses IP des serveurs",id:"d\xe9finition-des-noms-et-adresses-ip-des-serveurs",level:3},{value:"Configuration de Centreon-broker",id:"configuration-de-centreon-broker",level:3},{value:"Lien vers le service cbd",id:"lien-vers-le-service-cbd",level:4},{value:"Double flux RRD",id:"double-flux-rrd",level:4},{value:"Exporter la configuration",id:"exporter-la-configuration",level:4},{value:"Modification de la commande <code>cbd</code> reload",id:"modification-de-la-commande-cbd-reload",level:3},{value:"Synchronisation des fichiers de configuration de Centreon (PHP, Perl, Gorgone)",id:"synchronisation-des-fichiers-de-configuration-de-centreon-php-perl-gorgone",level:3},{value:"Pr\xe9paration du syst\xe8me",id:"pr\xe9paration-du-syst\xe8me",level:2},{value:"R\xe9glage de la configuration du r\xe9seau",id:"r\xe9glage-de-la-configuration-du-r\xe9seau",level:3},{value:"R\xe9solution de noms",id:"r\xe9solution-de-noms",level:3},{value:"Installation des paquets",id:"installation-des-paquets",level:3},{value:"\xc9change de cl\xe9s SSH",id:"\xe9change-de-cl\xe9s-ssh",level:3},{value:"Compte centreon",id:"compte-centreon",level:4},{value:"Compte mysql",id:"compte-mysql",level:4},{value:"Configuration de la r\xe9plication MySQL",id:"configuration-de-la-r\xe9plication-mysql",level:2},{value:"Configuration de MySQL",id:"configuration-de-mysql",level:3},{value:"S\xe9curisation de la base de donn\xe9es",id:"s\xe9curisation-de-la-base-de-donn\xe9es",level:3},{value:"Cr\xe9ation du compte centreon",id:"cr\xe9ation-du-compte-centreon",level:3},{value:"Cr\xe9ation du compte de r\xe9plication",id:"cr\xe9ation-du-compte-de-r\xe9plication",level:3},{value:"Configuration des variables d&#39;environnement pour les scripts MySQL",id:"configuration-des-variables-denvironnement-pour-les-scripts-mysql",level:3},{value:"Passage en mode lecture seule",id:"passage-en-mode-lecture-seule",level:3},{value:"Autorisation des comptes centreon et mysql",id:"autorisation-des-comptes-centreon-et-mysql",level:3},{value:"Synchronisation des bases de donn\xe9es et d\xe9marrage de la r\xe9plication MySQL",id:"synchronisation-des-bases-de-donn\xe9es-et-d\xe9marrage-de-la-r\xe9plication-mysql",level:3},{value:"Cr\xe9ation de la VIP MySQL",id:"cr\xe9ation-de-la-vip-mysql",level:3},{value:"Configuration du cluster Centreon",id:"configuration-du-cluster-centreon",level:2},{value:"Configuration du service de synchronisation",id:"configuration-du-service-de-synchronisation",level:3},{value:"Suppression des crons",id:"suppression-des-crons",level:2},{value:"Changement de droits",id:"changement-de-droits",level:2},{value:"Arr\xeater et d\xe9sactiver les services",id:"arr\xeater-et-d\xe9sactiver-les-services",level:3},{value:"Red\xe9finir les r\xe8gles de d\xe9marrage des services",id:"red\xe9finir-les-r\xe8gles-de-d\xe9marrage-des-services",level:3},{value:"Service PHP",id:"service-php",level:4},{value:"Service Broker RRD",id:"service-broker-rrd",level:4},{value:"Cr\xe9ation de la VIP Centreon",id:"cr\xe9ation-de-la-vip-centreon",level:4},{value:"Service Httpd",id:"service-httpd",level:4},{value:"Service Gorgone",id:"service-gorgone",level:4},{value:"Service Centreon-central-sync",id:"service-centreon-central-sync",level:4},{value:"Service Broker SQL",id:"service-broker-sql",level:4},{value:"Service Centengine",id:"service-centengine",level:4},{value:"Service Centreontrapd",id:"service-centreontrapd",level:4},{value:"Service Snmptrapd",id:"service-snmptrapd",level:4},{value:"Lancement initial de tous les services",id:"lancement-initial-de-tous-les-services",level:3},{value:"Installation de l&#39;adresse IP virtuelle Centreon",id:"installation-de-ladresse-ip-virtuelle-centreon",level:4},{value:"Prise en compte des modifications apport\xe9es aux services",id:"prise-en-compte-des-modifications-apport\xe9es-aux-services",level:4},{value:"Op\xe9ration HA manuelle standard",id:"op\xe9ration-ha-manuelle-standard",level:3},{value:"Basculer les services Centreon d&#39;un n\u0153ud \xe0 l&#39;autre",id:"basculer-les-services-centreon-dun-n\u0153ud-\xe0-lautre",level:3},{value:"Inverser les r\xf4les SLAVE/MASTER de MySQL",id:"inverser-les-r\xf4les-slavemaster-de-mysql",level:3},{value:"V\xe9rification de la synchronisation des bases de donn\xe9es",id:"v\xe9rification-de-la-synchronisation-des-bases-de-donn\xe9es",level:3},{value:"Int\xe9grer des collecteurs",id:"int\xe9grer-des-collecteurs",level:2}],k={toc:m},N="wrapper";function v(e){var{components:n}=e,t=o(e,["components"]);return(0,a.kt)(N,i(function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{},a=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),a.forEach((function(n){l(e,n,t[n])}))}return e}({},k,t),{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"conditions-pr\xe9alables"},"Conditions pr\xe9alables"),(0,a.kt)("h3",{id:"compr\xe9hension"},"Compr\xe9hension"),(0,a.kt)("p",null,"Avant de suivre cette proc\xe9dure, il est recommand\xe9 d'avoir un niveau de connaissance satisfaisant du syst\xe8me d'exploitation Linux et de Centreon afin de comprendre ce qui va \xeatre fait et de pouvoir se sortir d'une \xe9ventuelle erreur."),(0,a.kt)("h3",{id:"installation-de-centreon"},"Installation de Centreon"),(0,a.kt)("p",null,"L'installation d'un cluster Centreon-HA ne peut se faire que sur la base d'une installation fonctionnelle de Centreon. Avant de suivre cette proc\xe9dure, il est donc imp\xe9ratif d'avoir appliqu\xe9 ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("a",{parentName:"strong",href:"https://docs.centreon.com/fr/docs/installation/introduction/"},"cette proc\xe9dure d'installation"))," jusqu'au bout ",(0,a.kt)("strong",{parentName:"p"},"en r\xe9servant environ 5Go d'espace libre")," sur le ",(0,a.kt)("em",{parentName:"p"},"groupe de volumes")," qui contient les donn\xe9es MySQL (point de montage ",(0,a.kt)("inlineCode",{parentName:"p"},"/var/lib/mysql")," par d\xe9faut)."),(0,a.kt)("p",null,"La commande ",(0,a.kt)("inlineCode",{parentName:"p"},"vgs")," devrait retourner un affichage de la forme ci-dessous (en particulier la valeur sous ",(0,a.kt)("inlineCode",{parentName:"p"},"VFree"),") :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"  VG                    #PV #LV #SN Attr   VSize   VFree \n  centos_centreon-c1      1   5   0 wz--n- <31,00g <5,00g\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Attention :")," Si cette condition pr\xe9alable n'est pas v\xe9rifi\xe9e, il ne sera pas possible de synchroniser les bases de donn\xe9es comme d\xe9crit dans ce document."),(0,a.kt)("h3",{id:"d\xe9finition-des-noms-et-adresses-ip-des-serveurs"},"D\xe9finition des noms et adresses IP des serveurs"),(0,a.kt)("p",null,"Dans cette proc\xe9dure, nous ferons r\xe9f\xe9rence aux param\xe8tres qui varient d'une installation \xe0 l'autre (noms et adresses IP des noeuds par exemple) via les macros suivantes :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_MASTER_IPADDR@")," : Adresse IP du serveur central principal"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_MASTER_NAME@")," : nom du serveur central principal"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_SLAVE_IPADDR@")," : adresse IP du serveur central secondaire"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_SLAVE_NAME@")," : nom du serveur central secondaire"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_MASTER_IPADDR@")," : adresse IP du serveur principal de la base de donn\xe9es"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_MASTER_NAME@")," : nom du serveur de base de donn\xe9es principal"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_SLAVE_IPADDR@")," : Adresse IP du serveur de base de donn\xe9es secondaire"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_SLAVE_NAME@")," : nom du serveur de base de donn\xe9es secondaire"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MYSQL_REPL_USER@")," : Nom du compte de r\xe9plication MySQL (sugg\xe9r\xe9 : centreon-repl)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MYSQL_REPL_PASSWD@")," : mot de passe pour ce compte"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MYSQL_CENTREON_USER@")," : Nom du compte MySQL de Centreon (sugg\xe9r\xe9 : centreon)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@MYSQL_CENTREON_PASSWD@")," : mot de passe pour ce compte"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_VIP_IPADDR@")," : adresse IP virtuelle du cluster"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_VIP_IFNAME@")," : nom de l'interface qui portera le VIP"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_VIP_CIDR_NETMASK@")," : masque de sous-r\xe9seau exprim\xe9 en nombre de bits sans le '/' (exemple : 24)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_VIP_BROADCAST_IPADDR@")," : adresse de diffusion (broadcast)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_VIP_IPADDR@")," : adresse IP virtuelle du cluster, dans le cas d'un HA \xe0 2 noeuds, elle est la m\xeame que celle du central."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_VIP_IFNAME@")," : nom de l'interface qui portera la VIP, dans le cas d'un HA \xe0 2 noeuds, c'est le m\xeame que celui de la centrale."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_VIP_CIDR_NETMASK@")," : masque de sous-r\xe9seau exprim\xe9 en nombre de bits sans le '/' (exemple : 24), dans le cas d'un HA \xe0 2 noeuds, il est identique au masque central."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DB_VIP_BROADCAST_IPADDR@")," : adresse de diffusion, dans le cas d'une HA \xe0 2 noeuds, elle est la m\xeame que celle du central.")),(0,a.kt)("h3",{id:"configuration-de-centreon-broker"},"Configuration de Centreon-broker"),(0,a.kt)("h4",{id:"lien-vers-le-service-cbd"},"Lien vers le service cbd"),(0,a.kt)("p",null,"Dans une installation Centreon standard, le service ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd")," pilote deux instances de ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon-broker-daemon")," :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"central-broker-master"),' : \xe9galement appel\xe9 "central broker" ou "SQL broker", qui redirige toutes les entr\xe9es/sorties des Pollers vers les bases de donn\xe9es, vers le broker RRD, etc.')),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"central-rrd-master")," : le RRD broker qui re\xe7oit son flux du SQL broker, et dont la seule fonction est d'\xe9crire les fichiers RRD utilis\xe9s pour afficher les graphes. "))),(0,a.kt)("p",null,"Dans un cluster Centreon-HA, les deux processus de broker seront chacun g\xe9r\xe9 par un service s\xe9par\xe9 qui sera pilot\xe9 par le cluster :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"central-broker-master")," comme ressource ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd_central_broker"),", li\xe9e au service ",(0,a.kt)("em",{parentName:"li"},"systemd")," ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd-sql"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"central-rrd-master")," comme ressource clone ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd_rrd"),", li\xe9e au service standard Centreon ",(0,a.kt)("em",{parentName:"li"},"systemd")," ",(0,a.kt)("inlineCode",{parentName:"li"},"cbd"),".")),(0,a.kt)("p",null,"Pour que tout fonctionne correctement dans la suite, vous devez maintenant d\xe9faire le lien entre central-broker-master et le service ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd")," ",(0,a.kt)("strong",{parentName:"p"},'en cochant "no" pour le param\xe8tre "Linked to cbd service "')," dans ",(0,a.kt)("em",{parentName:"p"},"Configuration")," > ",(0,a.kt)("em",{parentName:"p"},"Pollers")," > ",(0,a.kt)("em",{parentName:"p"},"Configuration broker")," > ",(0,a.kt)("em",{parentName:"p"},"central-broker-master")," dans l'onglet ",(0,a.kt)("em",{parentName:"p"},"General"),"."),(0,a.kt)("h4",{id:"double-flux-rrd"},"Double flux RRD"),(0,a.kt)("p",null,"Plut\xf4t que de mettre en place une r\xe9plication en temps r\xe9el des fichiers de donn\xe9es RRD, le choix technique qui a \xe9t\xe9 fait pour permettre aux graphiques d'\xeatre affich\xe9 sur n'importe quel noeud d\xe8s qu'il devient ",(0,a.kt)("inlineCode",{parentName:"p"},"master")," a \xe9t\xe9 de dupliquer le flux de sortie de ",(0,a.kt)("inlineCode",{parentName:"p"},"central-broker-master")," vers ",(0,a.kt)("inlineCode",{parentName:"p"},"central-rrd-master"),". Ceci est configur\xe9 dans le m\xeame menu que dans le paragraphe pr\xe9c\xe9dent, mais cette fois dans l'onglet ",(0,a.kt)("em",{parentName:"p"},"Output")," de ",(0,a.kt)("em",{parentName:"p"},"Configuration > Collectors > Centreon Broker Configuration"),"."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},'Modifiez la sortie "IPv4" en rempla\xe7ant "localhost" par ',(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_MASTER_IPADDR@"),".")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Sortie IPv4"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Nom"),(0,a.kt)("td",{parentName:"tr",align:null},"centreon-broker-master-rrd")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Port de connexion"),(0,a.kt)("td",{parentName:"tr",align:null},"5670")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"H\xf4te auquel se connecter"),(0,a.kt)("td",{parentName:"tr",align:null},"`@CENTRAL_MASTER_IPADDR@'")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"D\xe9lai de mise en m\xe9moire tampon"),(0,a.kt)("td",{parentName:"tr",align:null},"0")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Intervalle de r\xe9essai"),(0,a.kt)("td",{parentName:"tr",align:null},"60")))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},'Ajouter une nouvelle sortie IPv4, similaire \xe0 la premi\xe8re et nomm\xe9e par exemple "centreon-broker-slave-rrd" pointant cette fois sur ',(0,a.kt)("inlineCode",{parentName:"li"},"@CENTRAL_SLAVE_IPADDR@"),".")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Sortie IPv4"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Nom"),(0,a.kt)("td",{parentName:"tr",align:null},"centreon-broker-slave-rrd")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Port de connexion"),(0,a.kt)("td",{parentName:"tr",align:null},"5670")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"H\xf4te auquel se connecter"),(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"@CENTRAL_SLAVE_IPADDR@"))),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"D\xe9lai de mise en m\xe9moire tampon"),(0,a.kt)("td",{parentName:"tr",align:null},"0")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Intervalle de r\xe9essai"),(0,a.kt)("td",{parentName:"tr",align:null},"60")))),(0,a.kt)("h4",{id:"exporter-la-configuration"},"Exporter la configuration"),(0,a.kt)("p",null,"Une fois les actions des deux paragraphes pr\xe9c\xe9dents effectu\xe9es, la configuration doit \xeatre export\xe9e (3 premi\xe8res cases pour l'exportation du Poller \"Central\") pour qu'elle soit effective."),(0,a.kt)("p",null,"Ces actions doivent \xeatre effectu\xe9es soit sur les deux noeuds, soit uniquement sur ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," et ensuite les fichiers de configuration du broker doivent \xeatre copi\xe9s sur ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rsync -a /etc/centreon-broker/*json @CENTRAL_SLAVE_IPADDR@:/etc/centreon-broker/\n")),(0,a.kt)("h3",{id:"modification-de-la-commande-cbd-reload"},"Modification de la commande ",(0,a.kt)("inlineCode",{parentName:"h3"},"cbd")," reload"),(0,a.kt)("p",null,"Ceci n'est peut-\xeatre pas connu de tous les utilisateurs de Centreon, mais \xe0 chaque fois qu'un rechargement de la configuration du Poller central est effectu\xe9 via l'interface, le service broker (",(0,a.kt)("inlineCode",{parentName:"p"},"cbd"),') est recharg\xe9 (et pas seulement centengine), d\'o\xf9 le param\xe8tre "Centreon Broker reload command" dans ',(0,a.kt)("em",{parentName:"p"},"Configuration > Pollers > Central"),"."),(0,a.kt)("p",null,"Comme expliqu\xe9 ci-dessus, les processus du broker sont r\xe9partis entre deux services : ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd")," pour le courtier RRD, ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd-sql")," pour le courtier central. Dans le contexte d'un cluster centreon-ha, le service qui doit \xeatre recharg\xe9 lors de l'exportation de la configuration est ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd-sql")," et non ",(0,a.kt)("inlineCode",{parentName:"p"},"cbd"),". Vous devez donc appliquer la valeur ",(0,a.kt)("inlineCode",{parentName:"p"},"service cbd-sql reload"),' au param\xe8tre "Centreon Broker reload command".'),(0,a.kt)("h3",{id:"synchronisation-des-fichiers-de-configuration-de-centreon-php-perl-gorgone"},"Synchronisation des fichiers de configuration de Centreon (PHP, Perl, Gorgone)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rsync -av /etc/centreon/* root@@CENTRAL_SLAVE_IPADDR@:/etc/centreon/\n")),(0,a.kt)("h2",{id:"pr\xe9paration-du-syst\xe8me"},"Pr\xe9paration du syst\xe8me"),(0,a.kt)("p",null,"Avant de passer \xe0 la configuration proprement dite du cluster, quelques \xe9tapes pr\xe9paratoires sont n\xe9cessaires au niveau du syst\xe8me d'exploitation."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note :")," sauf indication contraire, chacune des \xe9tapes suivantes doit \xeatre effectu\xe9e ",(0,a.kt)("strong",{parentName:"p"},"sur les deux noeuds centraux"),"."),(0,a.kt)("h3",{id:"r\xe9glage-de-la-configuration-du-r\xe9seau"},"R\xe9glage de la configuration du r\xe9seau"),(0,a.kt)("p",null,"Afin d'am\xe9liorer la fiabilit\xe9 du cluster et puisque ",(0,a.kt)("em",{parentName:"p"},"Centreon HA")," ne fonctionne que sur IP v4, il est recommand\xe9 d'appliquer les r\xe9glages suivants sur tous les serveurs de la plateforme Centreon :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cat >> /etc/sysctl.conf <<EOF\nnet.ipv6.conf.all.disable_ipv6 = 1\nnet.ipv6.conf.default.disable_ipv6 = 1\nnet.ipv4.tcp_retries2 = 3\nnet.ipv4.tcp_keepalive_time = 200\nnet.ipv4.tcp_keepalive_probes = 2\nnet.ipv4.tcp_keepalive_intvl = 2\nEOF\nsystemctl restart NetworkManager\n")))),(0,a.kt)("p",null,"Pour \xe9viter les probl\xe8mes li\xe9s \xe0 la gestion des adresses IP fixes et virtuelles, il est n\xe9cessaire de d\xe9clarer l'adresse IP fixe de chaque serveur dans la configuration du r\xe9seau."),(0,a.kt)("p",null,"Pour ce faire, ex\xe9cutez les commandes suivantes sur chaque n\u0153ud :"),(0,a.kt)("p",null,"Pour le serveur ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod @CENTRAL_VIP_IFNAME@ +ipv4.addresses "@CENTRAL_MASTER_IPADDR@/@CENTRAL_VIP_CIDR_NETMASK@"\nnmcli con up @CENTRAL_VIP_IFNAME@\n')),(0,a.kt)("p",null,"Pour le serveur ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod @CENTRAL_VIP_IFNAME@ +ipv4.addresses "@CENTRAL_SLAVE_IPADDR@/@CENTRAL_VIP_CIDR_NETMASK@"\nnmcli con up @CENTRAL_VIP_IFNAME@\n')),(0,a.kt)("p",null,"Pour le serveur ",(0,a.kt)("inlineCode",{parentName:"p"},"@DB_MASTER_NAME@")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod @DB_VIP_IFNAME@ +ipv4.addresses "@DB_MASTER_IPADDR@/@DB_VIP_CIDR_NETMASK@"\nnmcli con up @DB_VIP_IFNAME@\n')),(0,a.kt)("p",null,"Pour le serveur ",(0,a.kt)("inlineCode",{parentName:"p"},"@DB_SLAVE_NAME@"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod @DB_VIP_IFNAME@ +ipv4.addresses "@DB_SLAVE_IPADDR@/@DB_VIP_CIDR_NETMASK@"\nnmcli con up @DB_VIP_IFNAME@\n')),(0,a.kt)("p",null,"Vous pouvez v\xe9rifier sur chaque noeud si l'adresse IP est d\xe9clar\xe9e avec cette commande sur le noeud Central par exemple :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cat /etc/sysconfig/network-scripts/ifcfg-@CENTRAL_VIP_IFNAME@\n")),(0,a.kt)("p",null,"Le r\xe9sultat est le m\xeame pour ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"...\nDEVICE=@CENTRAL_VIP_IFNAME@\nONBOOT=yes\nIPADDR=@CENTRAL_MASTER_IPADDR@\nPREFIX=23\n...\n")),(0,a.kt)("h3",{id:"r\xe9solution-de-noms"},"R\xe9solution de noms"),(0,a.kt)("p",null,"Afin de s'assurer que le cluster fonctionne correctement m\xeame si le service de r\xe9solution de nom \xe9choue, il est imp\xe9ratif que les noeuds se connaissent \xe0 travers le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat >/etc/hosts <<"EOF"\n127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n@CENTRAL_MASTER_IPADDR@ @CENTRAL_MASTER_NAME@\n@CENTRAL_SLAVE_IPADDR@ @CENTRAL_SLAVE_NAME@\n@DB_MASTER_IPADDR@ @DB_MASTER_NAME@\n@DB_SLAVE_IPADDR@ @DB_SLAVE_NAME@\nEOF\n')),(0,a.kt)("p",null,"Dans la suite de ce document, nous ferons r\xe9f\xe9rence au n\u0153ud primaire comme \xe9tant le n\u0153ud principal et au n\u0153ud secondaire comme \xe9tant le n\u0153ud secondaire. Cette distinction est purement arbitraire, les r\xf4les peuvent bien s\xfbr \xeatre \xe9chang\xe9s une fois l'installation termin\xe9e."),(0,a.kt)("h3",{id:"installation-des-paquets"},"Installation des paquets"),(0,a.kt)("p",null,"Centreon propose le paquet ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon-ha"),", qui fournit tous les scripts et d\xe9pendances n\xe9cessaires au fonctionnement d'un cluster Centreon."),(0,a.kt)("p",null,"Sur les serveurs centraux :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma Linux 8",label:"Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ha\ndnf install centreon-ha-web\n"))),(0,a.kt)(s.Z,{value:"RHEL 8",label:"RHEL 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"subscription-manager repos --enable rhel-8-for-x86_64-highavailability-rpms\ndnf install centreon-ha-web\n"))),(0,a.kt)(s.Z,{value:"Oracle Linux 8",label:"Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ol8_addons\ndnf install centreon-ha-web\n")))),(0,a.kt)("p",null,"Puis, sur les serveurs de bases de donn\xe9es :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma Linux 8",label:"Alma Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ha\ndnf install centreon-ha-common\n"))),(0,a.kt)(s.Z,{value:"RHEL 8",label:"RHEL 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"subscription-manager repos --enable rhel-8-for-x86_64-highavailability-rpms\ndnf install centreon-ha-common\n"))),(0,a.kt)(s.Z,{value:"Oracle Linux 8",label:"Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dnf config-manager --enable ol8_addons\ndnf install centreon-ha-common\n")))),(0,a.kt)("h3",{id:"\xe9change-de-cl\xe9s-ssh"},"\xc9change de cl\xe9s SSH"),(0,a.kt)("p",null,"Afin de permettre aux serveurs d'\xe9changer des fichiers et des commandes, il est n\xe9cessaire de configurer la possibilit\xe9 de se connecter via SSH d'un serveur \xe0 l'autre pour les utilisateurs :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mysql")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"centreon"))),(0,a.kt)("p",null,"Il y a 2 fa\xe7ons d'\xe9changer des cl\xe9s SSH:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"En utilisant ",(0,a.kt)("inlineCode",{parentName:"li"},"sh-copy-id")," : l'utilisation de cette commande n\xe9cessite de pouvoir valider l'authentification avec un mot de passe. Cependant, il n'est pas souhaitable de d\xe9finir un mot de passe pour les comptes de service dont nous parlons ici. Si cette m\xe9thode est quand m\xeame utilis\xe9e, il est recommand\xe9 de supprimer le mot de passe apr\xe8s l'\xe9change, avec les commandes ",(0,a.kt)("inlineCode",{parentName:"li"},"passwd -d centreon")," et ",(0,a.kt)("inlineCode",{parentName:"li"},"passwd -d mysql"),"."),(0,a.kt)("li",{parentName:"ul"},"En copiant manuellement la cl\xe9 publique dans ",(0,a.kt)("inlineCode",{parentName:"li"},"~/.ssh/authorized_keys"),". Cette m\xe9thode est \xe0 privil\xe9gier, mais n\xe9cessite, pour fonctionner correctement, que seul le propri\xe9taire du fichier soit en mesure de le lire.")),(0,a.kt)("p",null,"C'est la deuxi\xe8me m\xe9thode qui sera propos\xe9e ci-dessous."),(0,a.kt)("h4",{id:"compte-centreon"},"Compte centreon"),(0,a.kt)("p",null,"Cette proc\xe9dure doit \xeatre appliqu\xe9e sur les deux noeuds centraux. Pour commencer, passez dans l'environnement ",(0,a.kt)("inlineCode",{parentName:"p"},"bash")," de ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"su - centreon\n")),(0,a.kt)("p",null,"Ensuite, ex\xe9cutez ces commandes sur les deux noeuds centraux:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-keygen -t ed25519 -a 100\ncat ~/.ssh/id_ed25519.pub | tee ~/.ssh/authorized_keys\n")),(0,a.kt)("p",null,"Apr\xe8s avoir ex\xe9cut\xe9 ces commandes sur les deux noeuds, copiez le contenu du fichier qui a \xe9t\xe9 affich\xe9 par la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"cat")," et collez-le dans le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.ssh/authorized_keys")," ",(0,a.kt)("strong",{parentName:"p"},"sur l'autre noeud")," puis appliquez les permissions correctes au fichier (toujours en tant que ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 600 ~/.ssh/authorized_keys\n")),(0,a.kt)("p",null,"L'\xe9change de cl\xe9s doit ensuite \xeatre valid\xe9 par une premi\xe8re connexion qui acceptera la signature du serveur SSH (toujours sous le nom de ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssh @CENTRAL_MASTER_NAME@\nssh @CENTRAL_SLAVE_NAME@\n")),(0,a.kt)("p",null,"Then exit the ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon")," session with ",(0,a.kt)("inlineCode",{parentName:"p"},"exit")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"Ctrl-D"),"."),(0,a.kt)("p",null,"Ensuite, quittez la session ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon")," avec ",(0,a.kt)("inlineCode",{parentName:"p"},"exit")," ou ",(0,a.kt)("inlineCode",{parentName:"p"},"Ctrl-D"),"."),(0,a.kt)("h4",{id:"compte-mysql"},"Compte mysql"),(0,a.kt)("p",null,"Pour le compte ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),", la proc\xe9dure diff\xe8re quelque peu car cet utilisateur n'a normalement pas de ",(0,a.kt)("em",{parentName:"p"},"r\xe9pertoire personnel")," ni la possibilit\xe9 d'ouvrir une session Shell. Cette proc\xe9dure doit \xeatre appliqu\xe9e sur les deux noeuds de la base de donn\xe9es."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop mysql\nmkdir /home/mysql\nchown mysql: /home/mysql\nusermod -d /home/mysql mysql\nusermod -s /bin/bash mysql\ntouch /var/log/mysqld.log\nchown mysql. /var/log/mysqld.log\nsystemctl start mysql\n")),(0,a.kt)("p",null,"Ensuite, passez \xe0 l'environnement ",(0,a.kt)("inlineCode",{parentName:"p"},"bash")," de ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," et g\xe9n\xe9rez les cl\xe9s SSH, ex\xe9cutez ces commandes sur les deux ",(0,a.kt)("strong",{parentName:"p"},"n\u0153uds de base de donn\xe9es"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"su - mysql\nssh-keygen -t ed25519 -a 100\ncat ~/.ssh/id_ed25519.pub | tee ~/.ssh/authorized_keys\n")),(0,a.kt)("p",null,"Apr\xe8s avoir ex\xe9cut\xe9 ces commandes sur les deux noeuds, copiez le contenu du fichier et collez-le dans ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.ssh/authorized_keys")," ",(0,a.kt)("strong",{parentName:"p"},"sur l'autre noeud")," et appliquez ensuite les permissions correctes au fichier (toujours en tant que ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 600 ~/.ssh/authorized_keys\n")),(0,a.kt)("p",null,'L\'\xe9change de cl\xe9s doit ensuite \xeatre valid\xe9 par une premi\xe8re connexion qui acceptera la signature du serveur SSH en tapant "yes" (toujours comme ',(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssh @DB_MASTER_NAME@\nssh @DB_SLAVE_NAME@\n")),(0,a.kt)("p",null,"Ensuite, quittez la session ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," avec ",(0,a.kt)("inlineCode",{parentName:"p"},"exit")," ou ",(0,a.kt)("inlineCode",{parentName:"p"},"Ctrl-D"),"."),(0,a.kt)("h2",{id:"configuration-de-la-r\xe9plication-mysql"},"Configuration de la r\xe9plication MySQL"),(0,a.kt)("p",null,"Pour que les deux noeuds soient interchangeables \xe0 tout moment, les deux bases de donn\xe9es doivent \xeatre r\xe9pliqu\xe9es en permanence. Pour ce faire, nous allons mettre en place une r\xe9plication ma\xeetre-esclave.\nDepuis Centreon 22.04, la r\xe9plication de mariaDB est maintenant bas\xe9e sur ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("a",{parentName:"strong",href:"https://mariadb.com/kb/en/gtid/"},"GTID")),"."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note:")," sauf indication contraire, chacune des \xe9tapes suivantes doit \xeatre effectu\xe9e ",(0,a.kt)("strong",{parentName:"p"},"sur les deux n\u0153uds de base de donn\xe9es"),"."),(0,a.kt)("h3",{id:"configuration-de-mysql"},"Configuration de MySQL"),(0,a.kt)("p",null,"Pour commencer, nous devons r\xe9gler la configuration de MySQL, qui sera concentr\xe9e dans le fichier unique ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/my.cnf.d/server.cnf"),".  Par d\xe9faut, la section ",(0,a.kt)("inlineCode",{parentName:"p"},"[server]")," de ce fichier est vide, et c'est l\xe0 que les lignes suivantes doivent \xeatre coll\xe9es:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nsql_mode = 'NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'\nserver-id=1 # SET TO 1 FOR MASTER AND 2 FOR SLAVE\n#read_only\nlog-bin=mysql-bin\nbinlog-do-db=centreon\nbinlog-do-db=centreon_storage\ninnodb_flush_log_at_trx_commit=1\nsync_binlog=1\nbinlog_format=MIXED\nslave_compressed_protocol=1\ndatadir=/var/lib/mysql\npid-file=/var/lib/mysql/mysql.pid\nskip-slave-start\nlog-slave-updates\ngtid_strict_mode=ON\nexpire_logs_days=7\nignore-db-dir=lost+found\n\n# Tuning standard Centreon\ninnodb_file_per_table=1\nopen_files_limit=32000\nkey_buffer_size=256M\nsort_buffer_size=32M\njoin_buffer_size=4M\nthread_cache_size=64\nread_buffer_size=512K\nread_rnd_buffer_size=256K\nmax_allowed_packet=64M\n# Uncomment for 4 Go Ram\n#innodb_buffer_pool_size=512M\n# Uncomment for 8 Go Ram\n#innodb_buffer_pool_size=1G\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Important"),": la valeur de ",(0,a.kt)("inlineCode",{parentName:"p"},"server-id")," doit \xeatre diff\xe9rente d'un serveur \xe0 l'autre, afin qu'ils puissent s'identifier correctement. Les valeurs 1 => Ma\xeetre et 2 => Esclave ne sont pas obligatoires mais sont recommand\xe9es."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"NB"),": N'oubliez pas de d\xe9commenter (enlever le '#' en d\xe9but de ligne) le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"innodb_buffer_pool_size")," qui correspond \xe0 votre plateforme."),(0,a.kt)("p",null,"Pour que ces modifications soient prises en compte, vous devez red\xe9marrer le serveur de base de donn\xe9es:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart mariadb\n")),(0,a.kt)("p",null,"Assurez-vous que le red\xe9marrage a r\xe9ussi avec la commande suivante:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl status mariadb\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Attention")," : Le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.cnf")," ne sera plus pris en compte, si des param\xe8tres y ont \xe9t\xe9 personnalis\xe9s, ils doivent \xeatre transf\xe9r\xe9s dans ",(0,a.kt)("inlineCode",{parentName:"p"},"server.cnf"),"."),(0,a.kt)("h3",{id:"s\xe9curisation-de-la-base-de-donn\xe9es"},"S\xe9curisation de la base de donn\xe9es"),(0,a.kt)("p",null,"L'acc\xe8s aux bases de donn\xe9es doit \xeatre restreint le plus strictement possible. La commande ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql_secure_installation")," permet de supprimer les acc\xe8s non prot\xe9g\xe9s par des mots de passe et la base de donn\xe9es de test. Ex\xe9cutez cette commande et laissez-vous guider par les choix par d\xe9faut. Faites attention \xe0 choisir un mot de passe qui n'appartient \xe0 aucun dictionnaire."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mysql_secure_installation\n")),(0,a.kt)("h3",{id:"cr\xe9ation-du-compte-centreon"},"Cr\xe9ation du compte centreon"),(0,a.kt)("p",null,"Pour pouvoir administrer les utilisateurs de MySQL, vous devez d'abord vous connecter en tant que root (avec le mot de passe saisi dans le paragraphe pr\xe9c\xe9dent) :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"mysql -p\n")),(0,a.kt)("p",null,"Puis collez dans l'invite MySQL les commandes ci-dessous en changeant les adresses IP et les mots de passe."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER '@MYSQL_CENTREON_USER@'@'@CENTRAL_SLAVE_IPADDR@' IDENTIFIED BY '@MYSQL_CENTREON_PASSWD@';\nGRANT ALL PRIVILEGES ON centreon.* TO '@MYSQL_CENTREON_USER@'@'@CENTRAL_SLAVE_IPADDR@';\nGRANT ALL PRIVILEGES ON centreon_storage.* TO '@MYSQL_CENTREON_USER@'@'@CENTRAL_SLAVE_IPADDR@';\n\nCREATE USER '@MYSQL_CENTREON_USER@'@'@CENTRAL_MASTER_IPADDR@' IDENTIFIED BY '@MYSQL_CENTREON_PASSWD@';\nGRANT ALL PRIVILEGES ON centreon.* TO '@MYSQL_CENTREON_USER@'@'@CENTRAL_MASTER_IPADDR@';\nGRANT ALL PRIVILEGES ON centreon_storage.* TO '@MYSQL_CENTREON_USER@'@'@CENTRAL_MASTER_IPADDR@';\n")),(0,a.kt)("h3",{id:"cr\xe9ation-du-compte-de-r\xe9plication"},"Cr\xe9ation du compte de r\xe9plication"),(0,a.kt)("p",null,"Toujours dans le prompt MySQL (voir paragraphe pr\xe9c\xe9dent) cr\xe9ez l'utilisateur ",(0,a.kt)("inlineCode",{parentName:"p"},"@MYSQL_REPL_USER@"),", d\xe9di\xe9 \xe0 la r\xe9plication, en utilisant les commandes suivantes :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER '@MYSQL_REPL_USER@'@'localhost' IDENTIFIED BY '@MYSQL_REPL_PASSWD@';\nGRANT PROCESS, RELOAD, SHUTDOWN, SUPER, REPLICATION CLIENT, REPLICATION SLAVE ON *.* TO '@MYSQL_REPL_USER@'@'localhost';\n\nCREATE USER '@MYSQL_REPL_USER@'@'@CENTRAL_SLAVE_IPADDR@' IDENTIFIED BY '@MYSQL_REPL_PASSWD@';\nGRANT PROCESS, RELOAD, SHUTDOWN, SUPER, REPLICATION CLIENT, REPLICATION SLAVE ON *.* TO '@MYSQL_REPL_USER@'@'@DB_SLAVE_IPADDR@';\n\nCREATE USER '@MYSQL_REPL_USER@'@'@CENTRAL_MASTER_IPADDR@' IDENTIFIED BY '@MYSQL_REPL_PASSWD@';\nGRANT PROCESS, RELOAD, SHUTDOWN, SUPER, REPLICATION CLIENT, REPLICATION SLAVE ON *.* TO '@MYSQL_REPL_USER@'@'@DB_MASTER_IPADDR@';\n")),(0,a.kt)("h3",{id:"configuration-des-variables-denvironnement-pour-les-scripts-mysql"},"Configuration des variables d'environnement pour les scripts MySQL"),(0,a.kt)("p",null,"Le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/centreon-ha/mysql-resources.sh")," contient des variables d'environnement qui doivent \xeatre adapt\xe9es \xe0 l'installation actuelle en rempla\xe7ant les macros par la valeur appropri\xe9e."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\n###############################\n# Database access credentials #\n###############################\n\nDBHOSTNAMEMASTER='@DB_MASTER_NAME@'\nDBHOSTNAMESLAVE='@DB_SLAVE_NAME@'\nDBREPLUSER='@MYSQL_REPL_USER@'\nDBREPLPASSWORD='@MYSQL_REPL_PASSWD@'\nDBROOTUSER='@MYSQL_REPL_USER@'\nDBROOTPASSWORD='@MYSQL_REPL_PASSWD@'\nCENTREON_DB='centreon'\nCENTREON_STORAGE_DB='centreon_storage'\n\n##########################################\n# Manual failover additional informations #\n##########################################\n\nCENTRAL_VIP_IPADDR='@CENTRAL_VIP_IPADDR@'\nCENTRAL_VIP_IFNAME='@CENTRAL_VIP_IFNAME@'\nCENTRAL_VIP_CIDR_NETMASK='@CENTRAL_VIP_CIDR_NETMASK@'\nCENTRAL_VIP_BROADCAST_IPADDR='@CENTRAL_VIP_BROADCAST_IPADDR@'\nMYSQL_VIP_IPADDR='@DB_VIP_IPADDR@'\nMYSQL_VIP_IFNAME='@DB_VIP_IFNAME@'\nMYSQL_VIP_CIDR_NETMASK='@DB_VIP_CIDR_NETMASK@'\nMYSQL_VIP_BROADCAST_IPADDR='@DB_VIP_BROADCAST_IPADDR@'\n")),(0,a.kt)("p",null,"Pour s'assurer que les derni\xe8res \xe9tapes ont \xe9t\xe9 effectu\xe9es correctement, et que les noms, identifiants et mots de passe corrects ont \xe9t\xe9 saisis dans le fichier de configuration, ex\xe9cutez la commande :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"Le r\xe9sultat attendu est le suivant :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection Status '@DB_MASTER_NAME@' [OK]\nConnection Status '@DB_SLAVE_NAME@' [OK]\nSlave Thread Status [KO]\nError reports:\n    No slave (maybe because we cannot check a server).\nPosition Status [SKIP]\n!Error reports:\n    Skip because we can't identify a unique slave.\n")),(0,a.kt)("p",null,"Ce qu'il est important de v\xe9rifier, c'est que les deux premiers tests de connexion sont ",(0,a.kt)("inlineCode",{parentName:"p"},"OK"),"."),(0,a.kt)("h3",{id:"passage-en-mode-lecture-seule"},"Passage en mode lecture seule"),(0,a.kt)("p",null,"Maintenant que tout est correctement configur\xe9, nous devons activer le mode lecture seule sur les deux serveurs en d\xe9commentant (",(0,a.kt)("em",{parentName:"p"},"ie.")," enlever le ",(0,a.kt)("inlineCode",{parentName:"p"},"#")," en d\xe9but de ligne) cette d\xe9claration dans le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/my.cnf.d/server.cnf")," :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"N\u0153ud principal")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nserver-id=1\nread_only\nlog-bin=mysql-bin\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"N\u0153ud secondaire")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[server]\nserver-id=2\nread_only\nlog-bin=mysql-bin\n")),(0,a.kt)("p",null,"Ensuite, appliquez ce changement en red\xe9marrant MySQL sur les deux n\u0153uds :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart mariadb\n")),(0,a.kt)("h3",{id:"autorisation-des-comptes-centreon-et-mysql"},"Autorisation des comptes centreon et mysql"),(0,a.kt)("p",null,"Pour que les scripts s'ex\xe9cutent correctement \xe0 travers les connexions ssh via les comptes centreon et mysql, il faut leur donner des droits suppl\xe9mentaires"),(0,a.kt)("p",null,"Pour le compte centreon, \xe9ditez le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/sudoers.d/centreon-cluster")," et ajoutez les lignes suivantes :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"CENTREON   ALL = NOPASSWD: /usr/bin/systemctl reload centreon\nCENTREON   ALL = NOPASSWD: /usr/bin/systemctl restart centreon\nCENTREON   ALL = NOPASSWD: /usr/bin/systemctl stop centreon\nCENTREON   ALL = NOPASSWD: /usr/bin/systemctl start centreon\nCENTREON   ALL = NOPASSWD: /usr/bin/nmcli\n\n")),(0,a.kt)("p",null,"Pour le compte mysql, modifiez le fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/sudoers.d/centreon-cluster-db")," et ajoutez la ligne suivante :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"MYSQL   ALL = NOPASSWD: /usr/bin/nmcli\n")),(0,a.kt)("h3",{id:"synchronisation-des-bases-de-donn\xe9es-et-d\xe9marrage-de-la-r\xe9plication-mysql"},"Synchronisation des bases de donn\xe9es et d\xe9marrage de la r\xe9plication MySQL"),(0,a.kt)("p",null,"Pour synchroniser les bases de donn\xe9es, arr\xeatez le service ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql")," sur le noeud secondaire pour \xe9craser ses donn\xe9es avec celles du serveur principal. "),(0,a.kt)("p",null,"Vous devez donc ex\xe9cuter la commande suivante ",(0,a.kt)("strong",{parentName:"p"},"sur le noeud secondaire")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop mariadb\n")),(0,a.kt)("p",null,"Dans certains cas, systemd peut \xe9chouer \xe0 arr\xeater le service ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),", pour en \xeatre s\xfbr, v\xe9rifiez que la commande suivante ne renvoie aucune ligne :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ps -ef | grep mysql[d]\n")),(0,a.kt)("p",null,"Si un processus ",(0,a.kt)("inlineCode",{parentName:"p"},"mysqld")," est toujours en cours d'ex\xe9cution, alors la commande suivante doit \xeatre ex\xe9cut\xe9e pour l'arr\xeater (et fournir le mot de passe root mysql lorsqu'il est demand\xe9) :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mysqladmin -p shutdown\n")),(0,a.kt)("p",null,"Une fois le service arr\xeat\xe9 sur le n\u0153ud ",(0,a.kt)("strong",{parentName:"p"},"secondaire"),", ex\xe9cutez le script de synchronisation ",(0,a.kt)("strong",{parentName:"p"},"depuis le n\u0153ud principal")," : "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-sync-bigdb.sh\n")),(0,a.kt)("p",null,"Ce script fait ce qui suit :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"v\xe9rifier que mysql est arr\xeat\xe9 sur le n\u0153ud secondaire"),(0,a.kt)("li",{parentName:"ul"},"arr\xeater mysql sur le noeud primaire"),(0,a.kt)("li",{parentName:"ul"},"monter un snapshot LVM sur le ",(0,a.kt)("em",{parentName:"li"},"groupe de volumes")," qui supporte la partition /var/lib/mysql"),(0,a.kt)("li",{parentName:"ul"},"D\xe9marrer mysql sur le n\u0153ud primaire"),(0,a.kt)("li",{parentName:"ul"},"stocker la position actuelle dans les journaux binaires"),(0,a.kt)("li",{parentName:"ul"},"D\xe9sactiver la variable globale MySQL ",(0,a.kt)("inlineCode",{parentName:"li"},"read_only")," sur le noeud principal (*c'est-\xe0-dire que le noeud principal est maintenant autoris\xe9 \xe0 \xe9crire dans sa base de donn\xe9es)"),(0,a.kt)("li",{parentName:"ul"},"Synchroniser tous les fichiers de donn\xe9es (\xe0 l'exception de la base de donn\xe9es syst\xe8me ",(0,a.kt)("inlineCode",{parentName:"li"},"mysql"),") en \xe9crasant les fichiers sur le noeud secondaire."),(0,a.kt)("li",{parentName:"ul"},"D\xe9montage du snapshot LVM"),(0,a.kt)("li",{parentName:"ul"},"cr\xe9er le thread de r\xe9plication qui maintiendra les donn\xe9es \xe0 jour sur le noeud secondaire.")),(0,a.kt)("p",null,"Ce script est tr\xe8s verbeux, et tout ce qui est affich\xe9 n'est pas compr\xe9hensible, mais pour s'assurer qu'il a \xe9t\xe9 ex\xe9cut\xe9 jusqu'au bout, assurez-vous que la fin ressemble \xe0 :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},'Umount and Delete LVM snapshot\n  Logical volume "dbbackupdatadir" successfully removed\nStart MySQL Slave\nOK\nStart Replication\nId  User    Host    db  Command Time    State   Info    Progress\n3   @MYSQL_REPL_USER@   @DB_MASTER_NAME@:33084  NULL    Query   0   init    show processlist    0.000\n')),(0,a.kt)("p",null,"Si tout s'est bien pass\xe9, alors la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql-check-status.sh")," devrait retourner un r\xe9sultat sans erreur :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"R\xe9sultat escompt\xe9 :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Connection Status '@DB_MASTER_NAME@' [OK]\nConnection Status '@DB_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("h3",{id:"cr\xe9ation-de-la-vip-mysql"},"Cr\xe9ation de la VIP MySQL"),(0,a.kt)("p",null,"La VIP sera ajout\xe9e \xe0 la configuration de l'interface ",(0,a.kt)("inlineCode",{parentName:"p"},"@DB_VIP_IFNAME@")," sur ",(0,a.kt)("strong",{parentName:"p"},"le n\u0153ud ma\xeetre de la base de donn\xe9es")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod "@DB_VIP_IFNAME@" +ipv4.addresses "@DB_VIP_IPADDR@/@DB_VIP_CIDR_NETMASK@"\nnmcli connection up "@DB_VIP_IFNAME@"\n')),(0,a.kt)("p",null,"Ex\xe9cutez ensuite le script suivant ",(0,a.kt)("strong",{parentName:"p"},"sur l'un des deux n\u0153uds MySQL")," pour v\xe9rifier si la VIP est correctement mont\xe9e sur le serveur ma\xeetre MySQL (ce script peut \xeatre ex\xe9cut\xe9 sur l'un ou l'autre des deux n\u0153uds, il d\xe9tectera de lui-m\xeame lequel est le ma\xeetre) :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/move-mysql-vip-to-mysql-master.sh\n")),(0,a.kt)("p",null,"Le r\xe9sultat devrait \xeatre comme ceci, sinon le script d\xe9place la VIP au bon endroit :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"The VIP address is already at the right place. Nothing to do.\n")),(0,a.kt)("h2",{id:"configuration-du-cluster-centreon"},"Configuration du cluster Centreon"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note :")," sauf indication contraire, chacune des \xe9tapes suivantes doit \xeatre effectu\xe9e ",(0,a.kt)("strong",{parentName:"p"},"sur les deux n\u0153uds centraux"),"."),(0,a.kt)("h3",{id:"configuration-du-service-de-synchronisation"},"Configuration du service de synchronisation"),(0,a.kt)("p",null,"Le service ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon-central-sync")," n\xe9cessite que nous d\xe9finissions pour chaque noeud dans ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/centreon-ha/centreon_central_sync.pm")," l'adresse IP de son correspondant :"),(0,a.kt)("p",null,"Ainsi pour le serveur ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," nous devons avoir :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'our %centreon_central_sync_config = (\n    peer_addr => "@CENTRAL_SLAVE_IPADDR@"\n);\n1;\n')),(0,a.kt)("p",null,"Et pour le serveur ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@")," nous devons avoir :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'our %centreon_central_sync_config = (\n    peer_addr => "@CENTRAL_MASTER_IPADDR@"\n);\n1;\n')),(0,a.kt)("h2",{id:"suppression-des-crons"},"Suppression des crons"),(0,a.kt)("p",null,"Les t\xe2ches cron planifi\xe9es sont ex\xe9cut\xe9es directement par le processus gorgone dans l'architecture hautement disponible. Cela permet d'\xe9viter qu'elles ne se fassent concurrence sur les n\u0153uds centraux. Il est donc n\xe9cessaire de les supprimer manuellement :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rm -f /etc/cron.d/centreon\nrm -f /etc/cron.d/centstorage\nrm -f /etc/cron.d/centreon-auto-disco\n")),(0,a.kt)("h2",{id:"changement-de-droits"},"Changement de droits"),(0,a.kt)("p",null,"Les r\xe9pertoires /var/log/centreon-engine et /tmp/centreon-autodisco sont partag\xe9s entre plusieurs processus. Il est n\xe9cessaire de modifier les droits de ces r\xe9pertoires et fichiers pour assurer le bon fonctionnement de la r\xe9plication des fichiers et de la d\xe9couverte automatique des services :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 775 /var/log/centreon-engine/\nmkdir /var/log/centreon-engine/archives\nchown centreon-engine: /var/log/centreon-engine/archives\nchmod 775 /var/log/centreon-engine/archives/\nchmod 664 /var/log/centreon-engine/*\nchmod 664 /var/log/centreon-engine/archives/*\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /tmp/centreon-autodisco/\nchown apache: /tmp/centreon-autodisco/\nchmod 775 /tmp/centreon-autodisco/\n")),(0,a.kt)("h3",{id:"arr\xeater-et-d\xe9sactiver-les-services"},"Arr\xeater et d\xe9sactiver les services"),(0,a.kt)("p",null,"Les services de l'application Centreon ne seront plus lanc\xe9s au d\xe9marrage du serveur comme c'est le cas pour une installation standard, les services de clustering s'en chargeront. Il est donc n\xe9cessaire d'arr\xeater et de d\xe9sactiver ces services."),(0,a.kt)("p",null,"Sur les serveurs centraux :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop centengine snmptrapd centreontrapd gorgoned cbd httpd php-fpm centreon\nsystemctl disable centengine snmptrapd centreontrapd gorgoned cbd httpd php-fpm centreon centreon-central-sync cbd-sql\n")))),(0,a.kt)("h3",{id:"red\xe9finir-les-r\xe8gles-de-d\xe9marrage-des-services"},"Red\xe9finir les r\xe8gles de d\xe9marrage des services"),(0,a.kt)("p",null,"Certains services ne doivent \xeatre d\xe9marr\xe9s que sur un seul noeud, mais pour d'autres, il est acceptable ou m\xeame souhaitable de les d\xe9marrer sur les deux noeuds. Nous allons commencer par ces services."),(0,a.kt)("h4",{id:"service-php"},"Service PHP"),(0,a.kt)("p",null,"Le service ",(0,a.kt)("inlineCode",{parentName:"p"},"php-fpm.service")," n'a pas besoin d'\xeatre modifi\xe9, mais doit \xeatre activ\xe9 pour qu'il soit d\xe9marr\xe9 automatiquement lors du d\xe9marrage des serveurs centraux."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable php-fpm\n")),(0,a.kt)("h4",{id:"service-broker-rrd"},"Service Broker RRD"),(0,a.kt)("p",null,'Le processus "broker-rrd" est lanc\xe9 via le service ',(0,a.kt)("inlineCode",{parentName:"p"},"cbd.service"),". Ce dernier est par d\xe9faut pilot\xe9 par ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.service")," mais dans cette configuration, il doit \xeatre d\xe9tach\xe9 en modifiant sa d\xe9finition sur les deux noeuds centraux :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/cbd.service <<"EOF"\n[Unit]\nDescription=Centreon Broker watchdog\nAfter=syslog.target network.target\n\n[Service]\nExecStart=/usr/sbin/cbwd /etc/centreon-broker/watchdog.json\nExecReload=/bin/kill -HUP $MAINPID\nType=simple\nUser=centreon-broker\nUMask=0002\n\n[Install]\nWantedBy=multi-user.target\nEOF\n')),(0,a.kt)("p",null,"Ensuite, d\xe9marrez-le et activez-le :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl start cbd\nsystemctl enable cbd\n")),(0,a.kt)("h4",{id:"cr\xe9ation-de-la-vip-centreon"},"Cr\xe9ation de la VIP Centreon"),(0,a.kt)("p",null,"La VIP sera ajout\xe9e \xe0 la configuration de l'interface ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_VIP_IFNAME@")," sur ",(0,a.kt)("strong",{parentName:"p"},"le n\u0153ud ma\xeetre central")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod "@CENTRAL_VIP_IFNAME@" +ipv4.addresses "@CENTRAL_VIP_IPADDR@/@CENTRAL_VIP_CIDR_NETMASK@"\nnmcli connection up "@CENTRAL_VIP_IFNAME@"\n')),(0,a.kt)("h4",{id:"service-httpd"},"Service Httpd"),(0,a.kt)("p",null,"Le service ",(0,a.kt)("inlineCode",{parentName:"p"},"httpd.service")," est par d\xe9faut ind\xe9pendant de ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.service")," mais dans cette configuration, il faut l'y rattacher en modifiant sa d\xe9finition sur les deux noeuds centraux :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/httpd.service <<"EOF"\n[Unit]\nDescription=The Apache HTTP Server\nPartOf=centreon.service\nReloadPropagatedFrom=centreon.service\nAfter=centreon.service\n\n[Service]\nType=notify\nEnvironment=LANG=C\n\nExecStart=/usr/sbin/httpd $OPTIONS -DFOREGROUND\nExecReload=/usr/sbin/httpd $OPTIONS -k graceful\nExecStop=/usr/sbin/httpd $OPTIONS -k graceful-stop\n# Send SIGWINCH for graceful stop\nKillSignal=SIGCONT\nKillMode=mixed\nPrivateTmp=true\n\n[Install]\nWantedBy=centreon.service\nEOF\n')))),(0,a.kt)("h4",{id:"service-gorgone"},"Service Gorgone"),(0,a.kt)("p",null,"Le service ",(0,a.kt)("inlineCode",{parentName:"p"},"gorgoned.service")," est par d\xe9faut ind\xe9pendant de ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.service")," mais dans cette configuration, il doit lui \xeatre rattach\xe9 en modifiant sa d\xe9finition sur les deux noeuds centraux :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /etc/systemd/system/gorgoned.service <<"EOF"\n[Unit]\nDescription=Centreon Gorgone\nPartOf=centreon.service\nAfter=httpd.service\nReloadPropagatedFrom=centreon.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/gorgoned\nExecStart=/usr/bin/perl /usr/bin/gorgoned $OPTIONS\nType=simple\nUser=centreon-gorgone\n\n[Install]\nWantedBy=centreon.service\nEOF\n')))),(0,a.kt)("h4",{id:"service-centreon-central-sync"},"Service Centreon-central-sync"),(0,a.kt)("p",null,"Ce service est sp\xe9cifique \xe0 ",(0,a.kt)("em",{parentName:"p"},"Centreon HA"),". Sa fonction est de r\xe9pliquer les changements de configuration, d'ajouter des images via l'interface, etc."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/centreon-central-sync.service <<"EOF"\n[Unit]\nDescription=Centreon Central Sync (failover only)\nPartOf=centreon.service\nReloadPropagatedFrom=centreon.service\nAfter=gorgoned.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/centreon_central_sync\nExecStart=/usr/share/centreon-ha/bin/centreon_central_sync $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nType=simple\nUser=centreon\n\n[Install]\nWantedBy=centreon.service\nEOF\n')),(0,a.kt)("h4",{id:"service-broker-sql"},"Service Broker SQL"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/cbd-sql.service <<"EOF"\n[Unit]\nDescription=Centreon SQL Broker service\nPartOf=centreon.service\nReloadPropagatedFrom=centreon.service\nAfter=centreon-central-sync.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/cbd_sql\nExecStart=/usr/sbin/cbd $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nType=simple\nUser=centreon-broker\nUMask=0002\n\n[Install]\nWantedBy=centreon.service\nEOF\n')),(0,a.kt)("h4",{id:"service-centengine"},"Service Centengine"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/centengine.service <<"EOF"\n[Unit]\nDescription=Centreon Engine\nPartOf=centreon.service\nReloadPropagatedFrom=centreon.service\nAfter=cbd-sql.service\n\n[Service]\nExecStart=/usr/sbin/centengine /etc/centreon-engine/centengine.cfg\nExecReload=/bin/kill -HUP $MAINPID\nType=simple\nUser=centreon-engine\n\n[Install]\nWantedBy=centreon.service\nEOF\n')),(0,a.kt)("h4",{id:"service-centreontrapd"},"Service Centreontrapd"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/centreontrapd.service <<"EOF"\n[Unit]\nDescription=Centreon Trapd Daemon is a Centreon program that manage traps\nPartOf=centreon.service\nAfter=centreon.service\nReloadPropagatedFrom=centreon.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/centreontrapd\nExecStart=/usr/share/centreon/bin/centreontrapd $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nType=simple\nUser=centreon\n\n[Install]\nWantedBy=centreon.service\nEOF\n')),(0,a.kt)("h4",{id:"service-snmptrapd"},"Service Snmptrapd"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /usr/lib/systemd/system/snmptrapd.service <<"EOF"\n[Unit]\nDescription=Simple Network Management Protocol (SNMP) Trap Daemon.\nPartOf=centreon.service\nAfter=centreontrapd.service\n\n[Service]\nType=notify\nEnvironment=OPTIONS="-Lsd"\nEnvironmentFile=-/etc/sysconfig/snmptrapd\nExecStart=/usr/sbin/snmptrapd $OPTIONS -f\nExecReload=/bin/kill -HUP $MAINPID\n\n[Install]\nWantedBy=centreon.service\nEOF\n')),(0,a.kt)("h3",{id:"lancement-initial-de-tous-les-services"},"Lancement initial de tous les services"),(0,a.kt)("h4",{id:"installation-de-ladresse-ip-virtuelle-centreon"},"Installation de l'adresse IP virtuelle Centreon"),(0,a.kt)("p",null,"Normalement, la VIP a d\xe9j\xe0 \xe9t\xe9 mont\xe9e auparavant. V\xe9rifiez que c'est le cas sur le serveur primaire d\xe9fini ci-dessus (normalement ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@"),")"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ip a\n")),(0,a.kt)("p",null,"Vous devriez voir l'IP virtuelle ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_VIP_IPADDR@")," attach\xe9e \xe0 l'interface ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_VIP_IFNAME@")," appara\xeetre dans le retour de la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"ip a"),"."),(0,a.kt)("p",null,"Si ce n'est pas le cas, l'adresse IP virtuelle doit \xeatre mont\xe9e, par exemple sur ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'nmcli con mod "@CENTRAL_VIP_IFNAME@" +ipv4.addresses "@CENTRAL_VIP_IPADDR@/@CENTRAL_VIP_CIDR_NETMASK@"\nnmcli con up "@CENTRAL_VIP_IFNAME@"\n')),(0,a.kt)("h4",{id:"prise-en-compte-des-modifications-apport\xe9es-aux-services"},"Prise en compte des modifications apport\xe9es aux services"),(0,a.kt)("p",null,"Afin de prendre en compte toutes les modifications pr\xe9c\xe9dentes, et d'activer les services (pour que le d\xe9marrage du service ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.service")," les lance tous) il est n\xe9cessaire de lancer ces commandes sur les deux noeuds centraux :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl daemon-reload\nsystemctl enable cbd httpd gorgoned centreon-central-sync cbd-sql centengine centreontrapd snmptrapd\n")))),(0,a.kt)("p",null,"Et enfin les d\xe9marrer tous via le ",(0,a.kt)("inlineCode",{parentName:"p"},"centreon.service")," sur le noeud o\xf9 la VIP a \xe9t\xe9 mont\xe9e :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl start centreon\n")),(0,a.kt)("p",null,"V\xe9rifiez ensuite l'\xe9tat de tous les services :"),(0,a.kt)(r.Z,{groupId:"sync",mdxType:"Tabs"},(0,a.kt)(s.Z,{value:"Alma / RHEL / Oracle Linux 8",label:"Alma / RHEL / Oracle Linux 8",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl status cbd httpd gorgoned centreon-central-sync cbd-sql centengine centreontrapd snmptrapd\n")))),(0,a.kt)("p",null,"Apr\xe8s cette \xe9tape, toutes les ressources doivent \xeatre actives au m\xeame endroit, et la plateforme doit \xeatre fonctionnelle et redondante. Si ce n'est pas le cas, consultez le guide de d\xe9pannage dans le paragraphe suivant."),(0,a.kt)("h3",{id:"op\xe9ration-ha-manuelle-standard"},"Op\xe9ration HA manuelle standard"),(0,a.kt)("h3",{id:"basculer-les-services-centreon-dun-n\u0153ud-\xe0-lautre"},"Basculer les services Centreon d'un n\u0153ud \xe0 l'autre"),(0,a.kt)("p",null,"Ce script peut \xeatre ex\xe9cut\xe9 depuis n'importe quel n\u0153ud Centreon, mais vous devez (pour l'instant) sp\xe9cifier le n\u0153ud cible. Par exemple pour changer le noeud actif de ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_MASTER_NAME@")," \xe0 ",(0,a.kt)("inlineCode",{parentName:"p"},"@CENTRAL_SLAVE_NAME@")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/set-centreon-master.sh @CENTRAL_SLAVE_NAME@\n")),(0,a.kt)("p",null,"Le r\xe9sultat attendu est le suivant :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Stopping centreon.service on @CENTRAL_MASTER_NAME@...\nUnmounting VIP on @CENTRAL_MASTER_NAME@...\nAdding vip to @CENTRAL_SLAVE_NAME@...\nStarting centreon.service on @CENTRAL_SLAVE_NAME@...\n")),(0,a.kt)("p",null,"Si nous essayons de passer au n\u0153ud qui est d\xe9j\xe0 actif, nous obtiendrons :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Host @CENTRAL_MASTER_NAME@ is already the current master :-)\n")),(0,a.kt)("h3",{id:"inverser-les-r\xf4les-slavemaster-de-mysql"},"Inverser les r\xf4les SLAVE/MASTER de MySQL"),(0,a.kt)("p",null,"Ce script peut \xeatre lanc\xe9 depuis n'importe quel n\u0153ud de base de donn\xe9es, cette fois nous ne sp\xe9cifions pas le nom du serveur cible :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-switch-slave-master.sh\n")),(0,a.kt)("p",null,"Le r\xe9sultat attendu est le suivant :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"Locking master database on @DB_SLAVE_NAME@\nWaiting Relay log bin to finish proceed (TIMEOUT = 60sec)\nRemoving slave thread on @DB_MASTER_NAME@\nRecording binlog file and position from @DB_MASTER_NAME@\nUnlocking databases on @DB_MASTER_NAME@\nSetting and starting slave thread on @DB_SLAVE_NAME@\nWe have to move the VIP address\n")),(0,a.kt)("h3",{id:"v\xe9rification-de-la-synchronisation-des-bases-de-donn\xe9es"},"V\xe9rification de la synchronisation des bases de donn\xe9es"),(0,a.kt)("p",null,"L'\xe9tat de la r\xe9plication MySQL peut \xeatre v\xe9rifi\xe9 \xe0 tout moment avec la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql-check-status.sh")," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/centreon-ha/bin/mysql-check-status.sh\n")),(0,a.kt)("p",null,"Le r\xe9sultat attendu est le suivant :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Connection Status '@DB_MASTER_NAME@' [OK]\nConnection Status '@DB_SLAVE_NAME@' [OK]\nSlave Thread Status [OK]\nPosition Status [OK]\n")),(0,a.kt)("h2",{id:"int\xe9grer-des-collecteurs"},"Int\xe9grer des collecteurs"),(0,a.kt)("p",null,"Il ne reste maintenant plus qu'\xe0 ",(0,a.kt)("a",{parentName:"p",href:"/centreon-documentation/pr-preview/staging/pr-2756/fr/docs/installation/installation-of-centreon-ha-manual/integrating-pollers"},"int\xe9grer les collecteurs")," et commencer \xe0 superviser !"))}v.isMDXComponent=!0}}]);