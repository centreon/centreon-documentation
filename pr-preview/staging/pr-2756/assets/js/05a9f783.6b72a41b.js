"use strict";(self.webpackChunkcentreon_docs=self.webpackChunkcentreon_docs||[]).push([[36777],{17449:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>g,frontMatter:()=>l,metadata:()=>c,toc:()=>u});n(67294);var r=n(3905);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}const l={id:"backup",title:"Backup"},s=void 0,c={unversionedId:"administration/backup",id:"version-23.10/administration/backup",title:"Backup",description:"How it works",source:"@site/versioned_docs/version-23.10/administration/backup.md",sourceDirName:"administration",slug:"/administration/backup",permalink:"/centreon-documentation/pr-preview/staging/pr-2756/docs/administration/backup",draft:!1,editUrl:"https://github.com/centreon/centreon-documentation/edit/staging/versioned_docs/version-23.10/administration/backup.md",tags:[],version:"23.10",lastUpdatedAt:1699897436,formattedLastUpdatedAt:"Nov 13, 2023",frontMatter:{id:"backup",title:"Backup"},sidebar:"version-23.10/docs",previous:{title:"Database partitioning",permalink:"/centreon-documentation/pr-preview/staging/pr-2756/docs/administration/database-partitioning"},next:{title:"Knowledge Base",permalink:"/centreon-documentation/pr-preview/staging/pr-2756/docs/administration/knowledge-base"}},p={},u=[{value:"How it works",id:"how-it-works",level:2},{value:"Daily execution",id:"daily-execution",level:3},{value:"Backup types",id:"backup-types",level:3},{value:"Database backup",id:"database-backup",level:4},{value:"Configuration files backup",id:"configuration-files-backup",level:4},{value:"Configuration",id:"configuration",level:2},{value:"Restoring the Centreon central server",id:"restoring-the-centreon-central-server",level:2},{value:"Configurations file restore",id:"configurations-file-restore",level:3},{value:"Databases restore",id:"databases-restore",level:3},{value:"SSH keys restore",id:"ssh-keys-restore",level:3},{value:"Plugins restore",id:"plugins-restore",level:3},{value:"Init script restore",id:"init-script-restore",level:3},{value:"Monitoring agent restore",id:"monitoring-agent-restore",level:3},{value:"Generate Centreon-Engine configuration files within centreon",id:"generate-centreon-engine-configuration-files-within-centreon",level:3},{value:"Graphs rebuild",id:"graphs-rebuild",level:3}],d={toc:u},k="wrapper";function g(e){var{components:t}=e,l=i(e,["components"]);return(0,r.kt)(k,o(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){a(e,t,n[t])}))}return e}({},d,l),{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"how-it-works"},"How it works"),(0,r.kt)("h3",{id:"daily-execution"},"Daily execution"),(0,r.kt)("p",null,"The backup script is executed on a daily basis with a cron job located in\n",(0,r.kt)("strong",{parentName:"p"},"/etc/cron.d/centreon"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"##########################\n# Cron for Centreon-Backup\n30 3 * * * root /usr/share/centreon/cron/centreon-backup.pl >> /var/log/centreon/centreon-backup.log 2&>1\n")),(0,r.kt)("p",null,"Each day at 3:30 AM, the backup script checks if a backup is planned on the current day."),(0,r.kt)("h3",{id:"backup-types"},"Backup types"),(0,r.kt)("p",null,"There are two types of backup: database and configuration files."),(0,r.kt)("h4",{id:"database-backup"},"Database backup"),(0,r.kt)("p",null,"Database backup will be processed on two databases: ",(0,r.kt)("strong",{parentName:"p"},"centreon")," and\n",(0,r.kt)("strong",{parentName:"p"},"centreon","_","storage")),(0,r.kt)("p",null,"There are two kinds of database backup:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"MySQLdump: the mysqldump command is used to back up databases. Warning:\nmysqldump can take a long time on large databases."),(0,r.kt)("li",{parentName:"ul"},"LVM Snapshot: A binary copy of MariaDB files is done. You need to have a\nspecific LV for MariaDB (i.e. /var/lib/mysql) and 1 GB of space in its VG.")),(0,r.kt)("p",null,"Backup filename format:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"YYYY-MM-DD-centreon.sql.gz"),(0,r.kt)("li",{parentName:"ul"},"YYYY-MM-DD-centreon","_","storage.sql.gz")),(0,r.kt)("h4",{id:"configuration-files-backup"},"Configuration files backup"),(0,r.kt)("p",null,"All the configuration files for the central server can be saved: MariaDB, Apache, PHP,\nSNMP, centreon, centreon-broker)"),(0,r.kt)("p",null,"Backup filename format:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"YYYY-MM-DD-centreon-engine.tar.gz (centreon-engine configuration files)"),(0,r.kt)("li",{parentName:"ul"},"YYYY-MM-DD-central.tar.gz (other configuration files)")),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"This part covers the configuration of the backup."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Go to ",(0,r.kt)("strong",{parentName:"li"},"Administration > Parameters > Backup"),".")),(0,r.kt)("p",null,"The following window is displayed:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(19307).Z,width:"1361",height:"709"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Backup enabled")," Enable/Disable backup"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Backup directory")," Directory where backup will be stored"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Temporary directory")," Directory used during backup process"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Backup database centreon")," Enable backup on centreon database"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Backup database centreon","_","storage")," Enable backup on centreon","_","storage\ndatabase"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Backup type")," Type of backup (MySQLdump or LVM snapshot)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Full backup")," Period for full backup"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Partial backup")," Period for partial backup (only available with LVM\nsnapshot backup)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Backup retention")," Retention for backups (in days)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Backup configuration files")," Enable backup of configuration files"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"MySQL configuration file path")," Path for MariaDB configuration file"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"SCP export enabled")," Enable SCP export of backups"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Remote user")," Remote user for SCP export"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Remote host")," Remote host for SCP export"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Remote directory")," Remote directory for SCP export")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"Temporary directory")," cannot be a folder in the ",(0,r.kt)("strong",{parentName:"p"},"Backup directory"),".")),(0,r.kt)("h2",{id:"restoring-the-centreon-central-server"},"Restoring the Centreon central server"),(0,r.kt)("p",null,"The restoration process is divided into two main steps:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Re-install the Centreon platform following the installation documentation.\nRemember to upgrade the system."),(0,r.kt)("li",{parentName:"ul"},"Restore Centreon-Engine configuration files and Centreon databases")),(0,r.kt)("h3",{id:"configurations-file-restore"},"Configurations file restore"),(0,r.kt)("p",null,"Before restoring the databases, you must first restore the configuration files:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/cache/centreon/backup/\ntar -xvf YYYY-MM-DD-central.tar.gz\ncd central/etc/centreon/\ncp -r * /etc/centreon/\n")),(0,r.kt)("h3",{id:"databases-restore"},"Databases restore"),(0,r.kt)("p",null,"Once the Centreon server is reinstalled (",(0,r.kt)("strong",{parentName:"p"},"same Centreon version"),"), unzip the ",(0,r.kt)("strong",{parentName:"p"},"centreon")," and the\n",(0,r.kt)("strong",{parentName:"p"},"centreon","_","storage")," databases backup."),(0,r.kt)("p",null,"Start by recreating the databases with the following commands:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"DROP DATABASE centreon;\nDROP DATABASE centreon_storage;\nCREATE DATABASE centreon;\nCREATE DATABASE centreon_storage;\n")),(0,r.kt)("p",null,"Then unzip and load the database dumps into newly created databases:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/cache/centreon/backup/\ngzip -d YYYY-MM-DD-centreon.sql.gz\nmysql centreon < YYYY-MM-DD-centreon.sql\ngzip -d YYYY-MM-DD-centreon_storage.sql.gz\nmysql centreon_storage < YYYY-MM-DD-centreon_storage.sql\n")),(0,r.kt)("p",null,'This may take a while due to the size of "centreon',"_",'storage" databases.'),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"The password is stored in the previously restored configuration files. For example\n",(0,r.kt)("strong",{parentName:"p"},"$mysql","_","passwd"),' field in the file "/etc/centreon/conf.pm".')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},'The default configuration does not define any password for the mysql root user.\nThat\'s why we can connect to the database using just the "mysql" command.')),(0,r.kt)("h3",{id:"ssh-keys-restore"},"SSH keys restore"),(0,r.kt)("p",null,"This step is to restore the SSH key linked to user ",(0,r.kt)("strong",{parentName:"p"},"centreon")," and\n",(0,r.kt)("strong",{parentName:"p"},"centreon-engine")," within a distributed environment. Restoration must be done\nmanually. We must therefore initially extract this archive into a temporary\ndirectory and move the files one by one according to their location:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/cache/centreon/backup/\ntar -xvf YYYY-MM-DD-centreon-engine.tar.gz\ncd central/ssh/\nmkdir -p /var/spool/centreon/.ssh/\nchmod 700 /var/spool/centreon/.ssh/\ncp -p id_rsa /var/spool/centreon/.ssh/\ncp -p id_rsa.pub /var/spool/centreon/.ssh/\n")),(0,r.kt)("p",null,"Connection test from central to poller:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"su - centreon\nssh <poller_ip_address>\n")),(0,r.kt)("p",null,'Answer "Yes" to the question. This is about adding the poller SSH fingerprint\non the central server.'),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"You need to perform this operation only if you work with a distributed environment.")),(0,r.kt)("h3",{id:"plugins-restore"},"Plugins restore"),(0,r.kt)("p",null,'Plugins have been backed up in the archive: "YYYY-MM-DD-centreon-engine.tar.gz."\nRestoration must be done manually. We must therefore initially extract this\narchive into a temporary directory and move the files one by one according to\ntheir location.'),(0,r.kt)("p",null,"Proceed as follows on each poller:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/cache/centreon/backup/\ntar -xvf YYYY-MM-DD-centreon-engine.tar.gz\ncd central/plugins\ncp -pRf * /usr/lib64/nagios/plugins/\n")),(0,r.kt)("h3",{id:"init-script-restore"},"Init script restore"),(0,r.kt)("p",null,"Some checkpoints of Oracle or SAP entail modifying the init script scheduler to\nadd environment variables. If you changed the init script of your scheduler, you\nwill have to restore it. Extract the archive into a temporary directory and move\nthe files according to their location:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/backup\ntar -xvf YYYY-MM-DD-centreon-engine.tar.gz\ncd backup\ncp init_d_centengine /etc/init.d/centengine\n")),(0,r.kt)("h3",{id:"monitoring-agent-restore"},"Monitoring agent restore"),(0,r.kt)("p",null,"If you are using NRPE or NSCA agents, you must reinstall and then restore the\nconfiguration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /var/backup\ntar -xvf YYYY-MM-DD-centreon-engine.tar.gz\ncd backup/etc\ncp nrpe.cfg /etc/centreon-engine/\ncp nsca.cfg /etc/centreon-engine/\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"You must do this only if you are using the monitoring agents.")),(0,r.kt)("h3",{id:"generate-centreon-engine-configuration-files-within-centreon"},"Generate Centreon-Engine configuration files within centreon"),(0,r.kt)("p",null,"The last step is to generate the Centreon-Engine configuration files from\nwithin the Centreon UI."),(0,r.kt)("h3",{id:"graphs-rebuild"},"Graphs rebuild"),(0,r.kt)("p",null,"Once your monitoring platform is restored and all is doing well, you can rebuild\nRRD files in order to restore all performance graphs."),(0,r.kt)("p",null,"To rebuild performance graphs, go to ",(0,r.kt)("inlineCode",{parentName:"p"},"Administration > Parameters >\nData"),". On this page, you must select all the services. Click the\n",(0,r.kt)("strong",{parentName:"p"},"More actions...")," drop-down menu and select the option ",(0,r.kt)("strong",{parentName:"p"},"Rebuild RRD Database"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Your server is now restored.")))}g.isMDXComponent=!0},19307:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/parameters-backup-04fde21f5d31fc415a844f19b4d66d6e.png"}}]);